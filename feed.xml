<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://andelf.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://andelf.github.io/" rel="alternate" type="text/html" /><updated>2023-12-18T05:55:13+00:00</updated><id>https://andelf.github.io/feed.xml</id><title type="html">猫·仁波切</title><subtitle>会研发的PM才是好OP.</subtitle><entry><title type="html">10.2 寸黑白红三色墨水屏价签拆解及驱动过程简记 - 10.2 inch 3-Color BWR ESL</title><link href="https://andelf.github.io/blog/2023/12/17/10-2-inch-3-color-esl/" rel="alternate" type="text/html" title="10.2 寸黑白红三色墨水屏价签拆解及驱动过程简记 - 10.2 inch 3-Color BWR ESL" /><published>2023-12-17T11:54:00+00:00</published><updated>2023-12-17T11:54:00+00:00</updated><id>https://andelf.github.io/blog/2023/12/17/10-2-inch-3-color-esl</id><content type="html" xml:base="https://andelf.github.io/blog/2023/12/17/10-2-inch-3-color-esl/"><![CDATA[<p>书接很久以前的 <a href="/blog/2021/01/14/play-with-2-13-inch-e-ink-display/">这里</a>.
最近机缘巧合又收了一个 10.2 寸的黑白红墨水屏价签. 很新, 屏幕保护膜都没撕, 又可见倒闭的公司库存.</p>

<p><img src="/assets/esl-10in2.jpeg" alt="ESL 10in2" /></p>

<p>可惜后盖上的贴纸已经撕掉了, 不知道是哪家公司的. 先拆拆看.</p>

<h2 id="拆解">拆解</h2>

<p>目前市面上大大小小价签很多种, 拆解价签的方法大同小异. 拆价签翻车的案例太多, 尤其大屏幕, 一旦翻车就是一顿外卖的损失.
所以拆解前一定要做好功课, 了解屏幕的结构, 以及拆解的方法.
卡扣一般会特别紧, 需要较薄的刀片, 但又不能太薄, 否则可能会受伤. 比如这个:</p>

<p><img src="/assets/esl-10in2-toolkit.jpeg" alt="ESL Teardown Toolkit" /></p>

<p>另外加上软质塑料片, 这玩意文具店很多, 用来拆解屏幕背面和 PCB 的双面胶.</p>

<p><img src="/assets/esl-10in2-back.jpeg" alt="ESL Back Remoted" /></p>

<p>撬开后电池盖, 注意卡扣位置. 然后取掉电池. 方便之后取出 PCB.</p>

<p>然后就是拆卡扣, 从屏幕背面的一个开口处开始, 用刀片, 慢慢撬一圈卡扣,
注意不要伤到自己和屏幕边缘.</p>

<p><img src="/assets/esl-10in2-teardown-1.jpeg" alt="ESL Back Teardown Start" /></p>

<p><img src="/assets/esl-10in2-teardown-2.jpeg" alt="ESL Back Teardown Knot Removed" /></p>

<p><img src="/assets/esl-10in2-teardown-3.jpeg" alt="ESL Back Teardown Removing Tape" /></p>

<p>卡扣分离后, 这时候可以用软质塑料片, 伸进去, 慢慢拆开 PCB 和后盖的双面胶.</p>

<p>PCB 也是用双面胶贴在屏幕背后的, 这一步是最容易翻车的, 一定要慢慢来. 塑料片伸进去横向推, 一点一点的推开 PCB 和背板的双面胶.</p>

<p><img src="/assets/esl-10in2-teardown-4.jpeg" alt="ESL Back Teardown PCB Removed 1" /></p>

<p><img src="/assets/esl-10in2-teardown-5.jpeg" alt="ESL Back Teardown PCB Removed 2" /></p>

<p>PCB 丝印: Endor Telink1020 2021-07-22 change U5, 可见这是 BLOZI(保资) 的价签. 但是在今天, 他家官网都是挂的.
难道价签厂家也倒闭了…</p>

<p>24pin 屏幕排线丝印: HINK-E102A01-A1, 搜索可以找到全网唯一参考资料<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>, 虽然是个 CSDN, 但提供了不少线索,
里面说明了驱动 IC 是 SSD1677, 微雪 3in7 也使用了相同驱动 IC, 但那是一个黑白屏幕.</p>

<p>如果没有找到对应的驱动 IC, 那可能就需要参考 <a href="https://www.youtube.com/watch?v=t_YXjM7Keqw">wenting</a> 的方法逆向了.
请自行学习.</p>

<h2 id="驱动">驱动</h2>

<p>拆解完成后就可以尝试驱动了. 一般来说, 24pin 就是 AIO(All-In-One) 串口屏了, 驱动版都是通用的.
这里随便找了一个驱动板(咸鱼), 使用 RPi Pico(RP2040 MCU) 来驱动. 开发框架使用 Rust <a href="https://embassy.dev/">embassy</a>.</p>

<p>Rust embedded-graphics 提供了非常方便的 Framebuffer API(注意, 没有屏幕旋转支持).</p>

<p>传统情况下, 我们只需要实现一个 <code class="language-plaintext highlighter-rouge">Display</code> trait, 就可以使用 embedded-graphics 的各种绘图 API 了.
但这里, 我们再抽象一级, 直接预留一个 <code class="language-plaintext highlighter-rouge">update_frame(raw: &amp;[u8])</code> 接口, 直接接收 <code class="language-plaintext highlighter-rouge">Framebuffer::data()</code> 作为参数.
这是在经历了 <a href="https://github.com/embedded-drivers/epd">epd</a> 项目之后, 尝试七八种屏幕之后发现最合适最通用的方法.</p>

<p>先写个骨架, 一切 SPI 串口 EPD 都可以这样搞, 唯一需要注意的是部分驱动 IC 的 BUSY 使用反逻辑:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">EPD10in2</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">spi</span><span class="p">:</span> <span class="n">Spi</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">SPI0</span><span class="p">,</span> <span class="n">Blocking</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">dc</span><span class="p">:</span> <span class="n">Output</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">AnyPin</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">busy</span><span class="p">:</span> <span class="n">Input</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">AnyPin</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">EPD10in2</span><span class="o">&lt;</span><span class="nv">'_</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">send_command</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">u8</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.dc</span><span class="nf">.set_low</span><span class="p">();</span>
        <span class="k">self</span><span class="py">.spi</span><span class="nf">.blocking_write</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">cmd</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">send_data</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.dc</span><span class="nf">.set_high</span><span class="p">();</span>
        <span class="k">self</span><span class="py">.spi</span><span class="nf">.blocking_write</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">send_command_data</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.send_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">busy_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">loop</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">self</span><span class="py">.busy</span><span class="nf">.is_low</span><span class="p">()</span> <span class="p">{</span>
                <span class="nd">info!</span><span class="p">(</span><span class="s">"busy out"</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">update_frame</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="p">{}</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">refresh</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="bwr-驱动---三色">BWR 驱动 - 三色</h3>

<p>微雪驱动使用了自定义黑白 LUT 和 4 阶灰度的 LUT 来驱动, 但个人经验是, 自定义 LUT 方法不适合三色 BWR 屏幕.
除非确定 LUT 来自厂家调教.
三色屏幕建议使用出厂的 OTP LUT(One-time-programming LUT). 这样可以保证屏幕的寿命, 也直接使用厂商调教过的颜色效果.
否则电子墨水屏在 LUT 表错误的情况下, 极容易永久性损坏, 例如我手头有若干永久性残影的屏幕.</p>

<p>当然, 的确是可以自己调教三色 LUT 逻辑, 相关论文有不少, 例如 Zeng, W.; Yi, Z.; Zhou, X.; Zhao, Y.; Feng, H.; Yang, J.; Liu, L.; Chi, F.; Zhang, C.; Zhou, G. Design of Driving Waveform for Shortening Red Particles Response Time in Three-Color Electrophoretic Displays. Micromachines 2021, 12, 578. <a href="https://doi.org/10.3390/mi12050578">https://doi.org/10.3390/mi12050578</a>. 请沿着引文链自行探索.</p>

<p>一般来说, 三色墨水屏在墨囊黑白粒子之外额外加入了第三种颜色的粒子, 例如红色, 黄色.
彩色粒子的带电量和粘度(粒子物理运动特性)和黑色粒子可以通过较弱电压区分.
驱动过程大概是: 清屏, 激活(让黑色和彩色粒子尽可能分层而不是黏在一起), 然后利用较弱电压, 使得彩色粒子在屏幕上浮动, 形成彩色图像.</p>

<p>通读 SSD1677 的数据手册, 对照微雪的驱动代码, 找到核心修改点. 几乎所有 EPD 驱动 IC 的手册都是极其含糊,
这个也不例外. 其中一些关键词, 可能是需要你通读过其他同类型驱动 IC 才能理解.</p>

<p><img src="/assets/ssd1677-lut-mapping.jpeg" alt="SSD1677 LUT Mapping" /></p>

<p>SSD1677 有如上两种模式, 一种是 BWR 三色, 一种是黑白两色. 按照不同方式使用 LUT.</p>

<p><img src="/assets/ssd1677-cmd-display-ctrl-2.jpeg" alt="SSD1677 Display Update Control 2" /></p>

<!-- ![SSD1677 Load WS OTP](/assets/ssd1677-cmd-load-ws-otp.jpeg) -->

<p><img src="/assets/ssd1677-cmd-write-display-option.jpeg" alt="SSD1677 Write Display Option" /></p>

<p>这两个含糊的 Command 描述文档, 隐藏了 BWR 驱动的细节.</p>

<ul>
  <li>Display Mode 1 即 BWR 三色模式, Display Mode 2 为黑白模式</li>
  <li>Display Update Control 2 命令的 0x99 和 0x91 分别可以加载不同模式的 OTP LUT
    <ul>
      <li>0xC7, 0xCF 决定了最终刷新使用的 Display Mode</li>
    </ul>
  </li>
  <li>Write Display Option 命令中设置了 WS(LUT) 不同时间片对应的 Display Mode</li>
</ul>

<p>那么这里, 我们直接加载 Display Mode 1 的 OTP LUT, 然后使用 Display Update Control 2(with Display Mode 1) 命令刷新.</p>

<p>由此修改 <code class="language-plaintext highlighter-rouge">init()</code> 函数:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x12</span><span class="p">);</span> <span class="c1">// Soft reset</span>
        <span class="n">Delay</span><span class="nf">.delay_ms</span><span class="p">(</span><span class="mi">20_u32</span><span class="p">);</span>

        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x46</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0xF7</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.busy_wait</span><span class="p">();</span>

        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x47</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0xF7</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.busy_wait</span><span class="p">();</span>

        <span class="c1">// Driver output control</span>
        <span class="c1">// 0x27F = 639</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x01</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x7F</span><span class="p">,</span> <span class="mi">0x02</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">]);</span>

        <span class="c1">// set gate voltage</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x03</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">]);</span>
        <span class="c1">// set source voltage</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x04</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x41</span><span class="p">,</span> <span class="mi">0xA8</span><span class="p">,</span> <span class="mi">0x32</span><span class="p">]);</span> <span class="c1">// POR</span>

        <span class="c1">// set data entry sequence</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x11</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x03</span><span class="p">]);</span>

        <span class="c1">// set border</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x3C</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x03</span><span class="p">]);</span>

        <span class="c1">// set booster strength</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x0C</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0xAE</span><span class="p">,</span> <span class="mi">0xC7</span><span class="p">,</span> <span class="mi">0xC3</span><span class="p">,</span> <span class="mi">0xC0</span><span class="p">,</span> <span class="mi">0xC0</span><span class="p">]);</span>

        <span class="c1">// set internal sensor on</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x18</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x80</span><span class="p">]);</span>

        <span class="c1">// set vcom value</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x2C</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x44</span><span class="p">]);</span>

        <span class="c1">// setting X direction start/end position of RAM</span>
        <span class="c1">// 640 -&gt; 639 =&gt; 0x27F</span>
        <span class="c1">// 960 -&gt; 959 =&gt; 0x3BF</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x44</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0xBF</span><span class="p">,</span> <span class="mi">0x03</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x45</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x7F</span><span class="p">,</span> <span class="mi">0x02</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x4E</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x4F</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">]);</span>

        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x37</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">;</span> <span class="mi">10</span><span class="p">]);</span> <span class="c1">// Use Mode 1 !!!</span>

        <span class="c1">// Load Waveform !!!</span>
        <span class="c1">// 0x91, Load LUT with Mode 1</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x22</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x91</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x20</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.busy_wait</span><span class="p">();</span>

        <span class="c1">// Display Update Control 2</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x22</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0xCF</span><span class="p">]);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>除了屏幕大小设定的修改, 最核心的用 <code class="language-plaintext highlighter-rouge">!!!</code> 标注.</p>

<p>补齐写 RAM 函数和屏幕刷新函数:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">update_bw_frame</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// self.send_command_data(0x4E, &amp;[0x00, 0x00]);</span>
        <span class="c1">// self.send_command_data(0x4F, &amp;[0x00, 0x00]);</span>

        <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x24</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.send_data</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">update_red_frame</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// self.send_command_data(0x4E, &amp;[0x00, 0x00]);</span>
        <span class="c1">// self.send_command_data(0x4F, &amp;[0x00, 0x00]);</span>

        <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x26</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.send_data</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">refresh</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">Delay</span><span class="p">;</span>
        <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x20</span><span class="p">);</span> <span class="c1">// Master activation</span>
        <span class="n">delay</span><span class="nf">.delay_ms</span><span class="p">(</span><span class="mi">100_u32</span><span class="p">);</span> <span class="c1">//must</span>
        <span class="k">self</span><span class="nf">.busy_wait</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>在屏幕大小正确设定的前提下, 0x4E/0x4F(RAM 当前 X/Y) 可以只写一次, 之后就不需要了, 自动增长.</p>

<p>为了测试效果, 我们找一张 LLM 生成的图. 由于屏幕是 960x640, 而一般 LLM 生成的图是正方形, 需要进行缩放.
这里可以使用 Context Aware Image Resizing(CAIR) 算法, 或者传统直接缩放.</p>

<p>考虑到我们的屏幕只有三种颜色, 无法体现图片的丰富彩色和灰度细节, 需要使用抖动 (Diffusion Dithering) 来模拟灰度.
然后提取 BW frame 和 Red frame, 分别写 RAM. 相关任务可以通过 ImageMagick 完成:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>convert ~/Downloads/_34f9c9ae-d1c2-47a9-ab55-089ffc7cb626.jpeg <span class="nt">-size</span> 960x640 <span class="nt">-dither</span> FloydSteinberg <span class="nt">-remap</span> 3color.gif out.gif
</code></pre></div></div>

<p>这里 <code class="language-plaintext highlighter-rouge">3color.gif</code> 是只包含红黑白三色的索引色图, 用来提供调色板. <code class="language-plaintext highlighter-rouge">out.gif</code> 是经过抖动处理的图片.</p>

<p>之前突然想到, Rust 的过程宏不就是在编译期执行的吗? 于是就写了个过程宏, 用来自动加载图片, 提取 BW/Red frame.
项目在 <a href="https://github.com/andelf/text-image">text-image</a>.</p>

<p>全部刷新大概需要 20 秒左右, 最终效果如下:</p>

<p><img src="/assets/esl-10in2-bwr.jpeg" alt="BWR Image with Dithering" /></p>

<h3 id="bw-驱动---黑白双色">BW 驱动 - 黑白双色</h3>

<p>通过前面的描述, 其实大家都会发现, 首先 SSD1677 本身就支持三色和双色驱动两种模式,
且三色屏幕的彩色粒子和黑色粒子如果一同处理, 那完全是可以把三色屏幕当做双色屏幕来驱动的.</p>

<p>方法1: 依然使用三色模式, 只不过 RED RAM 永远置空. 这是最简单的, 不需要修改任何代码, 但需要忍受长大 20 秒的刷新时间.</p>

<p>方法2: 启用驱动 IC 的双色模式?</p>

<p>这里主要介绍双色模式, 它的好处是, 刷新速度可以调教到更快, 并且有可能支持灰度显示, 以及快速局部刷新.
黑白双色模式最主要的是驱动像素到新的状态, 需要拿到前一状态和目标状态, 然后执行对应的波形. 这需要驱动 IC 有对应的支持.</p>

<p>这里是驱动 IC 手册中含糊没有介绍清楚的部分:</p>

<p><img src="/assets/ssd1677-lut.jpeg" alt="SSD1677 LUT" /></p>

<p>可见 LUT 表和 <a href="/blog/2021/01/14/play-with-2-13-inch-e-ink-display/">上一篇文章</a> 中的类似, 但似乎缺乏核心的 “AB” 概念? 其实不然.
我们大致按照 Display Mode 1 整理得到格式是:</p>

<ul>
  <li>VS - L0(LUT0) - for BLACK</li>
  <li>VS - L1(LUT1) - for WHITE</li>
  <li>VS - L2(LUT2) - for RED (R=1, B/W=0)</li>
  <li>VS - L3(LUT3) - for RED (R=1, B/W=1), LUT3=LUT2</li>
  <li>VS - L4(LUT4) - reserved</li>
  <li>TP / RP - time period / repeat</li>
  <li>FR - Frame Rate</li>
</ul>

<p>而按照 Display Mode 2, 经过测试, 发现 LUT 是:</p>

<ul>
  <li>VS - L0(LUT0) - Black to Black</li>
  <li>VS - L1(LUT1) - Black to White</li>
  <li>VS - L2(LUT2) - White to Black</li>
  <li>VS - L3(LUT3) - White to White</li>
  <li>(其他部分一致)</li>
</ul>

<p>可见, 这里其实是有新旧 AB 转换的概念的, 实测发现在 Display Mode 2 下,
0x24 B/W RAM 表示当前(目标/NEW)显示状态, 0x26 Red RAM 则是上一(OLD)状态.
那么看起来就可以实现快速刷新了. 只需要我们在写入新内容到 NEW RAM 同时, 把旧内容写入 OLD RAM.
驱动 IC 将自动使用 OLD/NEW 信息执行对应的波形, 完成像素位的状态转换.</p>

<p>那么是不是有种方法可以让驱动 IC 自动完成这个过程呢? 答案是肯定的. 这个功能在不同驱动 IC 的叫法不同,
比如在 UCxxxx 系列手册中, 叫做 N2OCP (New to Old Copy), 在 SSD1677 中, 叫做 “RAM ping-pong”.</p>

<p>翻看上面 0x37 Write Display Option 命令的 <code class="language-plaintext highlighter-rouge">F[6]</code> 位, 可以看到 “RAM Ping-Pong for Display Mode 2” 的描述.
且同时告知, 只有 Display Mode 2(黑白双色) 支持这个功能.</p>

<p>简单对 <code class="language-plaintext highlighter-rouge">init()</code> 函数做修改, 这里只贴出修改的部分:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ....</span>

        <span class="c1">// Display Option</span>
        <span class="nd">#[rustfmt::skip]</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x37</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span>
            <span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0xFF</span><span class="p">,</span> <span class="c1">//B</span>
            <span class="mi">0xFF</span><span class="p">,</span> <span class="c1">//C</span>
            <span class="mi">0xFF</span><span class="p">,</span> <span class="c1">//D</span>
            <span class="mi">0xFF</span><span class="p">,</span> <span class="c1">//E</span>
            <span class="c1">// 0x0F, RAM ping-pong disable</span>
            <span class="c1">// 0x4F, RAM ping-pong enable</span>
            <span class="mi">0x4F</span><span class="p">,</span> <span class="c1">//F, RAM ping-pong enable. only in Display Mode 2</span>
            <span class="mi">0xFF</span><span class="p">,</span> <span class="c1">//G</span>
            <span class="mi">0xFF</span><span class="p">,</span> <span class="c1">//H</span>
            <span class="mi">0xFF</span><span class="p">,</span> <span class="c1">//I</span>
            <span class="mi">0xFF</span><span class="p">,</span> <span class="c1">//J</span>
        <span class="p">]);</span> <span class="c1">// MODE 2</span>

        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x22</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x99</span><span class="p">]);</span> <span class="c1">// Load LUT with Mode 2</span>
        <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x20</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.busy_wait</span><span class="p">();</span>

        <span class="c1">// Display Update Control 2</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x22</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0xCF</span><span class="p">]);</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>废话不多说, 我们编写一张快速刷新的波形, 前置条件是需要屏幕是纯白的, 也就是刚刚清屏后的状态. 这可以通过 OTP LUT 实现.
这里只关注我们需要的黑色和白色状态.</p>

<ul>
  <li>对于 Black to Black 和  White to White, 什么都不做</li>
  <li>Black to White, 加 VSL 电压, 若干周期</li>
  <li>White to Black, 加 VSH 电压, 若干周期</li>
</ul>

<p>经过测试, 我们得到了如下 LUT, 简洁到惊人. <code class="language-plaintext highlighter-rouge">0x0F</code> 是个人测试的值, 即 15 个周期. RP=0 表示只重复一次.
相关内容和上一篇文章介绍的大同小异.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">configure_partial_update</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="nd">#[rustfmt::skip]</span>
        <span class="k">const</span> <span class="n">LUT</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">[</span>
            <span class="mi">0b00_00_00_00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//LUT0, B2B</span>
            <span class="mi">0b10_00_00_00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//LUT1, B2W</span>
            <span class="mi">0b01_00_00_00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//LUT2, W2B</span>
            <span class="mi">0b00_00_00_00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//LUT3, W2W</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//LUT5, reserved</span>
            <span class="c1">// TP[xA, xB, xC, xD], RP</span>
            <span class="mi">0x0F</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//7</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//9</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="c1">// FR</span>
            <span class="mi">0x22</span><span class="p">,</span><span class="mi">0x22</span><span class="p">,</span><span class="mi">0x22</span><span class="p">,</span><span class="mi">0x22</span><span class="p">,</span><span class="mi">0x22</span>
        <span class="p">];</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x32</span><span class="p">,</span> <span class="n">LUT</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>而此时只需要写入 0x24 B/W RAM, 就可实现快速刷新, 实测大概 1s 左右即可完成刷屏. 且无闪动.</p>

<h3 id="bw-驱动---灰度大法">BW 驱动 - 灰度大法</h3>

<p>看着 0x0F 这个时间周期值, 是不是手痒. 没错, 我们可以尝试调整这个值, 从而实现灰度显示.
灰度显示对于阅读器类应用意义重大, 适量字体的抗锯齿渲染, 以及图片的灰度显示, 都可以大大提升用户体验.</p>

<p>这里假设我们需要实现 16 级别灰度, 正好对应 0x0F.</p>

<ul>
  <li>可以刷屏 16 次, 每次刷入 1/16 的灰度层次, 朴素但是可行</li>
  <li>!! 刷屏 4 次, 分别是 8, 4, 2, 1 个周期, 从而实现 16 级灰度, 相当于只用了 4 倍刷新时间</li>
</ul>

<p>废话不多说, 直接上代码:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cd">/// Level 0 to 15</span>
    <span class="k">fn</span> <span class="nf">configure_gray_update_level</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">u8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nd">#[rustfmt::skip]</span>
        <span class="k">let</span> <span class="n">lut</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">[</span>
            <span class="mi">0b01_00_00_00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//LUT0, B2B</span>
            <span class="mi">0b00_00_00_00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//LUT1, B2W</span>
            <span class="mi">0b01_00_00_00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//LUT2, W2B</span>
            <span class="mi">0b00_00_00_00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//LUT3, W2W</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//5</span>
            <span class="c1">// TP[xA, xB, xC, xD], RP</span>
            <span class="n">level</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//7</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="c1">//9</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span><span class="mi">0x00</span><span class="p">,</span>
            <span class="c1">// FR</span>
            <span class="mi">0x22</span><span class="p">,</span><span class="mi">0x22</span><span class="p">,</span><span class="mi">0x22</span><span class="p">,</span><span class="mi">0x22</span><span class="p">,</span><span class="mi">0x22</span>
        <span class="p">];</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x32</span><span class="p">,</span> <span class="n">lut</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">refresh_gray4_image</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">level</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// level: (8, 4, 2, 1)</span>
            <span class="k">self</span><span class="nf">.configure_gray_update_level</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">level</span><span class="p">);</span>
            <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x24</span><span class="p">);</span>

            <span class="k">for</span> <span class="n">chunk</span> <span class="k">in</span> <span class="n">buf</span><span class="nf">.chunks</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">let</span> <span class="k">mut</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">for</span> <span class="n">b</span> <span class="k">in</span> <span class="n">chunk</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">|</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">|</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="c1">// 0xFF is white, 0x00 is black</span>
                <span class="k">self</span><span class="nf">.send_data</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
            <span class="p">}</span>

            <span class="k">self</span><span class="nf">.refresh</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">refresh_gray2_image</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">level</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">{</span>
            <span class="c1">// level: 9, 5</span>
            <span class="k">self</span><span class="nf">.configure_gray_update_level</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x24</span><span class="p">);</span>

            <span class="k">for</span> <span class="n">chunk</span> <span class="k">in</span> <span class="n">buf</span><span class="nf">.chunks</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">let</span> <span class="k">mut</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">for</span> <span class="n">b</span> <span class="k">in</span> <span class="n">chunk</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0b01_00_00_00</span> <span class="o">&lt;&lt;</span> <span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">|</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0b00_01_00_00</span> <span class="o">&lt;&lt;</span> <span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">|</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0b00_00_01_00</span> <span class="o">&lt;&lt;</span> <span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">|</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0b00_00_00_01</span> <span class="o">&lt;&lt;</span> <span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">|</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="c1">// 0xFF is white, 0x00 is black</span>
                <span class="k">self</span><span class="nf">.send_data</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
            <span class="p">}</span>

            <span class="k">self</span><span class="nf">.refresh</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>以上代码中, <code class="language-plaintext highlighter-rouge">refresh_gray4_image</code> 和 <code class="language-plaintext highlighter-rouge">refresh_gray2_image</code> 分别是 4 级和 2 级灰度的刷新函数.
这里对灰度的每一位的权重映射做了微调.
格式兼容 embedded-graphics 中的 Framebuffer 和 Image 类型, 可以直接使用.
其中的 bit 操作, 其实基本上是 Github Copilot 写的, 我只是稍微修改了下边界情况和编译错误,
实现不是最优, 但好理解.</p>

<p>显示效果, 这里以互联网 UGC 时代的化石, 徐静蕾手写体为例:</p>

<p><img src="/assets/esl-10in2-grayscale.jpeg" alt="Gray4 for Font Renderring" /></p>

<p>你猜我抗锯齿字体怎么渲染的? 没错, 还是 <a href="https://github.com/andelf/text-image">text-image</a> 过程宏, 使用方法:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span> <span class="o">=</span> <span class="nn">text_image</span><span class="p">::</span><span class="nd">text_image!</span><span class="p">(</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s">"北京市发布持续低温黄色预警</span><span class="se">\n</span><span class="s">北京市发布道路结冰橙色预警</span><span class="se">\n\n</span><span class="s">-12.5℃ </span><span class="se">\n</span><span class="s">-16℃ -- -7℃</span><span class="se">\n</span><span class="s">相对湿度 36%</span><span class="se">\n</span><span class="s">东北风 1级"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="s">"./徐静蕾手写体.ttf"</span><span class="p">,</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="mf">48.0</span><span class="p">,</span>
    <span class="n">line_spacing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">inverse</span><span class="p">,</span>
    <span class="n">Gray4</span><span class="p">,</span>
<span class="p">);</span>

<span class="nd">info!</span><span class="p">(</span><span class="s">"w: {}, h: {}"</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

<span class="n">epd</span><span class="nf">.set_partial_refresh</span><span class="p">(</span><span class="nn">Rectangle</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Point</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">160</span><span class="p">),</span> <span class="nn">Size</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)));</span>
<span class="n">epd</span><span class="nf">.refresh_gray4_image</span><span class="p">(</span><span class="n">raw</span><span class="p">);</span>
</code></pre></div></div>

<p>当然这里用到了 “局部刷新” 函数, 我们这就介绍.</p>

<h3 id="局部刷新">局部刷新</h3>

<p>局部刷新是指, 只刷新屏幕的一个矩形部分, 而不是整屏刷新. 这在阅读器类应用中, 是非常重要的功能.
包括弹出式彩蛋, 局部 UI 元素等都可以用到.
在日历天气中, 局部刷新可以只刷新时间或天气的一小部分, 而不是整屏刷新, 从而大大提升观感.</p>

<p>实际上局部刷新只需要找驱动 IC 手册中的 RAM X/Y Start/End 关键词即可,
UCxxxx 系列的驱动 IC, 也会直接提供 Partial Update 的相关命令.
这里一笔带过直接上代码:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">fn</span> <span class="nf">clear_as_bw_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// set X/Y ram counter</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x4E</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x4F</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">]);</span>

        <span class="k">const</span> <span class="n">NBUF</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">960</span> <span class="o">*</span> <span class="mi">640</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
        <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x24</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">NBUF</span> <span class="p">{</span>
            <span class="k">self</span><span class="nf">.send_data</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mi">0xFF</span><span class="p">]);</span> <span class="c1">// W</span>
        <span class="p">}</span>

        <span class="c1">// reset X/Y ram counter</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x4E</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x4F</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.send_command</span><span class="p">(</span><span class="mi">0x26</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">NBUF</span> <span class="p">{</span>
            <span class="k">self</span><span class="nf">.send_data</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mi">0xFF</span><span class="p">]);</span> <span class="c1">// Red off</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_partial_refresh</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">rect</span><span class="p">:</span> <span class="n">Rectangle</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// clear old buf</span>
        <span class="k">self</span><span class="nf">.clear_as_bw_mode</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">rect</span><span class="py">.top_left.x</span> <span class="k">as</span> <span class="nb">u16</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">rect</span><span class="nf">.bottom_right</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="py">.x</span> <span class="k">as</span> <span class="nb">u16</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">rect</span><span class="py">.top_left.y</span> <span class="k">as</span> <span class="nb">u16</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">rect</span><span class="nf">.bottom_right</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="py">.y</span> <span class="k">as</span> <span class="nb">u16</span><span class="p">;</span>

        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x44</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[(</span><span class="n">x0</span> <span class="o">&amp;</span> <span class="mi">0xff</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&amp;</span> <span class="mi">0xff</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x45</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[(</span><span class="n">y0</span> <span class="o">&amp;</span> <span class="mi">0xff</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">,</span> <span class="p">(</span><span class="n">y0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span> <span class="o">&amp;</span> <span class="mi">0xff</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">]);</span>
        <span class="c1">// set X/Y ram counter</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x4E</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[(</span><span class="n">x0</span> <span class="o">&amp;</span> <span class="mi">0xff</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">]);</span>
        <span class="k">self</span><span class="nf">.send_command_data</span><span class="p">(</span><span class="mi">0x4F</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[(</span><span class="n">y0</span> <span class="o">&amp;</span> <span class="mi">0xff</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">,</span> <span class="p">(</span><span class="n">y0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">]);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>需要注意的是:</p>

<ul>
  <li>在开启局部刷新前需要处理好 OLD/NEW RAM 的状态, 这里选择直接清空</li>
  <li>X/Y RAM counter 需要设置正确</li>
  <li>部分驱动 IC 要求 gate 或 source 边界以 8 对齐, 需要参考手册, 并提前对图片进行裁剪补齐</li>
</ul>

<h2 id="结语">结语</h2>

<p>这里只是简单介绍了如何驱动这块价签, 以及如何实现局部刷新和灰度显示.
其中若干技术可以混用, 例如局部刷新 + 灰度显示, 局部刷新 + 三色显示等等.
屏幕也可以在不同状态下重新初始化, 最终实现的效果, 取决于你的想象力.</p>

<p>原理有了, 剩下的就是点子了. 之前做了一个 <a href="https://www.bing.com/images/create">Bing Image Crator</a>
加随机每日诗词的小工具. 效果还不错, 但一堆粗糙脚本未整理.</p>

<p>一些可能用到的技术再提一遍:</p>

<ul>
  <li>Context Aware Image Resizing(CAIR) - PhotoShop 或一些图形学算法库</li>
  <li>Diffusion Dithering - ImageMagick / PhotoShop</li>
  <li>各种 Text to Image 模型</li>
  <li>我的 <a href="https://github.com/andelf/text-image">text-image</a> 过程宏, 粗糙, 但支持各种图片加载, 字体抗锯齿渲染</li>
  <li>Rust Embedded 我推荐 embassy 框架, 至少它够统一, 而且是 async-first 的
    <ul>
      <li>Rust embedded-graphics 提供了 Framebuffer API, 以及各种图形绘制 API</li>
    </ul>
  </li>
  <li>本项目粗糙代码, 未整理 <a href="https://github.com/andelf/rp-embassy-playground/commit/568eac55c42b9c5682b4c92177090a1fa63842f0">commit</a></li>
</ul>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://blog.csdn.net/qq_41893274/article/details/108649622">https://blog.csdn.net/qq_41893274/article/details/108649622</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>andelf</name></author><category term="blog" /><category term="embedded" /><category term="epd" /><summary type="html"><![CDATA[书接很久以前的 这里. 最近机缘巧合又收了一个 10.2 寸的黑白红墨水屏价签. 很新, 屏幕保护膜都没撕, 又可见倒闭的公司库存.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://andelf.github.io/assets/esl-10in2-bwr.jpeg" /><media:content medium="image" url="https://andelf.github.io/assets/esl-10in2-bwr.jpeg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">使用 Rust 语言 Embassy 嵌入式框架实现 STM32WL LoRa 数据传输</title><link href="https://andelf.github.io/blog/2023/01/23/stm32wl-lora-with-rust-embassy/" rel="alternate" type="text/html" title="使用 Rust 语言 Embassy 嵌入式框架实现 STM32WL LoRa 数据传输" /><published>2023-01-23T04:00:00+00:00</published><updated>2023-01-23T04:00:00+00:00</updated><id>https://andelf.github.io/blog/2023/01/23/stm32wl-lora-with-rust-embassy</id><content type="html" xml:base="https://andelf.github.io/blog/2023/01/23/stm32wl-lora-with-rust-embassy/"><![CDATA[<p>之前参与了 eet-china.com 的开发板测评活动, 申请的板子是 <a href="https://mbb.eet-china.com/evaluating/product-106.html">STM32WLE5 易智联 Lora 评估板(LM401-Pro-Kit)</a>, 正好 Rust Embassy 框架对 STM32WL 系列及其 SubGhz 有不错的支持, 所以打算用这套技术栈进行开发尝试.</p>

<p>本文主要介绍如何使用 Rust 语言的 Embassy 嵌入式框架实现 STM32WL LoRa 数据传输. 过年回老家, 随身带的东西不多, 只有一个迷你 BMP280 (大气压温度)传感器模块, 所以本文使用 BMP280 传感器数据作为例子.</p>

<p>门槛率高, 还是从点灯开始搞起.</p>

<p>最终相关代码位于 <a href="https://github.com/andelf/lm401-pro-kit">Github: andelf/lm401-pro-kit</a>.</p>

<h2 id="介绍">介绍</h2>

<p>快递于 [[2023-01-08]] 收到, 里面的评估板, 天线, 数据线均是两份, 方便开发使用.</p>

<h3 id="开发板介绍">开发板介绍</h3>

<p>LM401-Pro-Kit 是基于 STM32WLE5CBU6 的 Lora 评估板. 支持 SubGHz 无线传输. LM401 模组内嵌高性能 MCU 芯片 STM32WLE5CBU6, 芯片内部集成了 SX1262. 开发板板载 ST-Link(上传下载程序, UART 转 USB). ST-Link 通过跳线帽和模块核心部分连接, 方便单独供电使用模块. 开发板提供了若干 LED 状态灯, 复位按钮和一个用户按钮.</p>

<p>日常屯的(吃灰)板子也有大几十上百了, 拿到新板子, 需要查资料, 看手册, 电路图, 读例程, 找到一些核心信息, 其中一些信息可能需要读例程的 C 代码库才能获得, 这里列出整理的部分:</p>

<ul>
  <li>MCU: STM32WLE5CBU6
    <ul>
      <li>架构: Cortex-M4</li>
      <li>主频: 48MHz, <strong>通过 MSI 提供</strong></li>
      <li>FLASH 128K，RAM 48K</li>
      <li>核心外设: SX1262 via SPI3</li>
    </ul>
  </li>
  <li>LM401: CN470-510MHZ</li>
  <li>板载
    <ul>
      <li>ST-Link 下载器</li>
      <li>用户按钮 PA0</li>
      <li>LED blue PB5, green PB4, yellow PB3</li>
      <li>射频开关:
        <ul>
          <li>FE_CTRL1 PB0</li>
          <li>FE_CTRL2 PA15, LM401 未使用</li>
          <li>FE_CTRL3 PA8</li>
        </ul>
      </li>
      <li>UART RX/TX
        <ul>
          <li>PA2 TXD, USART2_TX, LPUART1_TX</li>
          <li>PA3 RXD, USART2_RX, LPUART1_RX</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="预备知识">预备知识</h3>

<ul>
  <li>对 Rust 的基础了解</li>
  <li>对 STM32 的基础了解</li>
</ul>

<p>使用 Rust 嵌入式开发大概大概有如下几层(只是粗略分类, 实际项目使用中, 可能会混合使用):</p>

<ul>
  <li>直接使用 PAC 库操作寄存器, PAC 库通过 <code class="language-plaintext highlighter-rouge">svd2rust</code> 工具从 <code class="language-plaintext highlighter-rouge">.svd</code> 文件生成</li>
  <li>使用 HAL 库, 例如 stm32f4xx-hal, stm32l0xx-hal, stm32wlxx-hal 等, 融合 <code class="language-plaintext highlighter-rouge">embedded-hal</code> 生态</li>
  <li>使用 Rust 嵌入式框架, 例如 embassy</li>
</ul>

<p>Embassy 框架是基于 Rust 语言的嵌入式异步框架. 考虑到相关框架还在开发中, 本文的代码仓库使用的是最新的 embassy master 分支. Commit hash 为 <code class="language-plaintext highlighter-rouge">f98ba4ebac192e81c46933c0dc1dfb2d907cd532</code>, 通过 <code class="language-plaintext highlighter-rouge">Cargo.toml</code> 中设置依赖 <code class="language-plaintext highlighter-rouge">path</code> 的方式引入. 其他可选方案还可有 <code class="language-plaintext highlighter-rouge">git submodule</code> 或 直接 <code class="language-plaintext highlighter-rouge">git</code> 依赖远程版本等.</p>

<p>绕开 C HAL/BSP 库开发, 是需要踩不少坑的, 例如, RCC 时钟初始化, 需要查阅 BSP 代码才能确认, 48MHz 主时钟通过 MSI range11 获得, 而 embassy 对应 MCU 的示例代码使用的是 HSE, 这些都给 Rust 嵌入式开发带来一定的门槛.</p>

<h3 id="软件环境准备">软件环境准备</h3>

<p>安装 Rust 工具链, 本文使用 rustup nightly. 请参考 https://rustup.rs/ .</p>

<p>安装 Rust <code class="language-plaintext highlighter-rouge">thumbv7em-none-eabi</code> target, 对应 Cortex-M4:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rustup target add thumbv7em-none-eabi
</code></pre></div></div>

<p>安装 Rust 嵌入式开发烧录/运行工具 <code class="language-plaintext highlighter-rouge">probe-run</code>, 也可以使用 OpenOCD 或其他烧录工具:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>cargo <span class="nb">install </span>probe-run
<span class="go">...(install log)
</span><span class="gp">&gt;</span><span class="w"> </span>probe-run <span class="nt">--list-chips</span> | <span class="nb">grep </span>STM32WL
<span class="go">STM32WL Series
        STM32WLE5J8Ix
        STM32WLE5JBIx
        STM32WLE5JCIx
        STM32WL55JCIx
</span></code></pre></div></div>

<p>检查发现支持列表没有 STM32WLE5CBU6, 不过可以拿 STM32WLE5JCIx 替代, 问题不大.</p>

<p>安装任意串口调试工具, 这里我使用 <code class="language-plaintext highlighter-rouge">picocom</code>. 其他可以使用的替代有 <a href="https://www.putty.org/">PuTTy</a>, <a href="https://ttssh2.osdn.jp/index.html.en">Teraterm</a> 等等.</p>

<p>通过 USB 数据线连接开发板, 通过 <code class="language-plaintext highlighter-rouge">picocom</code> 连接串口, 通过 <code class="language-plaintext highlighter-rouge">probe-run</code> 烧录程序.</p>

<p>测试连接</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>lsusb
<span class="go">Bus 001 Device 008: ID 0483:374b STMicroelectronics STM32 STLink  Serial: xxxx
</span></code></pre></div></div>

<h2 id="从-blinky-开始-embassy-应用开发">从 Blinky 开始 Embassy 应用开发</h2>

<p>考虑到从初识 Rust 嵌入式开发直接跨越到 LoRa 无线传输门槛较高, 我们从简单的点灯例子开始:</p>

<h3 id="创建项目---初始化-rust-嵌入式项目模板">创建项目 - 初始化 Rust 嵌入式项目模板</h3>

<p>我们直接依赖 embassy 的 master 分支进行开发, 为方便调试, 直接 clone 到本地用相对路径引入依赖:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone git@github.com:embassy-rs/embassy.git
<span class="c"># or</span>
git clone https://github.com/embassy-rs/embassy.git

<span class="c"># 在同层目录直接创建我们的项目, 起板子名就可以. 相当于一个 BSP 模板可以扩充</span>

cargo new <span class="nt">--lib</span> lm401-pro-kit

<span class="c"># 进入项目目录, 以下命令均在此执行</span>
<span class="nb">cd </span>lm401-pro-kit
</code></pre></div></div>

<p>Rust 嵌入式项目的初始设置需要请参考项目代码</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.cargo/config.toml</code>
    <ul>
      <li>设置编译器 target 到 <code class="language-plaintext highlighter-rouge">thumbv7em-none-eabi</code></li>
      <li>设置 <code class="language-plaintext highlighter-rouge">cargo run</code> 的执行方式为调用 <code class="language-plaintext highlighter-rouge">probe-run ...</code></li>
      <li>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[target.'cfg(all(target_arch = "arm", target_os = "none"))']
runner = "probe-run --chip STM32WLE5JCIx"

[build]
target = "thumbv7em-none-eabi"
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">build.rs</code>
    <ul>
      <li>设置 <code class="language-plaintext highlighter-rouge">link.x</code>/<code class="language-plaintext highlighter-rouge">memory.x</code> 链接过程中所用配置, 编译过程中由 embassy 自动按照芯片选择生成</li>
      <li>添加 <code class="language-plaintext highlighter-rouge">defmt</code> 链接参数支持</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Cargo.toml</code>
    <ul>
      <li>添加 <code class="language-plaintext highlighter-rouge">embassy</code> 相关依赖, 并通过 <code class="language-plaintext highlighter-rouge">features</code> 设置相关参数</li>
      <li>添加项目依赖, defmt, cortex-m 相关等</li>
      <li>设置编译参数 <code class="language-plaintext highlighter-rouge">opt-level = "z"</code>, 最小化编译二进制大小</li>
      <li>
        <div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># part of Cargo.toml</span>
<span class="nn">[dependencies]</span>
<span class="c"># ...</span>
<span class="nn">embassy-stm32</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.1.0"</span><span class="p">,</span> <span class="py">path</span> <span class="p">=</span> <span class="s">"../embassy/embassy-stm32"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="p">[</span>
    <span class="s">"nightly"</span><span class="p">,</span>
    <span class="s">"defmt"</span><span class="p">,</span>
    <span class="s">"stm32wle5cb"</span><span class="p">,</span>
    <span class="s">"time-driver-any"</span><span class="p">,</span>
    <span class="s">"memory-x"</span><span class="p">,</span>
    <span class="s">"subghz"</span><span class="p">,</span>
    <span class="s">"unstable-pac"</span><span class="p">,</span>
    <span class="s">"exti"</span><span class="p">,</span>
<span class="p">]</span> <span class="p">}</span>
<span class="c"># ...</span>
<span class="nn">[profile.dev]</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="s">"z"</span> <span class="c"># Optimize for size.</span>

<span class="nn">[profile.release]</span>
<span class="py">lto</span> <span class="p">=</span> <span class="kc">true</span>
<span class="py">opt-level</span> <span class="p">=</span> <span class="s">"z"</span> <span class="c"># Optimize for size.</span>
</code></pre></div>        </div>
      </li>
      <li>defmt 是一个非常好用的 Rust 嵌入式调试打印, 对 STM32(ST-Link) 有很好的支持.</li>
      <li><code class="language-plaintext highlighter-rouge">stm32wle5cb</code> 用于选择 STM32WLE5CBU6 的芯片配置, <code class="language-plaintext highlighter-rouge">subghz</code> 用于选择 SubGHz 驱动.</li>
      <li><code class="language-plaintext highlighter-rouge">memory-x</code> 自动生成链接所需的 <code class="language-plaintext highlighter-rouge">memory.x</code> 文件(FLASH, SRAM 的大小和内存位置).</li>
    </ul>
  </li>
  <li>未避免编译报错, 还需要清空 <code class="language-plaintext highlighter-rouge">src/lib.rs</code> 项目初始文件, 用 <code class="language-plaintext highlighter-rouge">#![no_std]</code> 替代</li>
</ul>

<p>几乎所有的 Rust 嵌入式项目都是 <code class="language-plaintext highlighter-rouge">no_std</code> 的, 这意味着无法简单地使用所有带内存分配类型. 本例中, 我们使用 <code class="language-plaintext highlighter-rouge">heapless</code> crate 中提供的栈分配类型来替代 <code class="language-plaintext highlighter-rouge">String</code>.</p>

<p>注意到, 创建项目时候使用了 <code class="language-plaintext highlighter-rouge">cargo new --lib</code>, 相当于我们创建的是一个 library 项目. 这不需要担心, <code class="language-plaintext highlighter-rouge">cargo run</code> 会自动识别 <code class="language-plaintext highlighter-rouge">src/bin/xxx.rs</code> 为 “可执行” 二进制目标. 通过 <code class="language-plaintext highlighter-rouge">cargo run --bin xxx</code> 即可运行对应程序. 也可以通过 <code class="language-plaintext highlighter-rouge">examples/xxx.rs</code> 的方法管理多个可执行二进制目标.</p>

<h3 id="blinky-点灯---初识-rust-embassy">Blinky 点灯 - 初识 Rust Embassy</h3>

<p>我们先通过一个最简单的闪灯例子来熟悉 Rust Embassy 的使用. 创建 <code class="language-plaintext highlighter-rouge">src/bin/blinky.rs</code>.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// blinky.rs</span>
<span class="nd">#![no_std]</span>
<span class="nd">#![no_main]</span>
<span class="nd">#![feature(type_alias_impl_trait)]</span>

<span class="k">use</span> <span class="nn">defmt</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">embassy_executor</span><span class="p">::</span><span class="n">Spawner</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nn">gpio</span><span class="p">::{</span><span class="n">Level</span><span class="p">,</span> <span class="n">Output</span><span class="p">,</span> <span class="n">Speed</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">embassy_time</span><span class="p">::{</span><span class="n">Duration</span><span class="p">,</span> <span class="n">Timer</span><span class="p">};</span>
<span class="k">use</span> <span class="p">{</span><span class="n">defmt_rtt</span> <span class="k">as</span> <span class="n">_</span><span class="p">,</span> <span class="n">panic_probe</span> <span class="k">as</span> <span class="n">_</span><span class="p">};</span>

<span class="nd">#[embassy_executor::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">(</span><span class="n">_spawner</span><span class="p">:</span> <span class="n">Spawner</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nf">init</span><span class="p">(</span><span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">());</span>
    <span class="nd">info!</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">);</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">led</span> <span class="o">=</span> <span class="nn">Output</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">p</span><span class="py">.PB4</span><span class="p">,</span> <span class="nn">Level</span><span class="p">::</span><span class="n">High</span><span class="p">,</span> <span class="nn">Speed</span><span class="p">::</span><span class="n">Low</span><span class="p">);</span>

    <span class="k">loop</span> <span class="p">{</span>
        <span class="nd">info!</span><span class="p">(</span><span class="s">"high"</span><span class="p">);</span>
        <span class="n">led</span><span class="nf">.set_high</span><span class="p">();</span>
        <span class="nn">Timer</span><span class="p">::</span><span class="nf">after</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_millis</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span><span class="k">.await</span><span class="p">;</span>

        <span class="nd">info!</span><span class="p">(</span><span class="s">"low"</span><span class="p">);</span>
        <span class="n">led</span><span class="nf">.set_low</span><span class="p">();</span>
        <span class="nn">Timer</span><span class="p">::</span><span class="nf">after</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_millis</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span><span class="k">.await</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">#![no_main]</code> 用于告诉 Rust 编译器, 我们不使用 Rust 提供的 <code class="language-plaintext highlighter-rouge">main</code> 函数做程序入口. <code class="language-plaintext highlighter-rouge">#[embassy_executor::main]</code> 是一个宏, 用于包装 <code class="language-plaintext highlighter-rouge">async fn main()</code> 函数, 由 embassy-executor 提供了一个 futures runtime, 所以可以使用 <code class="language-plaintext highlighter-rouge">async</code> 和 <code class="language-plaintext highlighter-rouge">await</code> 语法. 底层实现中, <code class="language-plaintext highlighter-rouge">.await</code> 通过 STM32 的 WFE/SEV 等待指令和中断唤醒指令实现, 实现了程序逻辑在等待时候的低功耗.
<code class="language-plaintext highlighter-rouge">Spawner</code> 还可以用来启动其他 <code class="language-plaintext highlighter-rouge">async fn</code> 函数, 实现了多任务的功能.</p>

<p><code class="language-plaintext highlighter-rouge">#![feature(type_alias_impl_trait)]</code> 在 embassy 中被广泛使用, 需要开启. Embassy 中经常能看到形如 <code class="language-plaintext highlighter-rouge">irq: impl Peripheral&lt;P = T::Interrupt&gt; + 'd</code> 的类型签名.</p>

<p><code class="language-plaintext highlighter-rouge">let p = embassy_stm32::init(Default::default());</code> 直接初始化了所有的外设, 并返回一个 <code class="language-plaintext highlighter-rouge">Peripherals</code> 对象.
通过 Rust 的 move 语义保证不同外设使用之间不会出现竞争.</p>

<p><code class="language-plaintext highlighter-rouge">let mut led = Output::new(p.PB4, Level::High, Speed::Low);</code> 创建了一个 <code class="language-plaintext highlighter-rouge">Output</code> 对象, 用于控制 PB4 引脚.
<code class="language-plaintext highlighter-rouge">Output</code> 对象是一个 <code class="language-plaintext highlighter-rouge">Pin</code> 的 trait, 通过 <code class="language-plaintext highlighter-rouge">set_high</code> 和 <code class="language-plaintext highlighter-rouge">set_low</code> 方法可以控制引脚电平. 这里会自动完成对 GPIOB PB4 的所有初始化和设置, 包括外设时钟使能, 状态设置等.</p>

<p><code class="language-plaintext highlighter-rouge">info!</code>, <code class="language-plaintext highlighter-rouge">warn!</code> 等都是 <code class="language-plaintext highlighter-rouge">defmt</code> 的宏, 用于通过 ST-Link 提供的 Debug 通道打印调试信息. 强烈推荐使用, 否则嵌入式开发中, 只能用串口打印信息.</p>

<p><code class="language-plaintext highlighter-rouge">Timer::after(Duration::from_millis(1000)).await</code> 是一个异步等待 1 秒的方法, 通过 <code class="language-plaintext highlighter-rouge">embassy-time</code> crate 实现. 在 <code class="language-plaintext highlighter-rouge">Cargo.toml</code> 中的 <code class="language-plaintext highlighter-rouge">time-driver-any</code> feature 选择了任意可用 timer 实现, 默认是 TIM2, 由 embassy-stm32 提供给 <code class="language-plaintext highlighter-rouge">embassy-time</code>.</p>

<p>确保板子连接正常, 直接运行:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>cargo run <span class="nt">--bin</span> blinky
<span class="go">    Finished dev [optimized + debuginfo] target(s) in 0.32s
     Running `probe-run --chip STM32WLE5JCIx target/thumbv7em-none-eabi/debug/blinky`
(HOST) INFO  flashing program (14 pages / 14.00 KiB)
(HOST) INFO  success!
────────────────────────────────────────────────────────────────────────────────
0.000000 DEBUG rcc: Clocks { sys: Hertz(4000000), apb1: Hertz(4000000), apb1_tim: Hertz(4000000), apb2: Hertz(4000000), apb2_tim: Hertz(4000000), apb3: Hertz(4000000), ahb1: Hertz(4000000), ahb2: Hertz(4000000), ahb3: Hertz(4000000) }
└─ embassy_stm32::rcc::set_freqs @ ./embassy/embassy-stm32/src/fmt.rs:125
0.000113 INFO  Hello World!
</span><span class="gp">└─ blinky::____embassy_main_task::{async_fn#</span>0<span class="o">}</span> @ src/bin/blinky.rs:14
<span class="go">0.000552 INFO  high
</span><span class="gp">└─ blinky::____embassy_main_task::{async_fn#</span>0<span class="o">}</span> @ src/bin/blinky.rs:19
<span class="go">1.001157 INFO  low
</span><span class="gp">└─ blinky::____embassy_main_task::{async_fn#</span>0<span class="o">}</span> @ src/bin/blinky.rs:23
<span class="go">2.001811 INFO  high
</span></code></pre></div></div>

<ul>
  <li>二进制编译成功后, 由 <code class="language-plaintext highlighter-rouge">probe-run</code> 烧录到 MCU 并执行, 持续获取 defmt 打印信息</li>
  <li><code class="language-plaintext highlighter-rouge">rcc: Clocks</code> 调试时钟信息由 <code class="language-plaintext highlighter-rouge">embassy-stm32</code> 库 <code class="language-plaintext highlighter-rouge">embassy_stm32::rcc::set_freqs</code> 打印</li>
  <li>所有 defmt 打印内容在 <code class="language-plaintext highlighter-rouge">cargo run</code> dev 模式下均附加了代码行, 非常方便</li>
  <li>defmt 打印内容均带有时间戳, 该时间戳由 STM32 SYSTICK 提供(所以如果使用了 SYSTICK, 有可能导致时间戳异常)</li>
  <li>最终的 <code class="language-plaintext highlighter-rouge">main</code> 函数显示为 <code class="language-plaintext highlighter-rouge">blinky::____embassy_main_task::{async_fn#0}</code>, 由 <code class="language-plaintext highlighter-rouge">#[embassy_executor::main]</code> 宏生成</li>
</ul>

<h3 id="uart-打印---时钟和外设初始化">UART 打印 - 时钟和外设初始化</h3>

<p>defmt 固然方便, 但很多时候依然需要用到 UART, 通过串口获取调试信息或收集数据. LM401-Pro-Kit 正好通过 ST-Link 提供了到 USART2 的访问.</p>

<p>Blinky 例子中, 由 defmt 调试信息可知, 我们使用的系统时钟只有 4MHz, 但 STM32WL 的最大时钟频率是 48MHz. 所以需要通过初始化 <code class="language-plaintext highlighter-rouge">init()</code> 方法设置时钟参数:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// sys clk init, with LSI support</span>
<span class="k">let</span> <span class="k">mut</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nn">Config</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span>
<span class="n">config</span><span class="py">.rcc.enable_lsi</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="n">config</span><span class="py">.rcc.mux</span> <span class="o">=</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nn">rcc</span><span class="p">::</span><span class="nn">ClockSrc</span><span class="p">::</span><span class="nf">MSI</span><span class="p">(</span><span class="nn">embassy_stm32</span><span class="p">::</span><span class="nn">rcc</span><span class="p">::</span><span class="nn">MSIRange</span><span class="p">::</span><span class="n">Range11</span><span class="p">);</span> <span class="c1">// 48MHz</span>
<span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nf">init</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
</code></pre></div></div>

<p>Embassy UART 使用非常简单, 可以单独用 UartTx/UartRx 只初始发送/接收部分. 这里是一个发送 Hello world 和 MCU 内部 “时间” 的简单示例:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// USART2 tx</span>
<span class="k">use</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nn">dma</span><span class="p">::</span><span class="n">NoDma</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nn">usart</span><span class="p">::</span><span class="n">UartTx</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">embassy_time</span><span class="p">::</span><span class="n">Instant</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">heapless</span><span class="p">::</span><span class="nb">String</span><span class="p">;</span>

<span class="c1">// Default: 115200 8N1</span>
<span class="k">let</span> <span class="k">mut</span> <span class="n">usart</span> <span class="o">=</span> <span class="nn">UartTx</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">p</span><span class="py">.USART2</span><span class="p">,</span> <span class="n">p</span><span class="py">.PA2</span><span class="p">,</span> <span class="n">NoDma</span><span class="p">,</span> <span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">());</span>

<span class="k">let</span> <span class="k">mut</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">String</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nn">String</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
<span class="k">let</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">Instant</span><span class="p">::</span><span class="nf">now</span><span class="p">();</span>
<span class="nn">core</span><span class="p">::</span><span class="nd">write!</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">"Hello world, device time: {}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="nf">.as_millis</span><span class="p">())</span><span class="nf">.unwrap</span><span class="p">();</span>
<span class="n">usart</span><span class="nf">.blocking_write</span><span class="p">(</span><span class="n">msg</span><span class="nf">.as_bytes</span><span class="p">())</span><span class="nf">.unwrap</span><span class="p">();</span>
<span class="n">msg</span><span class="nf">.clear</span><span class="p">();</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">UartTx</code> 初始化时需要传入 <code class="language-plaintext highlighter-rouge">USART2</code>, <code class="language-plaintext highlighter-rouge">PA2</code>, 分别对应 USART2 外设和 TX 引脚, DMA 通道是可选的. 默认串口参数是 115200 8N1. 外设初始化会自动处理对应引脚的 AF 设置.</p>

<p>串口打印需要字符串拼接格式化, 由于 <code class="language-plaintext highlighter-rouge">no_std</code>, 标准库的 <code class="language-plaintext highlighter-rouge">String</code> 类型不可用, 这里使用 <code class="language-plaintext highlighter-rouge">heapless::String</code>, 初始化时候需要指定分配大小. <code class="language-plaintext highlighter-rouge">core::write!</code> 即标准库中的 <code class="language-plaintext highlighter-rouge">write!</code>, <code class="language-plaintext highlighter-rouge">core::</code> 前缀是为了避免和 <code class="language-plaintext highlighter-rouge">defmt::write!</code> 名字冲突.</p>

<p>完整代码请参考 <a href="https://github.com/andelf/lm401-pro-kit">代码仓库</a>.</p>

<p>执行代码确认, 可以看到系统时钟被正确设置为 48MHz.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>cargo run <span class="nt">--bin</span> uart
<span class="go">0.000000 DEBUG rcc: Clocks { sys: Hertz(48000000), apb1: Hertz(48000000), apb1_tim: Hertz(48000000), apb2: Hertz(48000000), apb2_tim: Hertz(48000000), apb3: Hertz(48000000), ahb1: Hertz(48000000), ahb2: Hertz(48000000), ahb3: Hertz(48000000) }
└─ embassy_stm32::rcc::set_freqs @ /Users/mono/Elec/embassy/embassy-stm32/src/fmt.rs:125
0.000011 INFO  Hello World!
</span><span class="gp">└─ uart::____embassy_main_task::{async_fn#</span>0<span class="o">}</span> @ src/bin/uart.rs:21
<span class="go">0.000064 INFO  tick
</span></code></pre></div></div>

<p>在另一命令行打开串口监视工具, 查看串口输出:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>picocom <span class="nt">-b</span> 115200 /dev/tty.usbmodem11103
<span class="go">Hello world, device time: 1000
Hello world, device time: 3002
Hello world, device time: 5005
Hello world, device time: 7008
Hello world, device time: 9011
Hello world, device time: 11013
</span><span class="c">....
</span></code></pre></div></div>

<h3 id="i2c-访问-bmp280">I2C 访问 BMP280</h3>

<h4 id="硬件准备">硬件准备</h4>

<ul>
  <li>BMP280 传感器模块 1 个</li>
  <li>杜邦线若干根, 用于连接传感器模块和开发板</li>
</ul>

<p>BMP280 是来自 Bosch 的气压传感器, 通过 I2C 接口读取气压和温度数据, 所以需要在板子上找到未被占用的 I2C SCL/SDA 引脚资源, 通过查阅芯片手册, 最后选择了空闲的 I2C2, SCL pin PA12, SDA pin PA11. 开发板上一排跳线帽正好提供了 VCC, GND.</p>

<p>接线:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+--------+          VCC GND
| BMP280 |           |   |
|      VCC&gt;----------+   |
|      GND&gt;--------------+
| [.]  SCL&gt;--------------------&gt;PA12
|      SDA&gt;--------------------&gt;PA11
|        |          (LM401-Pro-Kit)
+--------+
</code></pre></div></div>

<h4 id="bmp280-访问">BMP280 访问</h4>

<p>Rust Embassy 完美兼容 <code class="language-plaintext highlighter-rouge">embedded-hal</code> 相关生态, 相关外设类型均支持对应的 <code class="language-plaintext highlighter-rouge">embedded-hal</code> trait,</p>

<p>考虑到 BMP280 的使用略微复杂, 需要初始化, 读取校准数据, 测量后还需要通过校准数据计算最终测量结果. 所以 BMP280 直接寻找对应驱动即可. 但 Rust 嵌入式生态有个问题, 弃坑项目太多. 寻找第三方依赖时候需要注意阅读代码, 查看依赖版本, 必要时更新.</p>

<p>这么说, 其实是之前我有个弃坑项目里面有个 BME280 驱动库, BME280 和 BMP280 基本兼容, 只是多了湿度测量. 驱动代码使用 <code class="language-plaintext highlighter-rouge">embedded-hal</code> 提供的 trait 类型访问设备, 完成传感器初始化和测量. 稍微改了改, 直接 Copy <a href="https://github.com/andelf/embedded-drivers/blob/master/src/bme280.rs">embedded-drivers: bme280.rs</a> 到项目 <code class="language-plaintext highlighter-rouge">src/</code> 下使用即可.</p>

<p>修改 <code class="language-plaintext highlighter-rouge">src/lib.rs</code> 增加:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">mod</span> <span class="n">bme280</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="代码实现">代码实现</h4>

<p>创建 BMP280 传感器项目 <code class="language-plaintext highlighter-rouge">src/bin/i2c-bmp280.rs</code>. 完整代码请参考 <a href="https://github.com/andelf/lm401-pro-kit">代码仓库</a>, 以下只选择关键部分介绍.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// BMP280 init</span>
<span class="k">use</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nn">i2c</span><span class="p">::</span><span class="n">I2c</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="n">interrupt</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="n">Hertz</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">embassy_time</span><span class="p">::</span><span class="n">Delay</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">lm401_pro_kit</span><span class="p">::</span><span class="nn">bme280</span><span class="p">::</span><span class="n">BME280</span><span class="p">;</span>

<span class="k">let</span> <span class="n">irq</span> <span class="o">=</span> <span class="nn">interrupt</span><span class="p">::</span><span class="nd">take!</span><span class="p">(</span><span class="n">I2C2_EV</span><span class="p">);</span>
<span class="k">let</span> <span class="n">i2c</span> <span class="o">=</span> <span class="nn">I2c</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span>
    <span class="n">p</span><span class="py">.I2C2</span><span class="p">,</span>
    <span class="n">p</span><span class="py">.PA12</span><span class="p">,</span>
    <span class="n">p</span><span class="py">.PA11</span><span class="p">,</span>
    <span class="n">irq</span><span class="p">,</span>
    <span class="n">NoDma</span><span class="p">,</span>
    <span class="n">NoDma</span><span class="p">,</span>
    <span class="nf">Hertz</span><span class="p">(</span><span class="mi">100_000</span><span class="p">),</span>
    <span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">(),</span>
<span class="p">);</span>

<span class="k">let</span> <span class="k">mut</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">Delay</span><span class="p">;</span>

<span class="k">let</span> <span class="k">mut</span> <span class="n">bmp280</span> <span class="o">=</span> <span class="nn">BME280</span><span class="p">::</span><span class="nf">new_primary</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">bmp280</span><span class="nf">.init</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">delay</span><span class="p">));</span>
</code></pre></div></div>

<p>Embassy 中访问设备时, 一般会需要中断, 虽然理论上阻塞访问外设时不需要中断.
但是为了保证接口的一致性, 一般都会要求提供中断参数. <code class="language-plaintext highlighter-rouge">interrupt::take!</code> 用于获取对应中断对象.</p>

<p><code class="language-plaintext highlighter-rouge">BME280::new_primary</code> 直接使用设备主地址 <code class="language-plaintext highlighter-rouge">0x76</code> 访问 I2C 总线上的 BMP280.</p>

<p>初始化设备时候由于需要软复位, 需要传递 <code class="language-plaintext highlighter-rouge">Delay</code> 对象, 用于延时(<code class="language-plaintext highlighter-rouge">delay_ms</code>).
默认的 <code class="language-plaintext highlighter-rouge">embassy_time::Delay</code> 使用循环比较 “设备当前时间” 的方法实现.</p>

<p><code class="language-plaintext highlighter-rouge">unwrap!</code> 宏由 <code class="language-plaintext highlighter-rouge">defmt</code> 提供, 等价于 <code class="language-plaintext highlighter-rouge">.unwrap()</code> 调用, 但是会在 panic 时候通过 defmt 打印信息.</p>

<p>完成设备初始化后, 可以访问传感器信息:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">raw</span> <span class="o">=</span> <span class="nd">unwrap!</span><span class="p">(</span><span class="n">bmp280</span><span class="nf">.measure</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">delay</span><span class="p">));</span>
<span class="nd">info!</span><span class="p">(</span><span class="s">"BMP280: {:?}"</span><span class="p">,</span> <span class="n">raw</span><span class="p">);</span>
</code></pre></div></div>

<p>传感器执行测量时候, 按照手册, 依然需要延时, 所以也同样需要传递 <code class="language-plaintext highlighter-rouge">Delay</code> 对象.
<code class="language-plaintext highlighter-rouge">BME280::measure</code> 方法返回 <code class="language-plaintext highlighter-rouge">Measurements</code> 类型, 为了方便调试使用, 用 derive macro 增加了 defmt 支持, 可以直接做格式化参数:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Debug,</span> <span class="nd">defmt::Format)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Measurements</span> <span class="p">{</span>
    <span class="cd">/// temperature in degrees celsius</span>
    <span class="k">pub</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">f32</span><span class="p">,</span>
    <span class="cd">/// pressure in pascals</span>
    <span class="k">pub</span> <span class="n">pressure</span><span class="p">:</span> <span class="nb">f32</span><span class="p">,</span>
    <span class="cd">/// percent relative humidity (`0` with BMP280)</span>
    <span class="k">pub</span> <span class="n">humidity</span><span class="p">:</span> <span class="nb">f32</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>执行代码:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>cargo run <span class="nt">--bin</span> i2c-bmp280
<span class="go">0.000011 INFO  I2C BMP280 demo!
</span><span class="gp">└─ i2c_bmp280::____embassy_main_task::{async_fn#</span>0<span class="o">}</span> @ src/bin/i2c-bmp280.rs:23
<span class="go">0.009314 INFO  measure tick
</span><span class="gp">└─ i2c_bmp280::____embassy_main_task::{async_fn#</span>0<span class="o">}</span> @ src/bin/i2c-bmp280.rs:45
<span class="go">0.051652 INFO  BMP280: Measurements { temperature: 23.689554, pressure: 88391.13, humidity: 0.0 }
</span><span class="gp">└─ i2c_bmp280::____embassy_main_task::{async_fn#</span>0<span class="o">}</span> @ src/bin/i2c-bmp280.rs:48
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">temperature: 23.689554, pressure: 88391.13</code> 传感器数据正常.</p>

<h2 id="lora-传感器数据传输">LoRa 传感器数据传输</h2>

<p>LoRa 是一种无线传输协议, 适合长距离(km), 少量数据传输. 尤其适合传感器数据. 因为手头没有 LoRaWAN 基站, 所以暂时没法测试 LoRaWAN. 这里使用 LoRa 调制模式点对点传输 BMP280 传感器数据.</p>

<p>详细实现请参考 <a href="https://github.com/andelf/lm401-pro-kit">代码仓库</a> 里的 <code class="language-plaintext highlighter-rouge">src/bin/subghz-bmp280-tx.rs</code> 和 <code class="language-plaintext highlighter-rouge">src/bin/subghz-bmp280-rx.rs</code>.</p>

<h3 id="硬件准备-1">硬件准备</h3>

<p>LM401-Pro-Kit x2, 天线, 数据线.</p>

<p>其中一个开发板作为传感器采集端, 按照上一示例链接到 BMP280 传感器模块, 另一个作为接收端, 两个开发板之间通过 LoRa 无线传输数据. 接收端通过 UART 与电脑连接, 通过串口调试工具查看传感器数据.(实际上也可以直接通过 ST-Link + defmt 获取数据)</p>

<h3 id="射频开关-radioswitch">射频开关 RadioSwitch</h3>

<p>使用开发板射频功能, 需要处理射频开关逻辑. 相关逻辑从 BSP C 代码获得. 可以直接作为 BSP 的工具类型, 写入到 <code class="language-plaintext highlighter-rouge">src/lib.rs</code> 中:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">embassy_stm32</span><span class="p">::{</span>
    <span class="nn">gpio</span><span class="p">::{</span><span class="n">AnyPin</span><span class="p">,</span> <span class="n">Level</span><span class="p">,</span> <span class="n">Output</span><span class="p">,</span> <span class="nb">Pin</span><span class="p">,</span> <span class="n">Speed</span><span class="p">},</span>
    <span class="nn">peripherals</span><span class="p">::{</span><span class="n">PA15</span><span class="p">,</span> <span class="n">PA8</span><span class="p">,</span> <span class="n">PB0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">RadioSwitch</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">ctrl1</span><span class="p">:</span> <span class="n">Output</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">AnyPin</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">ctrl2</span><span class="p">:</span> <span class="n">Output</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">AnyPin</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">ctrl3</span><span class="p">:</span> <span class="n">Output</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">AnyPin</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">RadioSwitch</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new_from_pins</span><span class="p">(</span><span class="n">ctrl1</span><span class="p">:</span> <span class="n">PB0</span><span class="p">,</span> <span class="n">ctrl2</span><span class="p">:</span> <span class="n">PA15</span><span class="p">,</span> <span class="n">ctrl3</span><span class="p">:</span> <span class="n">PA8</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">ctrl1</span><span class="p">:</span> <span class="nn">Output</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">ctrl1</span><span class="nf">.degrade</span><span class="p">(),</span> <span class="nn">Level</span><span class="p">::</span><span class="n">Low</span><span class="p">,</span> <span class="nn">Speed</span><span class="p">::</span><span class="n">VeryHigh</span><span class="p">),</span>
            <span class="n">ctrl2</span><span class="p">:</span> <span class="nn">Output</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">ctrl2</span><span class="nf">.degrade</span><span class="p">(),</span> <span class="nn">Level</span><span class="p">::</span><span class="n">Low</span><span class="p">,</span> <span class="nn">Speed</span><span class="p">::</span><span class="n">VeryHigh</span><span class="p">),</span>
            <span class="n">ctrl3</span><span class="p">:</span> <span class="nn">Output</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">ctrl3</span><span class="nf">.degrade</span><span class="p">(),</span> <span class="nn">Level</span><span class="p">::</span><span class="n">Low</span><span class="p">,</span> <span class="nn">Speed</span><span class="p">::</span><span class="n">VeryHigh</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span>
        <span class="n">ctrl1</span><span class="p">:</span> <span class="n">Output</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">AnyPin</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">ctrl2</span><span class="p">:</span> <span class="n">Output</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">AnyPin</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">ctrl3</span><span class="p">:</span> <span class="n">Output</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">AnyPin</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">ctrl1</span><span class="p">,</span>
            <span class="n">ctrl2</span><span class="p">,</span>
            <span class="n">ctrl3</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_off</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.ctrl3</span><span class="nf">.set_low</span><span class="p">();</span>
        <span class="k">self</span><span class="py">.ctrl1</span><span class="nf">.set_low</span><span class="p">();</span>
        <span class="k">self</span><span class="py">.ctrl2</span><span class="nf">.set_low</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="nn">embassy_lora</span><span class="p">::</span><span class="nn">stm32wl</span><span class="p">::</span><span class="n">RadioSwitch</span> <span class="k">for</span> <span class="n">RadioSwitch</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">set_rx</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.ctrl3</span><span class="nf">.set_low</span><span class="p">();</span>
        <span class="k">self</span><span class="py">.ctrl1</span><span class="nf">.set_high</span><span class="p">();</span>
        <span class="k">self</span><span class="py">.ctrl2</span><span class="nf">.set_low</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">set_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.ctrl3</span><span class="nf">.set_high</span><span class="p">();</span>
        <span class="k">self</span><span class="py">.ctrl1</span><span class="nf">.set_low</span><span class="p">();</span>
        <span class="k">self</span><span class="py">.ctrl2</span><span class="nf">.set_low</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>非常简单的 GPIO 操作, GPIO 的强类型 <code class="language-plaintext highlighter-rouge">PAn</code>/<code class="language-plaintext highlighter-rouge">PBn</code>/.. 可以通过 <code class="language-plaintext highlighter-rouge">.degrade()</code> 方法转换为 <code class="language-plaintext highlighter-rouge">AnyPin</code> 类型, 方便使用.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="k">mut</span> <span class="n">rfs</span> <span class="o">=</span> <span class="nn">lm401_pro_kit</span><span class="p">::</span><span class="nn">RadioSwitch</span><span class="p">::</span><span class="nf">new_from_pins</span><span class="p">(</span><span class="n">p</span><span class="py">.PB0</span><span class="p">,</span> <span class="n">p</span><span class="py">.PA15</span><span class="p">,</span> <span class="n">p</span><span class="py">.PA8</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="lora-数据报文定义">LoRa 数据报文定义</h3>

<p>为简单展示, 传感器节点只负责发送, 接受节点只接受 LoRa 报文, 不回传 ACK 信号.</p>

<p>报文格式为 24 字节:</p>

<table>
  <tbody>
    <tr>
      <td>头</td>
      <td>设备地址</td>
      <td>设备时间戳</td>
      <td>温度</td>
      <td>大气压</td>
      <td>checksum</td>
    </tr>
    <tr>
      <td>b”MM”</td>
      <td>u32</td>
      <td>u64</td>
      <td>f32</td>
      <td>f32</td>
      <td>u16</td>
    </tr>
  </tbody>
</table>

<p>其中设备地址使用 STM32 系列的 chip id 实现, 保证一定的唯一性:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Device ID in STM32L4/STM32WL microcontrollers</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">chip_id</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="p">[</span><span class="nb">u32</span><span class="p">;</span> <span class="mi">3</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="p">[</span>
            <span class="nn">core</span><span class="p">::</span><span class="nn">ptr</span><span class="p">::</span><span class="nf">read_volatile</span><span class="p">(</span><span class="mi">0x1FFF7590</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="nb">u32</span><span class="p">),</span>
            <span class="nn">core</span><span class="p">::</span><span class="nn">ptr</span><span class="p">::</span><span class="nf">read_volatile</span><span class="p">(</span><span class="mi">0x1FFF7594</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="nb">u32</span><span class="p">),</span>
            <span class="nn">core</span><span class="p">::</span><span class="nn">ptr</span><span class="p">::</span><span class="nf">read_volatile</span><span class="p">(</span><span class="mi">0x1FFF7598</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="nb">u32</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="n">chip_id</span> <span class="o">=</span> <span class="nf">chip_id</span><span class="p">();</span>
<span class="k">let</span> <span class="n">dev_addr</span> <span class="o">=</span> <span class="n">chip_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">chip_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">chip_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</code></pre></div></div>

<p>设备时间戳直接读取 <code class="language-plaintext highlighter-rouge">Instant::now()</code> 并转为 millis. 保证每个数据报文的差异性. <code class="language-plaintext highlighter-rouge">checksum</code> 校验和字段通过计算 <code class="language-plaintext highlighter-rouge">[2..22]</code> 所有字节之和得到. 所有数据字段均按照大端序列化(BigEndian).</p>

<h3 id="subghz-初始化">SubGhz 初始化</h3>

<p>LM401 的射频功能由 STM32WLE5 内置的 SX1262 提供, 设备内部通过 SPI3(SUBGHZSPI) 访问. SX1262 初始化需要较多参数, 且发送端接收端若干参数需要一致.</p>

<p>这里选用 490.500MHz, LoRa SF7,  4/5 编码率, 125kHz 带宽, 24 字节数据长度. 接收端和发送端设置一致.</p>

<p>参数定义:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">embassy_stm32</span><span class="p">::</span><span class="nn">subghz</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">const</span> <span class="n">DATA_LEN</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="mi">24_u8</span><span class="p">;</span>
<span class="k">const</span> <span class="n">PREAMBLE_LEN</span><span class="p">:</span> <span class="nb">u16</span> <span class="o">=</span> <span class="mi">0x8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

<span class="k">const</span> <span class="n">RF_FREQ</span><span class="p">:</span> <span class="n">RfFreq</span> <span class="o">=</span> <span class="nn">RfFreq</span><span class="p">::</span><span class="nf">from_frequency</span><span class="p">(</span><span class="mi">490_500_000</span><span class="p">);</span>

<span class="k">const</span> <span class="n">TX_BUF_OFFSET</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
<span class="k">const</span> <span class="n">RX_BUF_OFFSET</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">const</span> <span class="n">LORA_PACKET_PARAMS</span><span class="p">:</span> <span class="n">LoRaPacketParams</span> <span class="o">=</span> <span class="nn">LoRaPacketParams</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
    <span class="nf">.set_crc_en</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
    <span class="nf">.set_preamble_len</span><span class="p">(</span><span class="n">PREAMBLE_LEN</span><span class="p">)</span>
    <span class="nf">.set_payload_len</span><span class="p">(</span><span class="n">DATA_LEN</span><span class="p">)</span>
    <span class="nf">.set_invert_iq</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
    <span class="nf">.set_header_type</span><span class="p">(</span><span class="nn">HeaderType</span><span class="p">::</span><span class="n">Fixed</span><span class="p">);</span>

<span class="c1">// SF7, Bandwidth 125 kHz, 4/5 coding rate, low data rate optimization</span>
<span class="k">const</span> <span class="n">LORA_MOD_PARAMS</span><span class="p">:</span> <span class="n">LoRaModParams</span> <span class="o">=</span> <span class="nn">LoRaModParams</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
    <span class="nf">.set_bw</span><span class="p">(</span><span class="nn">LoRaBandwidth</span><span class="p">::</span><span class="n">Bw125</span><span class="p">)</span>
    <span class="nf">.set_cr</span><span class="p">(</span><span class="nn">CodingRate</span><span class="p">::</span><span class="n">Cr45</span><span class="p">)</span>
    <span class="nf">.set_ldro_en</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
    <span class="nf">.set_sf</span><span class="p">(</span><span class="nn">SpreadingFactor</span><span class="p">::</span><span class="n">Sf7</span><span class="p">);</span>

<span class="c1">// see table 35 "PA optimal setting and operating modes"</span>
<span class="k">const</span> <span class="n">PA_CONFIG</span><span class="p">:</span> <span class="n">PaConfig</span> <span class="o">=</span> <span class="nn">PaConfig</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
    <span class="nf">.set_pa_duty_cycle</span><span class="p">(</span><span class="mi">0x4</span><span class="p">)</span>
    <span class="nf">.set_hp_max</span><span class="p">(</span><span class="mi">0x7</span><span class="p">)</span>
    <span class="nf">.set_pa</span><span class="p">(</span><span class="nn">PaSel</span><span class="p">::</span><span class="n">Hp</span><span class="p">);</span>

<span class="k">const</span> <span class="n">TX_PARAMS</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="nn">TxParams</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
    <span class="nf">.set_power</span><span class="p">(</span><span class="mi">0x16</span><span class="p">)</span> <span class="c1">// +22dB</span>
    <span class="nf">.set_ramp_time</span><span class="p">(</span><span class="nn">RampTime</span><span class="p">::</span><span class="n">Micros200</span><span class="p">);</span>
</code></pre></div></div>

<p>设备初始化, 部分内容从 BSP C 代码转换得到:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="k">mut</span> <span class="n">radio</span> <span class="o">=</span> <span class="nn">SubGhz</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">p</span><span class="py">.SUBGHZSPI</span><span class="p">,</span> <span class="n">NoDma</span><span class="p">,</span> <span class="n">NoDma</span><span class="p">);</span>

<span class="c1">// from demo code: Radio_SMPS_Set</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_smps_clock_det_en</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_smps_drv</span><span class="p">(</span><span class="nn">SmpsDrv</span><span class="p">::</span><span class="n">Milli40</span><span class="p">));</span>

<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_standby</span><span class="p">(</span><span class="nn">StandbyClk</span><span class="p">::</span><span class="nb">Rc</span><span class="p">));</span>

<span class="c1">// in XO mode, set internal capacitor (from 0x00 to 0x2F starting 11.2pF with 0.47pF steps)</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_hse_in_trim</span><span class="p">(</span><span class="nn">HseTrim</span><span class="p">::</span><span class="nf">from_raw</span><span class="p">(</span><span class="mi">0x20</span><span class="p">)));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_hse_out_trim</span><span class="p">(</span><span class="nn">HseTrim</span><span class="p">::</span><span class="nf">from_raw</span><span class="p">(</span><span class="mi">0x20</span><span class="p">)));</span>

<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_regulator_mode</span><span class="p">(</span><span class="nn">RegMode</span><span class="p">::</span><span class="n">Smps</span><span class="p">));</span> <span class="c1">// Use DCDC</span>

<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_buffer_base_address</span><span class="p">(</span><span class="n">TX_BUF_OFFSET</span><span class="p">,</span> <span class="n">RX_BUF_OFFSET</span><span class="p">));</span>

<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_pa_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PA_CONFIG</span><span class="p">));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_pa_ocp</span><span class="p">(</span><span class="nn">Ocp</span><span class="p">::</span><span class="n">Max60m</span><span class="p">));</span> <span class="c1">// current max</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_tx_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TX_PARAMS</span><span class="p">));</span>

<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_packet_type</span><span class="p">(</span><span class="nn">PacketType</span><span class="p">::</span><span class="n">LoRa</span><span class="p">));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_lora_sync_word</span><span class="p">(</span><span class="nn">LoRaSyncWord</span><span class="p">::</span><span class="n">Public</span><span class="p">));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_lora_mod_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LORA_MOD_PARAMS</span><span class="p">));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_lora_packet_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LORA_PACKET_PARAMS</span><span class="p">));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.calibrate_image</span><span class="p">(</span><span class="nn">CalibrateImage</span><span class="p">::</span><span class="n">ISM_470_510</span><span class="p">));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_rf_frequency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RF_FREQ</span><span class="p">));</span>
</code></pre></div></div>

<p>中断信号量处理, 由于发送接收循环需要涉及到中断处理, 这里直接用 <code class="language-plaintext highlighter-rouge">Signal</code> 类型的信号量处理中断:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">embassy_sync</span><span class="p">::</span><span class="nn">blocking_mutex</span><span class="p">::</span><span class="nn">raw</span><span class="p">::</span><span class="n">CriticalSectionRawMutex</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">embassy_sync</span><span class="p">::</span><span class="nn">signal</span><span class="p">::</span><span class="n">Signal</span><span class="p">;</span>

<span class="k">static</span> <span class="n">IRQ_SIGNAL</span><span class="p">:</span> <span class="n">Signal</span><span class="o">&lt;</span><span class="n">CriticalSectionRawMutex</span><span class="p">,</span> <span class="p">()</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nn">Signal</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
<span class="k">let</span> <span class="n">radio_irq</span> <span class="o">=</span> <span class="nn">interrupt</span><span class="p">::</span><span class="nd">take!</span><span class="p">(</span><span class="n">SUBGHZ_RADIO</span><span class="p">);</span>
<span class="n">radio_irq</span><span class="nf">.set_handler</span><span class="p">(|</span><span class="n">_</span><span class="p">|</span> <span class="p">{</span>
    <span class="n">IRQ_SIGNAL</span><span class="nf">.signal</span><span class="p">(());</span>
    <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">interrupt</span><span class="p">::</span><span class="nn">SUBGHZ_RADIO</span><span class="p">::</span><span class="nf">steal</span><span class="p">()</span> <span class="p">}</span><span class="nf">.disable</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>这样, 在 <code class="language-plaintext highlighter-rouge">async fn main()</code> 中使用 <code class="language-plaintext highlighter-rouge">IRQ_SIGNAL.wait().await</code> 就可以随时等待中断信号量.</p>

<h3 id="subghz-发送端">SubGhz 发送端</h3>

<p>首先拼接报文, 这里直接手动拼接组合字节:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="k">mut</span> <span class="n">payload</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0u8</span><span class="p">;</span> <span class="mi">24</span><span class="p">];</span>
<span class="k">let</span> <span class="n">now</span> <span class="o">=</span> <span class="nn">Instant</span><span class="p">::</span><span class="nf">now</span><span class="p">();</span>
<span class="k">let</span> <span class="n">measurements</span> <span class="o">=</span> <span class="nd">unwrap!</span><span class="p">(</span><span class="n">bmp280</span><span class="nf">.measure</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">delay</span><span class="p">));</span>

<span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">b'M'</span><span class="p">;</span>
<span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">b'M'</span><span class="p">;</span>

<span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="o">..</span><span class="mi">6</span><span class="p">]</span><span class="nf">.copy_from_slice</span><span class="p">(</span><span class="n">dev_addr</span><span class="nf">.to_be_bytes</span><span class="p">()</span><span class="nf">.as_slice</span><span class="p">());</span>
<span class="n">payload</span><span class="p">[</span><span class="mi">6</span><span class="o">..</span><span class="mi">14</span><span class="p">]</span><span class="nf">.copy_from_slice</span><span class="p">(</span><span class="n">now</span><span class="nf">.as_millis</span><span class="p">()</span><span class="nf">.to_be_bytes</span><span class="p">()</span><span class="nf">.as_slice</span><span class="p">());</span>
<span class="n">payload</span><span class="p">[</span><span class="mi">14</span><span class="o">..</span><span class="mi">18</span><span class="p">]</span><span class="nf">.copy_from_slice</span><span class="p">(</span><span class="n">measurements</span><span class="py">.temperature</span><span class="nf">.to_be_bytes</span><span class="p">()</span><span class="nf">.as_slice</span><span class="p">());</span>
<span class="n">payload</span><span class="p">[</span><span class="mi">18</span><span class="o">..</span><span class="mi">22</span><span class="p">]</span><span class="nf">.copy_from_slice</span><span class="p">(</span><span class="n">measurements</span><span class="py">.pressure</span><span class="nf">.to_be_bytes</span><span class="p">()</span><span class="nf">.as_slice</span><span class="p">());</span>
<span class="k">let</span> <span class="n">checksum</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="o">..</span><span class="mi">22</span><span class="p">]</span>
    <span class="nf">.iter</span><span class="p">()</span>
    <span class="nf">.fold</span><span class="p">(</span><span class="mi">0u16</span><span class="p">,</span> <span class="p">|</span><span class="n">acc</span><span class="p">,</span> <span class="n">x</span><span class="p">|</span> <span class="n">acc</span><span class="nf">.wrapping_add</span><span class="p">(</span><span class="o">*</span><span class="n">x</span> <span class="k">as</span> <span class="nb">u16</span><span class="p">));</span>
<span class="nd">info!</span><span class="p">(</span><span class="s">"checksum: {:04x}"</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>
<span class="n">payload</span><span class="p">[</span><span class="mi">22</span><span class="o">..</span><span class="mi">24</span><span class="p">]</span><span class="nf">.copy_from_slice</span><span class="p">(</span><span class="n">checksum</span><span class="nf">.to_be_bytes</span><span class="p">()</span><span class="nf">.as_slice</span><span class="p">());</span>
</code></pre></div></div>

<p>然后开始发送:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rfs</span><span class="nf">.set_tx</span><span class="p">();</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_irq_cfg</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">CfgIrq</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span><span class="nf">.irq_enable_all</span><span class="p">(</span><span class="nn">Irq</span><span class="p">::</span><span class="n">TxDone</span><span class="p">)));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.write_buffer</span><span class="p">(</span><span class="n">TX_BUF_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">[</span><span class="o">..</span><span class="p">]));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_tx</span><span class="p">(</span><span class="nn">Timeout</span><span class="p">::</span><span class="n">DISABLED</span><span class="p">));</span>

<span class="n">radio_irq</span><span class="nf">.enable</span><span class="p">();</span>
<span class="n">IRQ_SIGNAL</span><span class="nf">.wait</span><span class="p">()</span><span class="k">.await</span><span class="p">;</span>
<span class="n">rfs</span><span class="nf">.set_off</span><span class="p">();</span>

<span class="k">let</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">irq_status</span><span class="p">)</span> <span class="o">=</span> <span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.irq_status</span><span class="p">());</span>
<span class="k">if</span> <span class="n">irq_status</span> <span class="o">&amp;</span> <span class="nn">Irq</span><span class="p">::</span><span class="n">TxDone</span><span class="nf">.mask</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nn">defmt</span><span class="p">::</span><span class="nd">info!</span><span class="p">(</span><span class="s">"TX done"</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.clear_irq_status</span><span class="p">(</span><span class="n">irq_status</span><span class="p">));</span>
</code></pre></div></div>

<p>总结起来发送过程需要如下步骤:</p>

<ul>
  <li>打开射频发送开关</li>
  <li>设置中断, 开启 <code class="language-plaintext highlighter-rouge">TxDone</code></li>
  <li>写入数据 buffer</li>
  <li>开始发送, 不使用 <code class="language-plaintext highlighter-rouge">Timeout</code></li>
  <li>开启中断</li>
  <li>等待中断信号量</li>
  <li>关闭射频开关</li>
  <li>检查中断状态</li>
  <li>清理中断状态</li>
</ul>

<h3 id="subghz-接收端">SubGhz 接收端</h3>

<p>这里是接收端逻辑, <code class="language-plaintext highlighter-rouge">src/bin/subghz-bmp280-rx.rs</code>, 其中配置部分和发送端相同:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="k">mut</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0u8</span><span class="p">;</span> <span class="mi">256</span><span class="p">];</span>

<span class="n">rfs</span><span class="nf">.set_rx</span><span class="p">();</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_irq_cfg</span><span class="p">(</span>
    <span class="o">&amp;</span><span class="nn">CfgIrq</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.irq_enable_all</span><span class="p">(</span><span class="nn">Irq</span><span class="p">::</span><span class="n">RxDone</span><span class="p">)</span>
        <span class="nf">.irq_enable_all</span><span class="p">(</span><span class="nn">Irq</span><span class="p">::</span><span class="n">Timeout</span><span class="p">)</span>
        <span class="nf">.irq_enable_all</span><span class="p">(</span><span class="nn">Irq</span><span class="p">::</span><span class="nb">Err</span><span class="p">)</span>
<span class="p">));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.read_buffer</span><span class="p">(</span><span class="n">RX_BUF_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">buf</span><span class="p">));</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.set_rx</span><span class="p">(</span><span class="nn">Timeout</span><span class="p">::</span><span class="nf">from_duration_sat</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_millis</span><span class="p">(</span><span class="mi">5000</span><span class="p">))));</span>

<span class="n">radio_irq</span><span class="nf">.unpend</span><span class="p">();</span>
<span class="n">radio_irq</span><span class="nf">.enable</span><span class="p">();</span>

<span class="n">IRQ_SIGNAL</span><span class="nf">.wait</span><span class="p">()</span><span class="k">.await</span><span class="p">;</span>
<span class="n">led_rx</span><span class="nf">.set_low</span><span class="p">();</span>
<span class="k">let</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">irq_status</span><span class="p">)</span> <span class="o">=</span> <span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.irq_status</span><span class="p">());</span>
<span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.clear_irq_status</span><span class="p">(</span><span class="n">irq_status</span><span class="p">));</span>

<span class="k">if</span> <span class="n">irq_status</span> <span class="o">&amp;</span> <span class="nn">Irq</span><span class="p">::</span><span class="n">RxDone</span><span class="nf">.mask</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="k">let</span> <span class="p">(</span><span class="n">_st</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="o">=</span> <span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.rx_buffer_status</span><span class="p">());</span>
    <span class="k">let</span> <span class="n">packet_status</span> <span class="o">=</span> <span class="nd">unwrap!</span><span class="p">(</span><span class="n">radio</span><span class="nf">.lora_packet_status</span><span class="p">());</span>
    <span class="k">let</span> <span class="n">rssi</span> <span class="o">=</span> <span class="n">packet_status</span><span class="nf">.rssi_pkt</span><span class="p">()</span><span class="nf">.to_integer</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">snr</span> <span class="o">=</span> <span class="n">packet_status</span><span class="nf">.snr_pkt</span><span class="p">()</span><span class="nf">.to_integer</span><span class="p">();</span>
    <span class="nd">info!</span><span class="p">(</span>
        <span class="s">"RX done: rssi={}dBm snr={}dB len={} offset={}"</span><span class="p">,</span>
        <span class="n">rssi</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span>
    <span class="p">);</span>
    <span class="k">let</span> <span class="n">payload</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span> <span class="k">as</span> <span class="nb">usize</span><span class="o">..</span><span class="n">offset</span> <span class="k">as</span> <span class="nb">usize</span> <span class="o">+</span> <span class="n">len</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">];</span>
    <span class="c1">// Parse payload here</span>
<span class="p">}</span>
</code></pre></div></div>

<p>发送步骤如下:</p>

<ul>
  <li>打开射频接收开关</li>
  <li>设置中断, 开启 <code class="language-plaintext highlighter-rouge">RxDone</code>, <code class="language-plaintext highlighter-rouge">Timeout</code>, <code class="language-plaintext highlighter-rouge">Err</code></li>
  <li>设置读入 buffer</li>
  <li>开始接收, 这里使用 <code class="language-plaintext highlighter-rouge">Timeout</code> 5 秒</li>
  <li>清理未处理中断状态, 否则会有观察到空中断</li>
  <li>开启中断</li>
  <li>等待中断信号量</li>
  <li>检查中断状态, 清理中断状态</li>
  <li>通过 <code class="language-plaintext highlighter-rouge">rx_buffer_status</code> 获取 buffer 状态</li>
  <li>通过 <code class="language-plaintext highlighter-rouge">lora_packet_status</code> 获取报文 rssi, snr 信息</li>
</ul>

<h3 id="运行结果">运行结果</h3>

<p>发送端上电之后, 每2秒采集一次传感器数据并发送.</p>

<p>接收端上电之后, 持续接收数据并同时打印在 defmt 调试和串口输出.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>cargo run <span class="nt">--bin</span> subghz-bmp280-rx <span class="nt">--release</span>
<span class="go">1.226162 INFO  begin rx...
3.292868 INFO  RX done: rssi=-42dBm snr=14dB len=24 offset=0
3.292969 DEBUG got BMP280 node raw=[0x4d, 0x4d, 0x72, 0x2e, 0x67, 0x28, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x58, 0x3a, 0x41, 0xad, 0x10, 0xa2, 0x47, 0xac, 0x8c, 0x2a, 0x5, 0xa]
3.293173 INFO  dev addr=722e6728 dev tick=22586 temp=21.633121'C pressure=883.4433hPa
3.299479 INFO  stats: Stats { status: Status { mode: Ok(StandbyRc), cmd: Ok(Avaliable) }, pkt_rx: 2, pkt_crc: 0, pkt_len_or_hdr_err: 0, ty: LoRaStats }
3.299622 INFO  begin rx...
</span></code></pre></div></div>

<p>串口输出, CSV 格式:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>picocom <span class="nt">-b</span> 115200 /dev/tty.usbmodem11203
<span class="go">addr=722e6728,rssi=-44,snr=14,temperature=16.304043,pressure=87621.96
addr=722e6728,rssi=-44,snr=14,temperature=16.306524,pressure=87621.96
addr=722e6728,rssi=-44,snr=13,temperature=16.309006,pressure=87621.83
addr=722e6728,rssi=-45,snr=13,temperature=16.311487,pressure=87621.81
addr=722e6728,rssi=-45,snr=13,temperature=16.313969,pressure=87621.66
</span></code></pre></div></div>

<h2 id="总结">总结</h2>

<p>Rust Embassy 是一个非常好的嵌入式 Rust 开发框架, 通过它可以快速开发嵌入式应用.
Rust Embassy 把 <code class="language-plaintext highlighter-rouge">async</code>, <code class="language-plaintext highlighter-rouge">await</code> 关键字带到了 Rust 嵌入式开发中, 其还有丰富的多任务支持, 多种同步元语支持. 通过它们, 我们可以很方便的开发多任务应用.</p>

<p>但它依然是一个很早期的框架, 还不够完善, 例如目前在 STM32WL 上缺乏 ADC 支持.
文档不够丰富, 部分库函数会随着开发进度有所变更, 给维护项目带来不小的困难.</p>

<p>在开发过程中, 往往能看到 move 语义, ownership, 类型系统等 Rust 的特性, 虽然这些特性在嵌入式开发中并不是必须的, 但是它们确实能带来更好的开发体验. 例如 move/borrow 保证对设备资源的唯一访问所有权.
通过类型安全的寄存器类型访问避免 C 语言中错误的寄存器访问, 经过 Rust 编译器优化后, 和 C 中的 bit mask 写法是等价的.
通过 “associated types” 保证设备和对应引脚的状态匹配.</p>

<p>Rust Embassy 隐藏了大部分嵌入式设备细节, 开发者不需要过多的关注设备初始化细节, 应用代码短小.</p>

<p>实际使用过程中, 也遇到了一些坑, 例如在写一个 PWM 例子时候, <code class="language-plaintext highlighter-rouge">embassy_time::Delay</code> 怎么都不工作, 添加了若干 debug 打印之后才发现, <code class="language-plaintext highlighter-rouge">embassy_time::Delay</code> 内部使用 <code class="language-plaintext highlighter-rouge">embassy_time::Instant</code> 实现, 默认情况下会使用 <code class="language-plaintext highlighter-rouge">TIM2</code>.
而选择的 PWM 输出 pin 正好是 <code class="language-plaintext highlighter-rouge">TIM2_CH2</code>, 两者互相干扰, 导致 <code class="language-plaintext highlighter-rouge">Delay</code> 不工作.
目前类型系统还不能保证 <code class="language-plaintext highlighter-rouge">Delay</code> 和 <code class="language-plaintext highlighter-rouge">Pwm</code> 不会使用同一个 <code class="language-plaintext highlighter-rouge">TIM</code> 设备.
最终的解决方法是使用 <code class="language-plaintext highlighter-rouge">cortex_m::delay::Delay</code>, 这是一个基于 SYSTICK 的实现.</p>

<p>本位未介绍 Embassy 的多任务功能, 在代码仓库里有一个简单的按钮控制闪灯频率的例子 <code class="language-plaintext highlighter-rouge">src/bin/button-control-blinky.rs</code>.
多任务的时候需要有 <code class="language-plaintext highlighter-rouge">.await</code> 调用让出时间片.</p>

<h2 id="参考资料">参考资料</h2>

<ul>
  <li><a href="https://github.com/embassy-rs/embassy">Github: Embassy</a></li>
  <li><a href="https://embassy.dev/book/dev/index.html">Embassy Documentation</a></li>
  <li><a href="https://apollolabsblog.hashnode.dev/embedded-rust-embassy-gpio-button-controlled-blinking">Embedded Rust &amp; Embassy 系列教程</a></li>
  <li><a href="https://www.st.com/resource/en/datasheet/STM32WLE5.pdf">STM32WLE5.pdf</a></li>
</ul>]]></content><author><name>andelf</name></author><category term="blog" /><category term="embedded" /><category term="stm32" /><category term="embassy" /><category term="rust" /><category term="lora" /><summary type="html"><![CDATA[之前参与了 eet-china.com 的开发板测评活动, 申请的板子是 STM32WLE5 易智联 Lora 评估板(LM401-Pro-Kit), 正好 Rust Embassy 框架对 STM32WL 系列及其 SubGhz 有不错的支持, 所以打算用这套技术栈进行开发尝试.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://user-images.githubusercontent.com/72891/213959627-2d2dfd95-6b29-4770-a1ee-85eb81081acd.png" /><media:content medium="image" url="https://user-images.githubusercontent.com/72891/213959627-2d2dfd95-6b29-4770-a1ee-85eb81081acd.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">施阿姨的互联网 - Interview with Aunt Shi</title><link href="https://andelf.github.io/blog/2021/02/04/interview-with-aunt-shi/" rel="alternate" type="text/html" title="施阿姨的互联网 - Interview with Aunt Shi" /><published>2021-02-04T12:03:00+00:00</published><updated>2021-02-04T12:03:00+00:00</updated><id>https://andelf.github.io/blog/2021/02/04/interview-with-aunt-shi</id><content type="html" xml:base="https://andelf.github.io/blog/2021/02/04/interview-with-aunt-shi/"><![CDATA[<p>这是几年前田野调查时候的一篇访谈稿。最近的聊天室热，让我想起了这个有意思的阿姨。</p>

<p>在一个小村子的路口小卖店，看到一位略残疾腿脚不方便的阿姨极其熟练地单指打字聊天，操作着在线聊天室服务端软件，
同时管理虚拟摄像头播放的擦边球女主播视频。可想当时我有多震惊。于是有了这遍访谈。</p>

<h2 id="正文">正文</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>title: 施阿姨的互联网
时间: 7月22日 下午
地点: XQ村村口小卖店
访谈人: Mono
被访谈人: 施阿姨
整理汇总: Mono
整理时间: 7/26
版本: v3
</code></pre></div></div>

<p>施阿姨。XQ村路口小卖店老板，56岁，似乎残疾。中午买水时见到她对着两台电脑的屏幕熟练操作，很是惊异，于是下午去做问卷和访谈。</p>

<p>访谈时，他的老公刚要外出。她卧坐在椅子上，眼睛时不时回头看两台电脑的屏幕（一台台式机，一台笔记本，均WinXP操作系统），打开的是视频聊天室的应用程序，能看到长长的在线用户列表和正在直播的视频窗口，她时不时用右手单手中指打出一句话和聊天室的网友互动，打字速度还挺快。每隔一会她还切换到一个类似老虎机到网络赌博程序，去查看状态。</p>

<p>访谈中了解到，施阿姨今年56岁，村里的普通农户。她弟弟在上海市的一家医院里工作，收入还可以，各方面也有一定的人脉，给施阿姨棒过不少忙。施阿姨的丈夫今年59岁，似乎不太会说话，不在家里做主的样子，没几分钟就出门去村北的蔬菜大棚里做工。丈夫的父母都已去世，施阿姨的母亲还健在，每天在家里给施阿姨和她老公做饭，平日里他们两口回家时间都略晚。施阿姨的儿子在上海上班。</p>

<p>早在80年代末，施阿姨就开始做裁缝，用缝纫机帮人加工衣服，她自豪地说，最多时候一年能有一万多收入，96年家里建的3层楼房就是用自己做衣服的钱盖的。但是95年后，人们的消费习惯逐渐发生变化，更多直接购买品牌衣服而不是买布料找裁缝加工，施阿姨的裁缝生意一天不如一天。</p>

<p>这时候，施阿姨借用了亲戚家在村路口的地，盖了一间屋子做小卖店，当时卖香烟很赚钱，但香烟需要烟草局的许可，施阿姨等了很久也没消息，一两年后听说上海市区比她晚申请烟草专卖许可的都办了下来，就托弟弟去崇明县烟草局去质问，之后才办了下来，但这时候烟草利润已经没有当年高，生意依旧一般。近几年施阿姨的小卖店每年大概有6000左右的收入。</p>

<p>同时在95年左右，施阿姨的股骨头出了问题，具体哪年做的置换已记不得，右腿（猜是）无法抬起正常走路，残疾人助力车停在小卖店里。阿姨说她当时申请残疾证也是费了好大周折，最后不得已通过弟弟出面，找人花了一万多才办了下来。谈到此，施阿姨感叹说，其实上面政府的政策是好的，残疾（人）补助不少，民政部门每月还发粮油，但到了下面，就不为老百姓考虑了，明明家里有钱开着车天天浪的人办下来了残疾证，真正残疾的人却办不下来。</p>

<p>施阿姨的互联网+，要从她弟弟说起，她弟弟家境宽裕，早在九十年代就置办了电脑，后来因更新换代，把旧电脑淘汰给了她，而她只有初中文化水平，且不会普通话（打字拼音完全不会），所以电脑就放在自己的小卖店里，供自己儿子使用。</p>

<p>后来村里有小孩看到她这里有电脑，就来玩，给她按小时计费，在她的电脑上装了很多游戏，也因此电脑经常中病毒出故障。那时候相当于只有一台电脑的黑网吧。后来施阿姨觉得对这些小孩的家长有愧，同时电脑也经常坏，就停下了黑网吧的生意。儿子后来出去上学，也用不到电脑，所以电脑就闲置了一段时间。（2000年左右）</p>

<p>而后，村里有一个在中学教书的王老师，看到施阿姨家里有电脑能上网，就给施阿姨介绍了QQ，教她网上聊天。一开始施阿姨不会打字，就用语音或者半天打一个字（因为普通话不会，所以拼音输入往往找不到字），同时也买了摄像头。</p>

<p>施阿姨是一个很爱学习东西的人。为了克服打字困难，她找来自己的外甥，将常用字和拼音写下来，挂在电脑背面的墙上，每天对着学习。没过几月，王老师再和施阿姨聊天，惊讶于施阿姨流畅的打字速度（虽然只是用一个指头敲键），敬佩不已。</p>

<p>此外，施阿姨的电脑每次出故障或是有问题，都是邻居家一个学电脑的小伙子解决的，小伙子很热心，说阿姨你会用就行了，这些我给你修。但是阿姨不愿意，比如装系统的时候，就要看着，一步步把步骤记下来，自己摸索。施阿姨还说，自己还会拆装电脑，电脑不亮的时候，什么显卡内存啊都拆了下来然后擦擦灰装起来就能好。（我当时听到这些也是惊到了）</p>

<p>07、08年股市疯涨的时候，施阿姨在弟弟的鼓动下，学起了炒股，当时也是每天盯K线，她以试探的心态投了2万，最多的时候涨到了6、7万，但后来被套牢。也就再没去折腾炒股。</p>

<p>说起视频聊天室，施阿姨说是一开始因为聊天打字太慢，语音视频聊天更方便，所以买了摄像头、耳机话筒。后来QQ上有一个网友，上海的，让她下载个软件，说带她去视频聊天室玩玩，她觉得很新鲜。一开始，都是别人教她怎么下载，注册，进入聊天室。在聊天室里可以排麦（聊天室同时一般只有很少的人可以语音，所以其他人需要按顺序排麦克风，由聊天室房主负责管理），唱歌，送花（虚拟道具）等等。最好玩的时候，一晚上她们一帮人能唱三四十首歌。</p>

<p>后来施阿姨就自己一个去各种聊天室逛，也逐渐萌生了自己做房主开聊天室的念头。她在网上聊天室里认识了一个71岁的老阿姨，在这方面是高手，经验丰富，这位老阿姨教施阿姨申请到了聊天室房间（需要一笔钱，才能拥有自己的房间），还协助施阿姨配置了新的电脑（视频聊天室需要转编码，需要性能稍微好的电脑）。</p>

<p>刚开始的时候，施阿姨的聊天室没多少人。而这类视频聊天室的模式是这样：网站提供视频直播服务器和视频直播软件，集中管理视频直播室的帐号和虚拟道具。虚拟道具即聊天室中用于相互赠送的鲜花、跑车等礼物。虚拟道具需要从网站的平台充值获取。每个聊天室都需要房主（在聊天室内被称为老大）来开启，房主需要向聊天室平台一次性缴纳费用，获得开聊天室的资格。聊天室中所有人的充值消费房主从中抽成，获得收益。部分视频聊天室还有在线赌博功能，虚拟货币流水更高。</p>

<p>视频聊天室往往具有集聚效应，即原本热闹的聊天室会更热闹。所以吸引参与者成了聊天室房主的首要任务。所以有的聊天室房主就会通过色情内容吸引成员，增加用户量。而施阿姨一开始是让老阿姨帮忙“挂聊天室”，赚取人气。所谓“挂聊天室”其实是用“马甲”帐号，从网上下载漂亮女主播的视频片段，然后通过模拟摄像头软件，在自己的聊天室内虚拟出一个漂亮的女主播，同时用帐号和房间内的用户互动，拉高人气。</p>

<p>那位71岁的老阿姨在这方面更有经验，帮施阿姨挂没多久后，聊天室的人气就来了，每天高峰大概有几百人在线。施阿姨也能通过道具充值提成获取一些收益。但施阿姨说，她和别人不一样，她获得到的金币（其中某平台，100万金币能换60元人民币）最后又通过各种方式返给了聊天室的参与者，发发小礼物等等，所以她的聊天室人气不错，大家都觉得她是个实在人，都叫她老大，或者老阿姨。</p>

<p>这时候来看，施阿姨更多把这样一个打监管擦边球的、具有获利性质的网络赌博平台当作了自己另一个社交圈子交流的工具。她在网上会和各种年龄段的人闲聊，比如和同时残疾人的网友聊聊政府补助的事情一类。</p>

<p>但较早较广接触网络，明显让施阿姨有了更大的眼界。谈起网络色情，阿姨说，有些小伙子来问她聊天室有没有不穿衣服女人那种视频，她说，都是人身上长得有什么好看的。谈起网络病毒，阿姨讲了她的一次经历，曾经有网友给她发了个文件，叫聚会照片，她打开后，桌面就弹出一个披长头发流血的女人照片，当时把她吓得半死，而且电脑之后也无法启动了。找来邻居家小伙子修好了电脑之后，她从此再也不接陌生人的文件，熟人也要看是不是本地的才会去看。</p>

<p>她家附近有个邻居也很好奇，但是人经常在上海住，想找机会让她教怎么开视频聊天室。而其他邻居对她的评价是，就知道买电脑玩电脑。</p>

<p>很多时候在考虑，互联网的即时、多媒体的社交方式到达农村到底会催生一种什么样的亚文化现象？例如前段时间很火爆的“快手”App，山东老阿姨吃日光灯管、年轻小伙子用鞭炮炸裤裆、残疾姑娘晒自己的打扮、搞怪装精神病的各种丑角、维修农机的小伙子自制各种新奇玩意、叠扑克牌、叠银币等等等等。实际上大部分是基于交流和“被注意到”的需求，当然也不排除部分也被一些小集团控制，编排节目，制作视频，炒作环节一应俱全的产业链。</p>

<p>（快手App已经是全国网络流量前几名的应用了，它的早期推广方式是和华为、酷派、步步高等国产手机在县城及以下的营销网点合作，直接预装。）</p>

<p>施阿姨也许只是孤例，纯流水帐记录，供大家思考。为何视频聊天室这种似乎已经在大中城市过气很久的互联网应用，却可以占有部分三四线城镇及农村的市场，得到生存。</p>

<p>参考：两个网站 <code class="language-plaintext highlighter-rouge">ht tp: / /w ww.99 dzr.com/</code> 大自然娱乐、 <code class="language-plaintext highlighter-rouge">ht tp:/ /w ww.78 90 xy.com/</code> 丰彩人生，还有个未知来源的游戏大厅，实际上是类似在线老虎机的样式，不停地转动切换下一个中奖的商标，可以看到下注量其实很高，单个商标下注在百万金币左右。网站均是未备案，注册地在二线城市。</p>]]></content><author><name></name></author><category term="blog" /><category term="interview" /><summary type="html"><![CDATA[这是几年前田野调查时候的一篇访谈稿。最近的聊天室热，让我想起了这个有意思的阿姨。]]></summary></entry><entry><title type="html">Play with 2.13 inch E-Ink display</title><link href="https://andelf.github.io/blog/2021/01/14/play-with-2-13-inch-e-ink-display/" rel="alternate" type="text/html" title="Play with 2.13 inch E-Ink display" /><published>2021-01-14T17:24:00+00:00</published><updated>2021-01-14T17:24:00+00:00</updated><id>https://andelf.github.io/blog/2021/01/14/play-with-2-13-inch-e-ink-display</id><content type="html" xml:base="https://andelf.github.io/blog/2021/01/14/play-with-2-13-inch-e-ink-display/"><![CDATA[<p>故事从买屏幕说起。</p>

<p>无聊逛咸鱼，发现有便宜的电子墨水屏，这玩意正常价格大几十，而咸鱼一片 2.13 寸模块只需要 15 块钱人民币。</p>

<p>是的，还等啥，先来几片凑个包邮。</p>

<p>了解到之所以这么便宜，是因为实际上是拆机屏，拆的是电子价签。来自一茬又一茬倒闭的超市和便利店。</p>

<h2 id="背景">背景</h2>

<p>电子墨水屏，也叫 E-ink, 墨水屏（瓶），电子纸，也简写为 EPD(Electronic Paper Display)。</p>

<p>和你用来压泡面的 Kindle 的屏幕是一个东西。只不过你的 Kindle 屏幕更大素质更高，而超市价签要小很多，相对低成本。</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Electronic_paper_%28Side_view_of_Electrophoretic_display%29_in_svg.svg/2560px-Electronic_paper_%28Side_view_of_Electrophoretic_display%29_in_svg.svg.png" alt="E-Ink technology" /></p>

<p>如上来自维基，原理一目了然。</p>

<p>不需要扯什么 gate 什么的，每个像素是一个小胶囊，顶部是公共 \(V_{com}\) 电压，透明。
底面是驱动芯片在屏幕每一行每一列像素的输出电压，可正可负（相对于 \(V_{com}\)），胶囊内部是对电场方向有反应的带电颜色微粒。
不同电压不同时长作用下，胶囊顶部上的微粒分布情况不同，肉眼看到的像素深浅就不同。</p>

<p>屏幕的驱动芯片，和我们常见的 IC 芯片那种黑色块带引脚是不同的，屏幕驱动芯片一般和屏幕一起封装，
对应屏幕的行列有输出。对外暴露接口，物理上一般是排线。</p>

<h2 id="准备开搞">准备开搞</h2>

<p>屏幕模块到手。显示“微雪电子”，那当然是不可能的，这只是因为默认用了微雪的示例代码出厂测试。
墨水屏的特点就是断电画面驻留，也可以说保持显示状态不需要供电。</p>

<p><img src="https://user-images.githubusercontent.com/72891/104638297-f5b6e800-56e0-11eb-93d6-0bc0fde0d475.jpg" alt="Boards" /></p>

<p>合影是一只凑单的 STM32F4 板子（本例未用到），一只 ESP8266（就准备用它来驱动屏幕了），和屏幕模块（主角）。</p>

<p>一共需要八根线驱动。熟悉的 SPI + CS + DC 式，和多数 SPI 接口的 LCD / TFT-LCD 屏幕接口类似。</p>

<p>不同的是多了一个 BUSY pin，这是墨水屏特有的输出信号，表示屏幕正在刷新，其他操作需要 MCU 延后。</p>

<p>告知该模块兼容微雪 2.13 寸黑白屏幕 v1 版。参数如下:</p>

<ul>
  <li>尺寸： 2.13 inch</li>
  <li>外形尺寸（裸屏）：59.2mm × 29.2mm × 1.05mm</li>
  <li>显示尺寸：48.55mm × 23.71mm</li>
  <li>工作电压：3.3V/5V</li>
  <li>通信接口：SPI</li>
  <li>点距：0.194*0.194</li>
  <li>分辨率：250*122</li>
  <li>显示颜色：黑、白</li>
  <li>灰度等级：2</li>
  <li>局部刷新 ：0.3s</li>
  <li>全局刷新 ：2s</li>
  <li>刷新功耗 ： 26.4mW(typ.)</li>
  <li>待机功耗 ：&lt;=0.017mW</li>
</ul>

<p>查询模块手册，得知该显示屏驱动芯片是 IL3895, 来自 Good Display(大连佳显)。
屏幕排线上有型号 HINK-E0213A04-G01(HINK-E0213-G01).</p>

<h3 id="esp8266">ESP8266</h3>

<p>ESP8266 算是较推荐的墨水屏之友，IO 接口不多但够用，带 WiFi 功能, 适合做这类显示屏小制作。
可以轻易找到各类天气时钟等代码。</p>

<p>推荐编程环境 Arduino. 省事。需要安装 <a href="https://github.com/esp8266/Arduino">ESP8266 Board Support 库</a>.</p>

<p>我这里的 ESP8266 板子是一只 NodeMCU DevKit 兼容板。最普通不过，但比较麻烦的是它的管脚标签和标准的 ESP8266 GPIO
之间有一个映射关系。</p>

<p><img src="https://user-images.githubusercontent.com/72891/104639665-a2de3000-56e2-11eb-9396-04cf946880bd.png" alt="NodeMCU GPIOs" />
(ref: <a href="https://www.electronicwings.com/nodemcu/nodemcu-gpio-with-arduino-ide">https://www.electronicwings.com/nodemcu/nodemcu-gpio-with-arduino-ide</a>)</p>

<p>搞清楚映射关系，写代码就不会错了。</p>

<p>官方有出售专门的 ESP8266 驱动板，集成了 ESP8266, 只需要按照相同的接线，即可使用官方例程。</p>

<p>接线方式:</p>

<table>
  <thead>
    <tr>
      <th>EPD board</th>
      <th style="text-align: right">NodeMCU pin</th>
      <th style="text-align: right">ESP8266 pin</th>
      <th style="text-align: right">description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>BUSY</td>
      <td style="text-align: right">D1</td>
      <td style="text-align: right">GPIO5</td>
      <td style="text-align: right">屏幕刷新忙</td>
    </tr>
    <tr>
      <td>RES/RST</td>
      <td style="text-align: right">D4</td>
      <td style="text-align: right">2</td>
      <td style="text-align: right">复位</td>
    </tr>
    <tr>
      <td>DC</td>
      <td style="text-align: right">D2</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">Data/Command 信号</td>
    </tr>
    <tr>
      <td>CS</td>
      <td style="text-align: right">D8</td>
      <td style="text-align: right">15</td>
      <td style="text-align: right">片选</td>
    </tr>
    <tr>
      <td>CLK/SCK</td>
      <td style="text-align: right">D5</td>
      <td style="text-align: right">14</td>
      <td style="text-align: right">SPI 时钟</td>
    </tr>
    <tr>
      <td>DIN/SDA</td>
      <td style="text-align: right">D7</td>
      <td style="text-align: right">13</td>
      <td style="text-align: right">SPI MOSI</td>
    </tr>
  </tbody>
</table>

<p>常识 VCC = 3.3V, GND 接地。</p>

<h3 id="屏幕官方例程">屏幕官方例程</h3>

<p>虽然不是官方正版，只是个拆机屏模块，但好在屏幕型号一致，全兼容微雪官方例程。</p>

<ul>
  <li><a href="https://www.waveshare.net/wiki/E-Paper_ESP8266_Driver_Board">官方 ESP8266 驱动板及例程</a></li>
</ul>

<p>官方例程解压后子目录复制到 Arduino libraries 目录。</p>

<p>然后就可以直接从 Arduino 的 File-&gt;Examples 菜单打开例程。</p>

<p>例程压缩包中的 <code class="language-plaintext highlighter-rouge">src/</code>, <code class="language-plaintext highlighter-rouge">extras/</code> 目录，其实就是官方驱动，所有的不同型号屏幕的例程，都依赖驱动库。</p>

<p>该款屏幕的例程是 <code class="language-plaintext highlighter-rouge">waveshare-e-Paper/epd2in13-demo</code>.</p>

<p>设备选择 NodeMCU 或 Generic EPS8266, 编译上传例程。</p>

<p>屏幕噌噌闪动几下，清屏后，开始执行例程。</p>

<p><img src="https://user-images.githubusercontent.com/72891/104642461-e4bca580-56e5-11eb-9a8f-ea2c7a38da22.jpg" alt="Official Demo" /></p>

<p>屏幕右下角的时间显示，秒位在不停变动。</p>

<p>例程中可以看到基础绘图，中英文数字显示，时间显示（局部刷新功能）。照着改改可以整出不少好玩的。
再加上 ESP8266 的 WiFi 功能，想象力足够。</p>

<h3 id="end-of-get-start">End of get start</h3>

<p>至此，屏幕跑通。画画图，改改文字，皆大欢喜。🤪</p>

<hr />

<p>以下是干货部分。需要知识预备:</p>

<ul>
  <li>二进制位运算知识</li>
  <li>数字电子基础</li>
  <li>电路基础</li>
  <li>计算机图形学基础概念</li>
</ul>

<h2 id="中文显示">中文显示</h2>

<p>看到例程中直接有中文显示语句，暗爽不是？</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Paint_DrawString_CN</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s">"你好abc"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font12CN</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
<span class="n">Paint_DrawString_CN</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="s">"**电子"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font24CN</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
</code></pre></div></div>

<p>于是改成“你好世界”，然而只见“你好”不见“世界”。</p>

<p>是的，官方例程（驱动）里没有完整字库，只有测试时候屏幕上出现的那几个汉字。所以需要加字库！</p>

<p>我们能接触到的绝大多数屏幕，都是点阵屏。
所谓字库，就是字符编码到图形象素点的映射。所以这里要增加缺失的字型，怎么整？</p>

<p>先看看官方怎么实现的。</p>

<p>当然，字库还有其他意思，在手机维修界，字库也指 ROM 芯片。
这是历史遗留问题了，当年字库都存在专门的芯片里。
字库和字库芯片在很多场合不区分。这里叫字库，其实是字模，即汉字的模型，对应的二进制数据。</p>

<h3 id="官方驱动字库格式">官方驱动字库格式</h3>

<p>找到驱动目录 <code class="language-plaintext highlighter-rouge">~/Documents/Arduino/libraries/esp8266-waveshare-epd</code>.</p>

<p>在 <code class="language-plaintext highlighter-rouge">src/</code> 目录下，找到若干 <code class="language-plaintext highlighter-rouge">font*.cpp</code>, <code class="language-plaintext highlighter-rouge">font*.h</code> 文件就是字库了。</p>

<p>例如 <code class="language-plaintext highlighter-rouge">font12CN</code> 字体，微软雅黑 12:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">CH_CN</span> <span class="n">Font12CN_Table</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="cm">/*--  文字:  你  --*/</span>
    <span class="cm">/*--  微软雅黑12;  此字体下对应的点阵为：宽x高=16x21   --*/</span>
    <span class="p">{</span><span class="s">"你"</span><span class="p">,</span>
    <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x1D</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x1D</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span>
    <span class="mh">0x3F</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x7E</span><span class="p">,</span><span class="mh">0x76</span><span class="p">,</span><span class="mh">0xF8</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0xFB</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0xFB</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0x3F</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x3F</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span>
    <span class="mh">0x38</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">},</span>
    <span class="c1">// ...</span>
    <span class="p">{</span><span class="s">"A"</span><span class="p">,</span>
    <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x1F</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x1F</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x1F</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x7F</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span>
    <span class="mh">0xE0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">},</span>
<span class="p">};</span>

<span class="n">cFONT</span> <span class="n">Font12CN</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">Font12CN_Table</span><span class="p">,</span>
  <span class="k">sizeof</span><span class="p">(</span><span class="n">Font12CN_Table</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CH_CN</span><span class="p">),</span>  <span class="cm">/*size of table*/</span>
  <span class="mi">11</span><span class="p">,</span> <span class="cm">/* ASCII Width */</span>
  <span class="mi">16</span><span class="p">,</span> <span class="cm">/* Width */</span>
  <span class="mi">21</span><span class="p">,</span> <span class="cm">/* Height */</span>
<span class="p">};</span>
</code></pre></div></div>

<p>明显看到中文字库分两部分，一部分是字型表 <code class="language-plaintext highlighter-rouge">Font12CN_Table</code>, 一部分是配置结构体 <code class="language-plaintext highlighter-rouge">Font12CN</code>.
字型表即字的象素点二进制表示。因为中文字符较多，为节省空间字库只有例程所需汉字，
所以每条记录第一个元素是中文汉字，用于索引。
而对于英文字库来说，字符是连续的，且总体占用空间较小，一般使用连续字节块表示。</p>

<p>从配置结构我们可以得知，该字型宽 16 位，高 21 位，即两个字节表示一行象素，一共 21 行。
我们可以写个脚本展示下:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">char</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x1D</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x1D</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span>
    <span class="mh">0x3F</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x7E</span><span class="p">,</span><span class="mh">0x76</span><span class="p">,</span><span class="mh">0xF8</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0xFB</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0xFB</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0x3F</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x3F</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span>
    <span class="mh">0x38</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">]</span>
<span class="c1"># group by 2 -&gt; to 0-1 -&gt; padding with 0
</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">%08d%08d</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="nf">bin</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]),</span> <span class="nf">int</span><span class="p">(</span><span class="nf">bin</span><span class="p">(</span><span class="n">r</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]))</span> <span class="nf">for </span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">char</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">char</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])]</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div>

<p>得到命令行下输出:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>................
................
................
................
...***.***......
...***.**.......
..***.**********
..***.**.....***
..******.***.***
.******..***.**.
*****....***....
*****.*********.
*****.*********.
..******.***.***
..******.***.***
..*****..***..**
..***....***....
..***....***....
..***.*****.....
................
................
</code></pre></div></div>

<p>一个汉字被解析了出来，以点阵的方式展示。上方和下方的 0, 用于行间距。
在实际应用中可以省去，节约空间。</p>

<p>而配置中的 ASCII Width 11 表示该中文字体中的 ASCII 字符宽度。因为半角全角的关系，
中文字体中的半角英文字符(ASCII)相对来说宽度都不足一字，为了显示效果，不留过多字间距，
丢弃多余位不用，所以这里单独有一个配置项。</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">char</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x1F</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x1F</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
     <span class="p">...:</span>     <span class="mh">0x1F</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x7F</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span>
     <span class="p">...:</span>     <span class="mh">0xE0</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">]</span>
<span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">%08d%08d</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="nf">bin</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]),</span> <span class="nf">int</span><span class="p">(</span><span class="nf">bin</span><span class="p">(</span><span class="n">r</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]))</span> <span class="nf">for </span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">char</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">char</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])]</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">))</span>

<span class="c1"># outputs:
</span><span class="sh">"""</span><span class="s">
</span><span class="gp">...</span><span class="p">..........</span><span class="bp">...</span>
<span class="p">.............</span><span class="bp">...</span>
<span class="p">.............</span><span class="bp">...</span>
<span class="p">.............</span><span class="bp">...</span>
<span class="p">.............</span><span class="bp">...</span>
<span class="p">....</span><span class="o">***</span><span class="p">......</span><span class="bp">...</span>
<span class="p">...</span><span class="o">*****</span><span class="p">.....</span><span class="bp">...</span>
<span class="p">...</span><span class="o">*****</span><span class="p">.....</span><span class="bp">...</span>
<span class="p">...</span><span class="o">*****</span><span class="p">.....</span><span class="bp">...</span>
<span class="p">..</span><span class="o">***</span><span class="p">.</span><span class="o">***</span><span class="p">....</span><span class="bp">...</span>
<span class="p">..</span><span class="o">***</span><span class="p">.</span><span class="o">***</span><span class="p">....</span><span class="bp">...</span>
<span class="p">.</span><span class="o">***</span><span class="p">...</span><span class="o">**</span><span class="p">....</span><span class="bp">...</span>
<span class="p">.</span><span class="o">*********</span><span class="p">...</span><span class="bp">...</span>
<span class="p">.</span><span class="o">***</span><span class="p">...</span><span class="o">***</span><span class="p">...</span><span class="bp">...</span>
<span class="o">***</span><span class="p">.....</span><span class="o">***</span><span class="p">..</span><span class="bp">...</span>
<span class="o">***</span><span class="p">.....</span><span class="o">***</span><span class="p">..</span><span class="bp">...</span>
<span class="o">***</span><span class="p">.....</span><span class="o">***</span><span class="p">..</span><span class="bp">...</span>
<span class="p">.............</span><span class="bp">...</span>
<span class="p">.............</span><span class="bp">...</span>
<span class="p">.............</span><span class="bp">...</span>
<span class="p">.............</span><span class="bp">...</span>
<span class="sh">"""</span>
</code></pre></div></div>

<h3 id="生成字库">生成字库</h3>

<p>搞明白了原理和格式，接下来就是生成所需的字库了。网上有非常多的 Windows 下小工具可以做。
但我这么肝，就自己写了。代码来自之前给 TFT-LCD 写的抠字模小脚本儿。</p>

<p>原理很简单，用 <code class="language-plaintext highlighter-rouge">Pillow/PIL</code> 即可。先把需要的字画在图片上，然后读取象素点，移位生成对于字节表示。
最后最好直接生成 C 代码，就万事大吉。</p>

<p>而字体选择，一般使用点阵字体而非矢量字体，矢量字体在渲染的时候边缘都是带灰阶的，
如果忽略灰阶直接二值化，会导致最终字型锯齿严重，丑。</p>

<p>为了方便处理，这里选用开源的等宽字体<a href="http://wenq.org/wqy2/index.cgi?Unibit">文泉驿点阵字体 Unibit</a>.
以中文点阵最常见的 16x16 输出。正好两个字节宽，16 行高，一个汉字 32 字节。
英文字符也正好是中文字符宽度的一半。</p>

<p>当然你可以随便从系统找个中文字体。需要注意的是，为了在黑白（无灰度）屏幕上达到最好效果，需要位图字体(bitmap font, raster font, pixel font),
否则矢量字体在渲染的过程中会有灰阶边缘，最终屏幕效果锯齿明显。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装依赖</span>

pip3 <span class="nb">install </span>Pillow

<span class="c"># 用于字体缩放的依赖库</span>
brew <span class="nb">install </span>libraqm
</code></pre></div></div>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>
<span class="kn">import</span> <span class="n">PIL.features</span>

<span class="c1"># brew install libraqm
</span><span class="k">assert</span> <span class="n">PIL</span><span class="p">.</span><span class="n">features</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="sh">'</span><span class="s">raqm</span><span class="sh">'</span><span class="p">),</span> <span class="sh">"</span><span class="s">libraqm required</span><span class="sh">"</span>

<span class="c1"># 画布大小
</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="c1"># 黑白格式
</span><span class="n">FORMAT</span> <span class="o">=</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span>
<span class="n">BG</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">FG</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Y offset, 多数字体有自带行间距，可以用此参数消除行间距
</span><span class="n">YOFF</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># or -1
</span>

<span class="n">CHARS</span> <span class="o">=</span> <span class="sh">"</span><span class="s">晴天卧槽可以了！你好世界最怕你一生碌碌无为，还安慰自己平凡可贵。雾霾</span><span class="sh">"</span>
<span class="n">CHARS</span> <span class="o">=</span> <span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">CHARS</span><span class="p">)))</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>

<span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="p">.</span><span class="nf">truetype</span><span class="p">(</span><span class="sh">"</span><span class="s">Unibit.ttf</span><span class="sh">"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="p">.</span><span class="nc">Draw</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

<span class="c1"># 代码段用于检查字体渲染
# draw.text((0, YOFF), CHARS, font=font, fill=FG, language='zh-CN')
# im.save('font.png')
# im.show()
</span>
<span class="n">draw</span><span class="p">.</span><span class="nf">rectangle</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="n">BG</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">CHARS</span><span class="p">):</span>
    <span class="n">charmap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">draw</span><span class="p">.</span><span class="nf">text</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">YOFF</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">FG</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">im</span><span class="p">.</span><span class="nf">getpixel</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>

        <span class="n">charmap</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">charmap</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>

    <span class="n">draw</span><span class="p">.</span><span class="nf">rectangle</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="n">BG</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">''</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'"</span><span class="s">{}</span><span class="sh">"</span><span class="s">, {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="sh">"</span><span class="s">0x%02x</span><span class="sh">"</span> <span class="o">%</span> <span class="n">c</span><span class="p">,</span> <span class="n">charmap</span><span class="p">))),</span> <span class="n">end</span><span class="o">=</span><span class="sh">""</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">},</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>直接输出 C 代码片段:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"一"</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
<span class="p">{</span><span class="s">"生"</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
<span class="p">{</span><span class="s">"碌"</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span>
<span class="p">{</span><span class="s">"碌"</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span>
<span class="p">{</span><span class="s">"无"</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
<span class="p">{</span><span class="s">"为"</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">},</span>
</code></pre></div></div>

<h3 id="使用字库">使用字库</h3>

<p>要想使用字体，我们需要新建一个字体 <code class="language-plaintext highlighter-rouge">.h</code> 文件，就叫 <code class="language-plaintext highlighter-rouge">ch_font.h</code>，在项目目录即可，不需要修改驱动库:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include</span> <span class="cpf">"fonts.h"</span><span class="cp">
</span>
<span class="k">const</span> <span class="n">CH_CN</span> <span class="n">Font16CN_Table</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span><span class="s">"一"</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"生"</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
    <span class="c1">// ... 这里写入剩余字型</span>
<span class="p">};</span>

<span class="n">cFONT</span> <span class="n">Font16CN</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">Font16CN_Table</span><span class="p">,</span>
  <span class="k">sizeof</span><span class="p">(</span><span class="n">Font16CN_Table</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CH_CN</span><span class="p">),</span>  <span class="cm">/*size of table*/</span>
  <span class="mi">8</span><span class="p">,</span> <span class="cm">/* ASCII Width */</span>
  <span class="mi">16</span><span class="p">,</span> <span class="cm">/* Width */</span>
  <span class="mi">16</span><span class="p">,</span> <span class="cm">/* Height */</span>
<span class="p">};</span>
</code></pre></div></div>

<p>使用:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="cp">#include</span> <span class="cpf">"cn_font.h"</span><span class="cp">
</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">Paint_DrawString_CN</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="s">"卧槽可以了！"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font16CN</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>

    <span class="n">EPD_2IN13_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<p>效果大概是(忘记拍照了，这里是另外一个开源字体 Sarasa):</p>

<p><img src="https://user-images.githubusercontent.com/72891/104816620-5b2ce500-5857-11eb-92fe-2dbd3add8eda.jpg" alt="Chicken soup" /></p>

<p>是的，毒鸡汤。至此中文字体搞定，其他 CJK 字体同理。</p>

<p>而英文字体就更简单了，参考其他驱动中的 <code class="language-plaintext highlighter-rouge">font*</code> 文件即可。字型生成代码略改即可使用。</p>

<p>具体制作中可以混合中英文大小字体，还可以选择例如数码管字体等方案，完成布局。</p>

<p><img src="https://user-images.githubusercontent.com/72891/104816434-21a7aa00-5856-11eb-9dd3-dc05255c8cdb.jpg" alt="Mixed Font" /></p>

<h2 id="其他显示需求">其他显示需求</h2>

<h3 id="图片显示">图片显示</h3>

<p>墨水屏最烂大街的应用，大概就是天气时钟了，各式各样，各种尺寸。</p>

<p>显示文字信息的事情，上面我们已经通过自定义字库搞定了，
发挥想象力可以搞出诸如数码管字体，手写字体，等各种适合在墨水屏上实现的显示效果。</p>

<p>但问题来了，我想搞个天气图标符号显示，比如，<a href="http://www.weather.com.cn/">中国天气网</a> 那样的。</p>

<p><img src="https://user-images.githubusercontent.com/72891/104684474-165c5d80-5734-11eb-8850-9216e07a9dca.png" alt="weather" /></p>

<p>官方例程里其实有全屏图片显示例子，可以看到相关的调用函数 <code class="language-plaintext highlighter-rouge">Paint_DrawBitMap</code>。
同时驱动库里也提供了 <code class="language-plaintext highlighter-rouge">Paint_DrawImage(buf, x_start, y_start, img_width, img_height)</code>
函数用于在任意位置显示任意大小图片。</p>

<p>看一眼驱动库里 <code class="language-plaintext highlighter-rouge">Paint_DrawImage</code> 代码，好像哪里不对，只支持宽度象素是 8 倍数的图片。
改也简单，用 <code class="language-plaintext highlighter-rouge">Paint_SetPixel</code> 函数替换即可，简单的位运算。</p>

<p>现在问题是怎么生成一张用于显示的图片。其实和上面的字库非常类似，就是用二进制位去映射象素点。
然后生成 C 数组。甚至核心代码逻辑也差不多。</p>

<p>需要注意的是图片只能是黑白二值图。为方便库函数识别，也提前将图片宽度处理成 8 的整数倍。</p>

<p>图源，就取天气网那堆图标，原图是用 CSS offset 方式显示的，也就是所有图标在一张图片上，需要切下。</p>

<p>完整代码见 <a href="https://gist.github.com/andelf/acb0d317eef5d0cc8b7d53d4133c09c2">gist: crop-blue30.py</a>.
这里贴要点</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># RGBA 到 RGB 的转换
</span><span class="n">pix</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">im1</span><span class="p">.</span><span class="nf">getpixel</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
<span class="n">BG</span> <span class="o">=</span> <span class="mi">255</span> <span class="c1"># 背景是白色
</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">BG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">//</span> <span class="mi">255</span>
<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">BG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">//</span> <span class="mi">255</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">BG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">//</span> <span class="mi">255</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">255</span> <span class="c1"># alpha 通道置空，不透明度
</span>
<span class="n">im1</span><span class="p">.</span><span class="nf">putpixel</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 图像二值化,
</span><span class="n">im1</span> <span class="o">=</span> <span class="n">im1</span><span class="p">.</span><span class="nf">resize</span><span class="p">((</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">Image</span><span class="p">.</span><span class="n">LANCZOS</span><span class="p">)</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">im1</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">ImageFilter</span><span class="p">.</span><span class="n">SHARPEN</span><span class="p">)</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">im1</span><span class="p">.</span><span class="nf">convert</span><span class="p">(</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">Image</span><span class="p">.</span><span class="n">NONE</span><span class="p">)</span>
</code></pre></div></div>

<p>当然，你要是用 ImageMagick 或者 Photoshop 也一样可以。</p>

<p>然后把生成的二进制装入 C <code class="language-plaintext highlighter-rouge">uint8_t[]</code> 即可。</p>

<p>显示一个太阳:</p>

<p><img src="https://user-images.githubusercontent.com/72891/104686101-84565400-5737-11eb-9bf5-4e0347e1eb28.png" alt="image" /></p>

<p>因为二值化和缩放的关系，象素周围略有点腐蚀的感觉。
效果还行，考虑考虑界面元素布局，做个天气时钟足够了。</p>

<h3 id="局部刷新">局部刷新</h3>

<p>正常情况下在显示文字和图案的时候屏幕会连续从最黑到最白来回闪动几下，参考显示原理，
这里是为了避免残留墨水粒子影响显示效果，即消除残影的影响。
有使用过 Kindle 的同学对这点会比较清楚，一般是翻页若干次全部刷新一次。</p>

<p>官方例程中右下角有个时间显示，用到了局部刷新技术:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EPD_2IN13_Init</span><span class="p">(</span><span class="n">EPD_2IN13_PART</span><span class="p">);</span>
<span class="n">Paint_SelectImage</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>
<span class="c1">// ...</span>
<span class="n">Paint_ClearWindows</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">140</span> <span class="o">+</span> <span class="n">Font20</span><span class="p">.</span><span class="n">Width</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">90</span> <span class="o">+</span> <span class="n">Font20</span><span class="p">.</span><span class="n">Height</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
<span class="n">Paint_DrawTime</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sPaint_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>

<span class="n">EPD_2IN13_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>
</code></pre></div></div>

<p>首先以 <code class="language-plaintext highlighter-rouge">EPD_2IN13_PART</code> 方式重新初始化屏幕（不用清屏），然后就通过 <code class="language-plaintext highlighter-rouge">Paint_ClearWindows</code> 清除需要局部更新的矩形区域，
之后就可以使用各种绘图绘字符函数填写屏幕的这部分。最后调用 Display 上屏。</p>

<p>局部刷新的效果因屏幕体质不同各异，经常会遇到残影特别严重的时候。做小制作的时候也可以学习电纸书，局部刷新多次后全局刷新一次。</p>

<h2 id="再看显示原理">再看显示原理</h2>

<p>以上，基本介绍完了墨水屏的常见功能。已满足绝大部分需求。</p>

<p>回头再看显示原理，有了一开始介绍的小胶囊阵列结构，驱动怎么通过搞定显示的呢？这里以 2.13 寸显示屏的驱动 IC IL3895 为例。</p>

<h3 id="lut">LUT</h3>

<p>LUT, 即 Waveform Look Up Table(LUT), 是很多介绍电子墨水驱动文章的离不开的话题。</p>

<p>所谓的 LUT 功能，其实是驱动芯片的“可编程驱动电压波形”功能。即通过若干寄存器字节，
设置像素在不同状态转换情况下使用的底板电压高低的时序。该设置全局有效，针对全屏幕的任何一个像素的变动。
整个波形通过更新屏幕指令(MasterActivation = 0x20, Activate Display Update Sequence)触发，
此过程中 BUSY 信号有效，更新逻辑完成后, BUSY 信号结束。</p>

<p>例如数据手册中:</p>

<p><img src="https://user-images.githubusercontent.com/72891/104814031-a63efc00-5847-11eb-8fd4-8595a69ad1eb.png" alt="image" /></p>

<p>IL3895 芯片支持 10 个 phase 的波形，分别是 phase0A phase0B phase1A phase1B phase2A phase2B phase3A phase3B phase4A phase4B,
其中每个 phase 可以指定维持状态的时间周期数 TP.
每两个波形可以设置一个重复次数 RP.
在每个 phase, 都可以指定像素底板电压 VS 高低。不同电压级别驱动颜色微粒向不同方向运动，维持不同的时间，最终实现像素的黑白变化。</p>

<p>图表右侧的 XY=LL, XY=LH, … 表示不同的像素值变动情形。例如 HL 表示像素从白色变动到黑色, LL 表示像素在此次刷新中值没有变化。</p>

<p>以上的所有配置项按照固定格式，最终形成了 LUT 表，可以通过命令设置:</p>

<p><img src="https://user-images.githubusercontent.com/72891/104814577-b1475b80-584a-11eb-9cf5-3dcc9b559bf5.png" alt="image" /></p>

<p>而例程中的 <code class="language-plaintext highlighter-rouge">EPD_2IN13_Init(EPD_2IN13_FULL/PART)</code>, 其中最重要也是唯一的区别就是 FULL 和 PART 初始化时使用的 LUT 表不同。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">EPD_2IN13_lut_full_update</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">EPD_2IN13_lut_partial_update</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>
</code></pre></div></div>

<p>初始化后，每次显示更新，都会执行对应的 LUT 表时序。也就是说，全局刷新情况下的屏幕从全黑到全白好几次清空屏幕的动作，
就定义在这个 FULL 对应的 LUT 中。有兴趣的小伙伴可以解析下 <code class="language-plaintext highlighter-rouge">EPD_2IN13_lut_full_update</code>.</p>

<p>正因为有了 LUT 定义，屏幕以 <code class="language-plaintext highlighter-rouge">EPD_2IN13_PART</code> 方式初始化时，新显示内容不再需要全屏刷新后再显示，直接在原始状态进行绘制。</p>

<p>这里以 <code class="language-plaintext highlighter-rouge">EPD_2IN13_lut_partial_update</code> 为例介绍下实际 LUT 执行时候发生的动作。简单得多，以至于整个表只有 3 个非空字节，
对应 phase0A, phase0B, 其余 phase 设置因对应的 TP(period) 为 0, 不生效。所以只有两个 phase 的波形。</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/// LUT for partial update.</span>
<span class="nd">#[rustfmt::skip]</span>
<span class="k">pub</span> <span class="k">const</span> <span class="n">LUT_PARTIAL_UPDATE</span><span class="p">:</span> <span class="p">[</span><span class="nb">u8</span><span class="p">;</span> <span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">// VS, voltage in phase n</span>
    <span class="c1">// &lt;&lt;VS[0A-HH]:2/binary, VS[0A-HL]:2/binary, VS[0A-LH]:2/binary, VS[0A-LL]:2/binary&gt;&gt;</span>
    <span class="c1">// &lt;&lt;VS[0B-HH]:2/binary, VS[0B-HL]:2/binary, VS[0B-LH]:2/binary, VS[0B-LL]:2/binary&gt;&gt;</span>
    <span class="c1">// HL: white to black</span>
    <span class="c1">// LH: black to white</span>
    <span class="c1">// e.g. 0x18 = 0b00_01_10_00</span>
    <span class="mi">0x18</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="c1">// phase 0</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="c1">// phase 1</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="c1">// phase 4</span>
    <span class="c1">// padding</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span>
    <span class="c1">// RP, repeat counter, 0 to 63, 0 means run time = 1</span>
    <span class="c1">// TP, phase period, 0 to 31</span>
    <span class="c1">// &lt;&lt;RP[0]_L:3/binary, TP[0A]:5/binary&gt;&gt;</span>
    <span class="c1">// &lt;&lt;RP[0]_H:3/binary, TP[0B]:5/binary&gt;&gt;</span>
    <span class="mi">0x0F</span><span class="p">,</span> <span class="mi">0x01</span><span class="p">,</span> <span class="c1">// phase 0</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="c1">// phase 4</span>
    <span class="c1">// padding</span>
    <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span>
<span class="p">];</span>
</code></pre></div></div>

<p>如上，改写为 Rust 代码，加入详细注释，注释混搭假 Erlang 语法。</p>

<p>先看 VS 部分，即驱动电压部分。<code class="language-plaintext highlighter-rouge">0x18 = 0b00_01_10_00</code>, 按照格式拆出:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VS[0A-HL] = 01
VS[0A-LH] = 10

# 其他情况为 00
</code></pre></div></div>

<p>手册中有介绍 VS 格式:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00–VSS
01–VSH
10–VSL

分别是三种电压输出级别，其中 VSS 与顶版 VCOM 相等。相当于无电场存在。
VSH, VSL 分别会导致是两种不同的电场方向。
</code></pre></div></div>

<p>所以解读 phase0A 的配置即:</p>

<ul>
  <li>当像素点从白转黑时(HL), \(V_{pixel}\) 电压为 VSH</li>
  <li>当象素点从黑转白时(LH), \(V_{pixel}\) 电压为 VSL</li>
  <li>其他情况下，\(V_{pixel}\) 电压为 VSS, 由芯片手册可知, VSS = VCOM, 相当于无变化</li>
</ul>

<p>再来看 RP, TP 部分。需要将字节的高低位组合:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x0F = 0b000_01111
0x01 = 0b000_00001

所以得到
RP[0] = 0b000_000 = 0
TP[0A] = 0b01111 = 15
TP[0B] = 0b00001 = 1
</code></pre></div></div>

<p>如上提到, TP 为 0 时表示该 phrase 无效，所以上面说只有 phase0A, phase0B 两个 phase 有效。
RP = 0 是表示重复 1 次。</p>

<p>总结以上那么该 LUT 的逻辑是:</p>

<ul>
  <li>当像素点从白转黑时(HL), \(V_{pixel}\) 电压为 VSH, 持续 15 个周期，随后转 VSS, 持续一个周期</li>
  <li>当象素点从黑转白时(LH), \(V_{pixel}\) 电压为 VSL, 持续 15 个周期，随后转 VSS, 持续一个周期</li>
  <li>其他情况下，恒为 VSS</li>
  <li>以上逻辑执行 1 次</li>
  <li>单个周期文档中介绍时长为 \(T_{FRAME}\)</li>
</ul>

<p>所以似乎明了，所谓局部刷新，就是在像素点不变的时候，不做任何操作。
在像素翻转的情况下，执行一次给电压操作，随后静置少量时间。</p>

<p>而全刷新，可以很明显看到，前几个周期都是全置黑全置白的统一操作，为的是清屏。
之后才是处理不同像素状态变更的波形。</p>

<h4 id="idea">Idea</h4>

<p>持续电压 15 个周期，那么少一点会怎么样？</p>

<p>测试发现这样出图效果没那么黑，甚至是灰色。</p>

<p>所以似乎就有了在黑白墨水屏上实现灰度显示的方案。这里的黑白墨水屏，特指驱动手册中单个像素为 1 位的屏幕。即 1bpp(bit per pixel).</p>

<p>本文题头图，即为测试效果。</p>

<p>灰度显示的内容，另开坑讲。</p>

<h3 id="framebuffer">framebuffer</h3>

<blockquote>
  <p>A framebuffer (frame buffer, or sometimes framestore) is a portion of random-access memory (RAM) containing a bitmap that drives a video display.
It is a memory buffer containing data representing all the pixels in a complete video frame. – Wikipedia</p>
</blockquote>

<p>回到例程，可以看到屏幕初始化调用大概是:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EPD_2IN13_Init</span><span class="p">(</span><span class="n">EPD_2IN13_FULL</span><span class="o">/</span><span class="n">PART</span><span class="p">);</span>
<span class="n">EPD_2IN13_Clear</span><span class="p">();</span>

<span class="n">UBYTE</span> <span class="o">*</span><span class="n">BlackImage</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(...);</span>
<span class="n">Paint_NewImage</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">,</span> <span class="n">EPD_2IN13_WIDTH</span><span class="p">,</span> <span class="n">EPD_2IN13_HEIGHT</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
<span class="n">Paint_SelectImage</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>

<span class="c1">// ...</span>

<span class="n">EPD_2IN13_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>
</code></pre></div></div>

<p>阅读对应函数得知，这里创建了一个 <code class="language-plaintext highlighter-rouge">BlackImage</code> 字节数组做墨水屏的 framebuffer. 所有的绘图操作都只对这个 framebuffer 进行，
不和设备进行交互，直到调用 Display 才会进行实际的设备交互。</p>

<p>framebuffer 在 Display 被调用时，按照驱动芯片所设定的方向，比如按行，按列的方式，
一个个字节被从 MCU 传输到驱动芯片的内部的“显存”中，随后执行 LUT 更新逻辑。
驱动芯片会对比像素点的当前状态和目标状态，执行对应的 LH, HL, LL, HH 波形。
最终像素出现在屏幕上，完成显示。</p>

<h3 id="next">Next</h3>

<p>之后抽时间写写灰度显示相关的折腾过程。</p>

<p>和 Rust embedded-grahics 驱动的情况。</p>

<h2 id="参考">参考</h2>

<ul>
  <li>Waveshare 官方 store, <a href="https://www.waveshare.com/wiki/2.13inch_e-Paper_HAT">wiki</a></li>
  <li><a href="https://www.e-paper-display.com/download_detail/downloadsId=538.html">IL3895 数据手册</a></li>
  <li><a href="https://en.wikipedia.org/wiki/E_Ink">Wikipedia: E-Ink</a></li>
</ul>]]></content><author><name>andelf</name></author><category term="blog" /><category term="embedded" /><category term="epd" /><summary type="html"><![CDATA[故事从买屏幕说起。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://user-images.githubusercontent.com/72891/104635824-6825c900-56dd-11eb-8caa-d5eb00d11f70.jpg" /><media:content medium="image" url="https://user-images.githubusercontent.com/72891/104635824-6825c900-56dd-11eb-8caa-d5eb00d11f70.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Story of Year 2003</title><link href="https://andelf.github.io/blog/2021/01/01/story-of-year-2003/" rel="alternate" type="text/html" title="Story of Year 2003" /><published>2021-01-01T18:08:00+00:00</published><updated>2021-01-01T18:08:00+00:00</updated><id>https://andelf.github.io/blog/2021/01/01/story-of-year-2003</id><content type="html" xml:base="https://andelf.github.io/blog/2021/01/01/story-of-year-2003/"><![CDATA[<p>2003 竟然没找到张像样的照片。那时候生活没那么数码。还在用胶片。</p>

<p>其实更主要的原因是，整个世纪初的前几年，不曾拍过几张照片。或者出游，也是拍别人。</p>

<p>想讲讲 2003 的故事。其实这么久，能记得的，也都模糊到失真了。</p>

<h2 id="初三">初三</h2>

<p>那年初三。整个寒假在 Uncle Wang 家补课，说是补课，其实更像是托管。有英语和数学课。封闭管理。
他家用水不便，就记得那个寒假好像只洗了一两次头？
洗头这事，好说，当不洗的天数到达一定境界后，就已经感觉不到头发的存在了。</p>

<p>说起来万幸，还好有这一寒假的补课，不然中考大概率会考扯。</p>

<p>开学后就是紧张的中考前复习。依旧玩得昏天黑地。学校为了提高上线率，重新给两个实验班分了班，
二班一部分到我们一班，我班成绩靠后的去二班上课，两个班教学不同步，进度和教学内容都不太一样。</p>

<p>然后位置自己选，这可搞笑了，和一朋友自选搭了同桌，一起坐第一排。陕北方言把闲聊叫“谝”，
于是爱自习课说话的同学们各自封什么“谝王”，“谝圣”一类。形容的原话往往是，“那(ne)xxx太能谝了(liao4)，纯粹一谝x”。</p>

<p>那时候兼任物理课代表。整个初三下近乎所有的课都是做卷子加讲卷子的无聊组合，卷子大概是科任老师自己找的，
比如物理，我们于是每个人要交几块钱的试卷费。收试卷费的任务就落到我头上。</p>

<p>于是一个百无聊赖的晚自习，拉着十几号人，去心灵在线（离学校最近的网吧），用试卷费请大家上网。
近乎包了网吧二楼。那时候玩啥的都有，与几个好友那段时间玩的最多是暗黑破坏神，我玩刺客。</p>

<p>所以试卷费就这么被我散掉了。后来物理老师总碎碎念这大几十块钱，还了他。</p>

<p>初三，整个初中没有比我们更资历老的学生了，所以你看周围人总多少带点痞气，放学回家路上逗逗学妹一类的。
那时候初中生男女之间的感情，大概基本上就是写纸条，送xx回家之类。
“送xx回家”这可能要以后细了说。</p>

<h2 id="非典">非典</h2>

<p>突然有天，电视说什么 SARS, 什么非典，那时候口号最多的是叫“众志成城，抗击非典”。
倒是印象中没要求啥口罩，记得最深的是每天到教室那浓重的消毒水味。</p>

<p>于是乎网吧游戏厅台球室都关掉了，但朋友们间的小道消息说的是，因为中考前家长投诉关的。
然后黑网吧黑游戏厅成了同学们口口传的秘密，曾跟同学一起翘下午自习翻墙去一家黑游戏厅打 PS(就叫打索尼), 玩的是 FIFA,
但其实我不太会玩这类，被虐就是了。只是热闹。</p>

<p>非典对于小县城来说，也就茶余饭后的小话题，周围没有人真得了非典，那其实大家的消息源还是新闻联播。
依稀记得那年板蓝根的疯狂。但小县城，比板蓝根牛逼的让人啼笑皆非。比如，那时候县里时兴送领导求办事送免疫球蛋白，
或者干扰素。嗯，这个带劲儿。</p>

<p>因为非典的关系，我们那届毕业生没有毕业联欢晚会。很遗憾。之前一年的毕业联欢会上，还出了个小品，
自毁形象那种。</p>

<p>但突然非典就没了。大概也就是6月中考后，就再没有这个话题了。</p>

<h2 id="隔壁班">隔壁班</h2>

<p>那时候全校近乎每个班都有认识的人。曾自大地笑称，没有借不来的东西。</p>

<p>所以很多故事，也就从借东西开始发生。一借一还，看起来简单的事情，却不知，借的人或被借的人那一节课有没有各种胡思乱想。
一胡思乱想，诶，很多事就不一样了。</p>

<p>各种机缘巧合又错过，回头再看，真是捉弄人。</p>

<h2 id="中考">中考</h2>

<p>中考比想像中来得快很多。所有人都是突然间发现就要中考了。也不知复习没复习完事。</p>

<p>不曾想到，那时候遇到的人儿，成了后来很长一段时间里的重要的人，也最终成了一不可说的大遗憾。</p>

<p>嗨，苦就苦在，等你想明白这一切，这一切却已经过去了。</p>

<p>以至于成了很长时间都解不开的结，也无从再去回头解释自己的行为逻辑。空留下那么多年和 SA 的来回邮件，
总回看，总内牛满面。</p>

<p>中考就是这样一件事。有时候会梦到在这故事的某一刻，却问的是你这几年还好吗。</p>

<h2 id="高一">高一</h2>

<p>陌生的学校，陌生的环境，不多的几个老同学。</p>

<p>日常交际出问题，所以每周末就是单调和无聊。</p>

<p>就交际来说，现在看，可能自己是极被动的那种。总在等。但实际上又较依赖亲密关系的存在。</p>

<p>想起那时候的 IC 卡电话和校门外的话吧。某段时间里，也曾是常客。</p>

<p>这段高一，每年都会出现在梦里，那是种容易让人分不清现实的梦，总愿意在梦里永远呆下去不醒来。</p>]]></content><author><name>andelf</name></author><category term="blog" /><category term="diary" /><summary type="html"><![CDATA[2003 竟然没找到张像样的照片。那时候生活没那么数码。还在用胶片。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://user-images.githubusercontent.com/72891/103444082-373aa280-4ca0-11eb-9e68-6410f2f6817c.png" /><media:content medium="image" url="https://user-images.githubusercontent.com/72891/103444082-373aa280-4ca0-11eb-9e68-6410f2f6817c.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Why?!</title><link href="https://andelf.github.io/blog/2020/11/27/why-and-why/" rel="alternate" type="text/html" title="Why?!" /><published>2020-11-27T04:00:00+00:00</published><updated>2020-11-27T04:00:00+00:00</updated><id>https://andelf.github.io/blog/2020/11/27/why-and-why</id><content type="html" xml:base="https://andelf.github.io/blog/2020/11/27/why-and-why/"><![CDATA[<p>“为什么呢，这次你这么坏，我却还是会想你。”</p>

<p>“总是这样，来不及相认就失散。”</p>]]></content><author><name>andelf</name></author><category term="blog" /><category term="diary" /><summary type="html"><![CDATA[“为什么呢，这次你这么坏，我却还是会想你。”]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://user-images.githubusercontent.com/72891/100425593-7cc8e600-30ca-11eb-873c-1f9878911c20.jpg" /><media:content medium="image" url="https://user-images.githubusercontent.com/72891/100425593-7cc8e600-30ca-11eb-873c-1f9878911c20.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Welcome to Jekyll!</title><link href="https://andelf.github.io/blog/2020/11/16/welcome-to-jekyll/" rel="alternate" type="text/html" title="Welcome to Jekyll!" /><published>2020-11-16T06:54:24+00:00</published><updated>2020-11-16T06:54:24+00:00</updated><id>https://andelf.github.io/blog/2020/11/16/welcome-to-jekyll</id><content type="html" xml:base="https://andelf.github.io/blog/2020/11/16/welcome-to-jekyll/"><![CDATA[<p>是的我升级了.</p>

<p>是的我又回来了.</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[是的我升级了.]]></summary></entry><entry><title type="html">迷之一键部署</title><link href="https://andelf.github.io/blog/2020/02/27/one-click/" rel="alternate" type="text/html" title="迷之一键部署" /><published>2020-02-27T06:00:00+00:00</published><updated>2020-02-27T06:00:00+00:00</updated><id>https://andelf.github.io/blog/2020/02/27/one-click</id><content type="html" xml:base="https://andelf.github.io/blog/2020/02/27/one-click/"><![CDATA[<p>搞 IT 技术相关的，尤其是后端技术和分布式相关的同学，怕是不只一次听过所谓的一键部署的提法，与此相似或者相关的，可能还包括自动化部署，一键上线/回滚，以及 CI/CD 相关的持续部署，持续集成，持续交付等等概念。</p>

<p>这里，不谈 CI/CD，只谈作为对用户产品的一键部署，无论是叫 one-click, single-click, one-key, one-press, one-button, one-command, single-command… 还是只是对外发布的某种快速部署工具(集)。部署，俗称上线，不过细究概念，上线似乎更侧重日常功能更新，而部署的概念，更侧重首次的初始环境搭建。无论何，传统上，部署都是运维(OP)同学的日常工作。</p>

<p>所谓一键，大都是虚指。做过运维的同学知道，部署怎么可能是一件容易的事情。考虑到现代服务端软件集的庞大，从数据库/缓存，到后端逻辑，到前端服务，到监控系统，到报警系统，各组件相互配合，才完成最终对用户提供服务。更不用说机房服务器环境，云主机环境，现代分布式服务的多样和复杂性，导致 trouble shooting 极其复杂，哪怕是饱经事故的老 OP，也不容易。</p>

<p>正因有了这些复杂性，可信赖的部署工具就更显得重要。好用的工具不只为虎添翼，还给萌新在黑夜里点了盏明灯，在产品拉新的层面更有极其重要的作用。垃圾的工具，处处是坑不说，让人骂娘的心都有，且有工具还不如没有工具。没有工具的时候，OP 拿着命令行一顿敲，不也成功部署了么？</p>

<p>是的，关于一键部署，这里要从命令行说起。</p>

<h2 id="一键部署从哪来">一键部署从哪来</h2>

<h3 id="命令行-op">命令行 OP</h3>

<p>最原始的典型服务部署过程，不过是登录到服务器，通过 scp/wget 下载到最近的软件包，解压编译，必要时候还需要下载若干编译依赖，然后修改配置，最后启动程序完成部署。</p>

<p>潮一点的容器部署方式，拉几个容器镜像下来，加上参数 run 起来，也是略苦逼。</p>

<p>是命令，就有可能出错，相信多数 OP 都有一个命令行小本本，记录着常见操作需要执行的命令。</p>

<h3 id="一键部署小脚本儿">一键部署小脚本儿</h3>

<p>看起来传统的命令行式部署很容易自动化，把这些命令集合在一起，于是就诞生了最原始的，一键部署脚本儿。脚本丢到服务器上，一执行，漫长或短暂的等待过去，服务 ready.</p>

<p>而容器化部署，也可以自动化成 docker-compose 等待，外部包一个处理配置的脚本，依旧好使。</p>

<p>随后 OP 同学为该脚本增加了更多的命令行参数，比如软件包版本号，部署路径，配置文件的某条常修改的参数，看起来这个时候，已经可以交付外部使用了。</p>

<h3 id="一键部署命令行工具集">一键部署命令行工具集</h3>

<p>然而多数服务端软件比以上流程复杂得多，OP 们往往面对的是一个集群，每台机器的配置或命令都有所不同，且服务的启停过程往往具有某种依赖顺序。这时候，简单的命令堆叠小脚本就不能满足需求了。</p>

<p>开源届倒是提供了不少解决方案，比如 Ansible, Puppet, Chef 等待，以及若干虚拟化解决方案，实现了配置，执行，部署，交付的完整流程。此外还有若干轻量工具，靠更多的人工配置环境提供更高的自由度，例如 fabric.</p>

<p>这时候的一键部署，可能就是某个强大工具的配置文件，描述了部署的步骤，然后加上目标机器环境的配置文件，通过执行一条命令，完成整个环境检查，环境初始化，部署应用，启动应用的全流程。</p>

<p>例如 ansible-playbook -i inventory install.yml 这样一条命令，加载 install.yml 描述的安装流程，然后在 inverntory 指定的服务器列表上执行这些安装流程。</p>

<p>但是这样的工具有一个很大的缺点，那就是运行异常可能需要工具的专家介入。专家大概是能给工具写插件级别的。以 Ansible 为例，能讲清楚机器登陆时候，不同发行版报错原因以及解决方法的人，并不多。</p>

<p>对于容器化部署，那当然要诉诸于各种编排工具，不在此讨论了。</p>

<h3 id="一键部署-ui">一键部署 UI</h3>

<p>严格地说，命令行也是 UI 的一种，原教旨主义会告诉你，UI 就是 User Interface，就好比 explorer.exe 也是 SHELL 一样。这里说的 UI, 特指 GUI，大概包括说有的图形应用程序，尤其指浏览器 Web UI.</p>

<p>之前在推上有句吐槽，“每个傻逼的后端产品 PM，都有一颗给命令行写 GUI 的心“，这话放在一键部署领域，依旧是合适无比。</p>

<p>做好 UI 的第一步，大概是不做 UI.</p>

<p>你可以认为 UI 在大部分时候是伪需求，问问自己的内心：在已经有较完善的一键部署工具集或者脚本的情况下，为什么做 UI?</p>

<p>其实答案很简单，UI 不是给 OP 或者一线工程师用的。它目标是为了把一件事情的门槛降低到尽可能低，低到只是恰好理解这个服务是干什么有什么要素的人，也能操作。</p>

<p>然而这是不可能的。所以所谓的你看到到的一众 UI 只能将大部分晦涩的配置选项隐藏起来，然后让你填写一个机器列表然后”一键“部署。然后失败了，弹出简洁的“部署失败”四个大字，或是晦涩的冗长的没人会去看的错误日志。</p>

<p>迄今为止，见过可以说的上能用的一键部署 UI, 可能是 Ansible-Tower，即 Ansible AWX, 但它真的只是包装了 Ansible 的命令行，所以足够简洁，足够完备。然而它的 trouble shooting 难度依旧是 Ansible 级的。除非你对 Ansible 足够熟悉，否则还是找足够经验丰富的人去追查背后到底发生了什么错误。</p>

<h3 id="历史的例外">历史的例外</h3>

<p>大概会有若干种特殊情况。例如大型公司的自研（或致敬某开源项目的）内部系统，例如云平台服务商的某些自动部署工具等。共同点是，受控底层环境，用户有天然身份门槛。</p>

<p>所以这个时候，不乏内部优秀工具或是云平台优秀工具。</p>

<h2 id="一键部署现状">一键部署现状</h2>

<p>然而该做不该做的东西，总是要做的。所以谈谈一键部署到底要做啥吧？这里主要谈分布式系统集群的一键部署。一个应用一个二进制文件一台机器，就真没必要折腾。</p>

<h3 id="inventory-管理">Inventory 管理</h3>

<p>这里的 inventory, 泛指一切目标资产，比如服务器，云主机或者虚拟机。其中的属性信息繁杂，和后续的部署过程有着强依赖，比如机器上的配置，例如磁盘空间，内存，CPU 时间等。通过 inventory 的自动检查和初始化脚本，获取各种信息，为部署过程提供方便。</p>

<p>部分支持云主机的 Inventory 管理，还包括按需动态创建主机实例。</p>

<p>再广义些，还可能包括外部可用的服务资源，例如公共的 redis 服务。</p>

<h4 id="credential-管理">Credential 管理</h4>

<p>Credential 是指登陆机器进行操作的用户权限，比如 SSH 私钥，或是机器的用户名密码，或是云平台的访问所需密钥 KEY.</p>

<h3 id="应用管理">应用管理</h3>

<p>所谓应用，就是将要部署的服务（往往包含多个不同子应用），它们之间通过特定的依赖关系互联，最终对外界提供服务。除核心服务应用之外，还可能包括监控应用(含报警应用)，管理应用(adminstrative dashboard)，工具应用(例如备份/恢复工具)等。</p>

<p>应用的管理，主要是应用元信息的管理，应用之间的依赖关系管理，应用对资源的关系，应用配置管理。</p>

<p>应用元信息的管理，往往是描述一个应用的诸如版本，二进制等等信息，往往是部署的第一步，先准备好将要部署的应用。其中涉及到产品二进制分发的问题，则是额外的话题了。</p>

<p>应用之间依赖，应用对资源的依赖关系的管理，往往通过配置管理的形态实现。</p>

<h3 id="配置管理">配置管理</h3>

<p>配置管理不只包括应用配置管理，往往还包括部署的配置管理，但两者之间往往存在交叉融合的地方，比如说指定某个机器的上部署的应用 A 需要一个特殊的配置项。</p>

<h4 id="应用配置管理">应用配置管理</h4>

<p>管理各应用的配置参数，最终可能以配置文件，应用启动的命令行参数，或是应用的环境变量等方式存在。其中部分配置暗含各应用各部署目标机器之间的互联关系，往往是动态生成得到。例如</p>

<ul>
  <li>应用提供服务的端口号</li>
  <li>应用的数据目录</li>
  <li>应用的日志目录</li>
  <li>某应用有两套配置，一套用于生产环境，一套应用于测试环境</li>
  <li>某条配置项目按某种特定规律生成</li>
  <li>某配置项目随机生成，但要求全服务集群应用的改配置项必须相同</li>
</ul>

<h4 id="部署配置管理">部署配置管理</h4>

<p>部署配置管理其实就是所部署的应用到具体的部署目标之间的映射关系。例如：</p>

<ul>
  <li>某台机器是监控机，需要部署所有监控模块</li>
  <li>某台机器需要打开端口 80 提供服务</li>
  <li>某台机器的某个目录部署应用 A</li>
  <li>某台机器的某个目录做应用 B 的数据目录</li>
</ul>

<p>部署配置管理的高级形态，是声明式。即机器声明我支持某资源，由一键部署系统自动选择依赖关系。这也稍许牵扯到高级形态的部署。</p>

<h3 id="状态数据管理">状态数据管理</h3>

<p>应用的正常运行，不只依赖配置，往往还有若干依赖数据。传统的静态依赖数据之外，就是动态数据了，往往以数据库或是数据目录的方式存在。</p>

<p>状态数据的管理，是整个部署届的难题。越是庞大的状态数据，在部署，环境变更，灾难恢复，以及迁移的时候就越成为问题。</p>

<p>现代分布式系统一般通过底层分布式数据库的方式解决状态数据管理，然而这带来了一个鸡生蛋蛋生鸡的问题，底层分布式数据库的部署，又是一个状态数据管理问题。</p>

<p>是的。我们还有分布式文件系统。233。</p>

<h3 id="部署管理">部署管理</h3>

<p>部署管理，即管理具体的部署操作任务。往往通过任务队列的方式实现，是整个一键部署最核心的部分。</p>

<p>在部署过程中，尤其要提供相对较清晰的进度展示，并输出合理的操作日志供时候追查问题。</p>

<p>部署往往也包含了变更管理，即应用版本或某依赖更新后，再次触发部署。所以部署不应是一次性任务，而是可重入任务。</p>

<p>部署任务的触发一般提供手动和自动两种模式。所谓的“一键”就是这里点击的“部署”按钮。</p>

<p>而自动触发，就隶属持续部署或是持续交付的范畴了，一般通过某种触发器或是任务计划实现。</p>

<h3 id="监控管理">监控管理</h3>

<p>服务的正常运行，离不开监控。在一键部署系统中，监控往往作为单独的应用存在，所以将之化解为另一个应用管理的问题。</p>

<p>监控往往包括监控数据的收集，监控数据的查询展示，日志收集等问题。高级形态还包括动态调试等，加入了诊断系统的功能。</p>

<p>监控系统一般还会提供通知(notification)的功能，报警或者状态日报信息通过通知系统发送给关注者。</p>

<h3 id="服务管理">服务管理</h3>

<p>服务管理相对较简单，即一个部署完成的集群，其中服务的启动，停止，删库跑路等操作。其中还可能牵扯到服务存活检测，服务自启动，服务异常自动重启(保活)等知识点。</p>

<p>服务管理可以作为特殊的部署操作来实现，比如设定特定的部署动作，检查环境后启停对应服务。</p>

<h3 id="pm-们提出的其他管理">PM 们提出的其他管理</h3>

<p>如上是核心功能。然后 PM 往往会提其他需求。例如：</p>

<ul>
  <li>权限管理：作为持久运行的变更系统，至少需要一个权限控制，尤其生成环境
    <ul>
      <li>用户管理</li>
      <li>用户组管理</li>
      <li>用户和用户组的权限管理</li>
    </ul>
  </li>
  <li>多应用管理：即整个一键部署工具作为通用平台</li>
</ul>

<h2 id="一键部署的将要到哪里去">一键部署的将要到哪里去</h2>

<p>一键部署，终将要被云平台或是云平台的容器编排消灭的吧。</p>

<p>但到时候，又是给容器编排做 UI 了。</p>]]></content><author><name></name></author><category term="blog" /><category term="ci" /><summary type="html"><![CDATA[搞 IT 技术相关的，尤其是后端技术和分布式相关的同学，怕是不只一次听过所谓的一键部署的提法，与此相似或者相关的，可能还包括自动化部署，一键上线/回滚，以及 CI/CD 相关的持续部署，持续集成，持续交付等等概念。]]></summary></entry><entry><title type="html">Fix Ansible Tower: stdout capture is missing</title><link href="https://andelf.github.io/blog/2016/12/07/fix-ansible-tower-stdout-capture-is-missing/" rel="alternate" type="text/html" title="Fix Ansible Tower: stdout capture is missing" /><published>2016-12-07T08:33:20+00:00</published><updated>2016-12-07T08:33:20+00:00</updated><id>https://andelf.github.io/blog/2016/12/07/fix-ansible-tower-stdout-capture-is-missing</id><content type="html" xml:base="https://andelf.github.io/blog/2016/12/07/fix-ansible-tower-stdout-capture-is-missing/"><![CDATA[<p>Ansible Tower will report <code class="language-plaintext highlighter-rouge">stdout capture is missing</code> when restoring from previous backup.</p>

<p>Or run from docker?</p>

<p>(得，不装 B 英语了)</p>

<p>长话短说，之前要把 Ansible Tower 拆到 Docker 里，结果发现总不能正常执行。任务界面会提示：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stdout capture is missing
</code></pre></div></div>

<p>检查发现是 celery 进程出错，用 root 启动 celery 倒是正常的。</p>

<p>最后发现是 docker 中的 supervisord 启动时缺乏部分环境变量，解决方法：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>change supervisor/conf.d/tower.conf
ADD:
[program:awx-celeryd]
......
environment=HOME="/var/lib/awx",USER="awx"
......
</code></pre></div></div>

<p>是的，为找到原因，逆向了整个 Ansible Tower。</p>

<p>Ref: <a href="https://github.com/ansible/ansible/issues/13904">GitHub Issue</a></p>]]></content><author><name></name></author><category term="blog" /><category term="linux" /><category term="ansible" /><summary type="html"><![CDATA[Ansible Tower will report stdout capture is missing when restoring from previous backup.]]></summary></entry><entry><title type="html">在 CircleCI 上使用 Rust(CircleCI meets Rust)</title><link href="https://andelf.github.io/blog/2016/11/18/circleci-meets-rust/" rel="alternate" type="text/html" title="在 CircleCI 上使用 Rust(CircleCI meets Rust)" /><published>2016-11-18T05:26:15+00:00</published><updated>2016-11-18T05:26:15+00:00</updated><id>https://andelf.github.io/blog/2016/11/18/circleci-meets-rust</id><content type="html" xml:base="https://andelf.github.io/blog/2016/11/18/circleci-meets-rust/"><![CDATA[<p>最近由于频频遇到 travis-ci 的问题，主要是 Linux 资源排队、macOS 资源更需要排队，导致自动测试时间被拉长，
影响开发效率。</p>

<p>了解到 CircleCI 是不错的替代品，所以打算迁移 Rust 项目过去。当然说起来， CircleCI 的野心更大，是要来替代 jenkins 的。</p>

<p>目前官方支持语言其实都比较落后，包括 go 也只是 1.6 版本，但似乎不是问题，而且据介绍， CircleCI 2.0 支持自定义 build image，支持语言的版本当然不在话下。</p>

<p>每天面对各种 IaaS, PaaS，免不了写配置是，这也是 yaml 程序员的日常。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">pre</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">curl https://sh.rustup.rs -sSf | sh</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">override</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cargo build</span>
    <span class="pi">-</span> <span class="s">cargo test</span>
</code></pre></div></div>

<p>如上。然而不 work。报错：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo build
    Updating registry `https://github.com/rust-lang/crates.io-index`
warning: spurious network error (2 tries remaining): [12/-12] Malformed URL 'ssh://git@github.com:/rust-lang/crates.io-index'
warning: spurious network error (1 tries remaining): [12/-12] Malformed URL 'ssh://git@github.com:/rust-lang/crates.io-index'
error: failed to fetch `https://github.com/rust-lang/crates.io-index`

To learn more, run the command again with --verbose.

cargo build returned exit code 101

Action failed: cargo build
</code></pre></div></div>

<p>神了。原来， CircleCI 自作聪明在 <code class="language-plaintext highlighter-rouge">.gitconfig</code> 里修改了映射配置，强制用它自己的 ssh key 去访问 github，rewrite 了 <code class="language-plaintext highlighter-rouge">https://github.com</code> 的所有仓库。
这恰恰和 cargo 的 registry 机制冲突。所以报错。</p>

<blockquote>
  <p>CircleCI has rewrite <code class="language-plaintext highlighter-rouge">https:://github.com</code> to <code class="language-plaintext highlighter-rouge">ssh://git@github.com:</code> in <code class="language-plaintext highlighter-rouge">.gitconfig</code>. And this made cargo fail with above error message.</p>
</blockquote>

<p>找到了原因，就可以搞了：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">machine</span><span class="pi">:</span>
  <span class="na">pre</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">sed -i 's/github/git-non-exist-hub/g' ~/.gitconfig</span>

<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">pre</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">curl https://sh.rustup.rs -sSf | sh</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">override</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cargo build</span>
    <span class="pi">-</span> <span class="s">cargo test</span>
</code></pre></div></div>

<p>嗯, Ugly but works.</p>]]></content><author><name></name></author><category term="blog" /><category term="rust" /><category term="ci" /><summary type="html"><![CDATA[最近由于频频遇到 travis-ci 的问题，主要是 Linux 资源排队、macOS 资源更需要排队，导致自动测试时间被拉长， 影响开发效率。]]></summary></entry><entry><title type="html">折腾 Raspberry Pi + HomeKit 手记</title><link href="https://andelf.github.io/blog/2016/09/16/play-homekit-with-ios-10-and-raspberry-pi/" rel="alternate" type="text/html" title="折腾 Raspberry Pi + HomeKit 手记" /><published>2016-09-16T12:34:43+00:00</published><updated>2016-09-16T12:34:43+00:00</updated><id>https://andelf.github.io/blog/2016/09/16/play-homekit-with-ios-10-and-raspberry-pi</id><content type="html" xml:base="https://andelf.github.io/blog/2016/09/16/play-homekit-with-ios-10-and-raspberry-pi/"><![CDATA[<p>9月14日凌晨苹果终于推送了 iOS 10 的更新。从之前发布会来看，并没有多少亮点，除了几天的新鲜感之外，
尤其是对于目前还在用上两代机型的我来说，2333。</p>

<p>两年前苹果发布 Swift 语言的同时，新增了 HomeKit，当时用工具 dump 过最老版本的 Swift 声明。传送门：<a href="https://github.com/andelf/Defines-Swift/blob/6a8cda2e12bf6e5a23979a1ad121e70a0eeef6dd/HomeKit.swift">HomeKit.swift</a>。目前所有官方相关的资料位于 <a href="http://www.apple.com/ios/home/">HomeKit - Apple</a>。</p>

<p>好消息是期待很久的 HomeKit 应用终于上线，屏幕上多了“家庭(Home)”应用，控制中心（从屏幕下方滑动）、
Siri 均对此有支持。
iOS 10 终于强化了推出已有两年智能家居平台，提供了官方 App，有不少硬件厂商支持。</p>

<p>简单说，HomeKit 就是苹果官方的智能家居平台解决方案，包括移动设备 SDK，智能家居硬件通信协议(HAP: HomeKit Accessory Protocol)、以及 MFi(Made for iPhone/iPod/iPad) 认证等等。通过 WiFi 或蓝牙连接智能家居设备（或 bridge 设备），也可以利用 Apple TV(4代) 或闲家中的置 iPad 实现设备的远程控制（HAP over iCloud）。</p>

<p>Home App 的维度划分：</p>

<ul>
  <li>Home: 家，和地理位置绑定，支持共享给好友控制。</li>
  <li>Room: 房间，用于对设备进行分组。</li>
  <li>Scene: 场景，一组对设备的配置，例如“起床”，那么可能的配置是打开卧室灯、窗帘、放段舒缓music等等。</li>
</ul>

<p>众所周知苹果是卖数据线等硬件的公司（嗯，假设你数据线也坏过不少），HAP 协议部分是需要加入 MFi Program 才能获取文档，而且 MFi Program 无法以个人开发者身份加入。</p>

<p>好在有好心人逆向了 HAP 的服务端协议（对于智能硬件来说，硬件是服务端，手机App是客户端）。</p>

<p>对于折腾党来说，机会来了，自己动手改造家居！本文不涉及 App 开发，只涉及如何自制支持 HomeKit 的设备。</p>

<h2 id="准备工作">准备工作</h2>

<p>设备列表：</p>

<ul>
  <li>iPhone 6P (iOS 10)</li>
  <li>Raspberry Pi 3 (Debian jessie)</li>
</ul>

<p>考察了两个比较靠谱的 HAP 实现：</p>

<ul>
  <li>https://github.com/KhaosT/HAP-NodeJS</li>
  <li>https://github.com/brutella/hc (golang)</li>
</ul>

<p>最终选择使用 golang 的 <code class="language-plaintext highlighter-rouge">brutella/hc</code>，准备环境。</p>

<p>需要保证树莓派和手机位于统一子网，因为 HAP 底层是基于 Apple mDNS(RFC 6762)。</p>

<p><code class="language-plaintext highlighter-rouge">brutella/hc</code> 要求 golang &gt;= 1.4，而 Debian jessie 版本较低，
需要配置 jessie-backports 源：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>deb ftp://ftp.cn.debian.org/debian jessie-backports main contrib non-free
</code></pre></div></div>

<p>同时导入源的 GPG Key。方法参考 <a href="http://raspberrypi.stackexchange.com/questions/12258/where-is-the-archive-key-for-backports-debian-org">这里</a>。</p>

<p>安装好 golang 1.6.2，建立开发目录。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 似乎直接 install golang 会出点小问题，所以折衷用了如下方法:</span>
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-t</span> jessie-backports golang-1.6 golang-1.6-go golang-1.6-src golang-1.6-doc
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-t</span> jessie-backports golang
</code></pre></div></div>

<h2 id="示例">示例</h2>

<p>跑通官方示例代码：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"github.com/brutella/hc"</span>
	<span class="s">"github.com/brutella/hc/accessory"</span>
	<span class="s">"log"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">info</span> <span class="o">:=</span> <span class="n">accessory</span><span class="o">.</span><span class="n">Info</span><span class="p">{</span>
		<span class="n">Name</span><span class="o">:</span>         <span class="s">"Lamp"</span><span class="p">,</span>
		<span class="n">SerialNumber</span><span class="o">:</span> <span class="s">"051AC-23AAM1"</span><span class="p">,</span>
		<span class="n">Manufacturer</span><span class="o">:</span> <span class="s">"Apple"</span><span class="p">,</span>
		<span class="n">Model</span><span class="o">:</span>        <span class="s">"AB"</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="n">acc</span> <span class="o">:=</span> <span class="n">accessory</span><span class="o">.</span><span class="n">NewSwitch</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

	<span class="n">acc</span><span class="o">.</span><span class="n">Switch</span><span class="o">.</span><span class="n">On</span><span class="o">.</span><span class="n">OnValueRemoteUpdate</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">on</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">on</span> <span class="o">==</span> <span class="no">true</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Client changed switch to on"</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Client changed switch to off"</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">})</span>

	<span class="n">config</span> <span class="o">:=</span> <span class="n">hc</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span><span class="n">Pin</span><span class="o">:</span> <span class="s">"00102003"</span><span class="p">}</span>
	<span class="n">t</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">hc</span><span class="o">.</span><span class="n">NewIPTransport</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">acc</span><span class="o">.</span><span class="n">Accessory</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">hc</span><span class="o">.</span><span class="n">OnTermination</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span>
	<span class="p">})</span>

	<span class="n">t</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>编译执行.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ AppleHome&gt; # current dir

$ AppleHome&gt; go get
...

$ AppleHome&gt; go build
...

$ AppleHome&gt; ./AppleHome
...
</code></pre></div></div>

<p>随后打开手机的 Home App，添加设备，选择 Lamp，输入 PIN 00102003，完成配对，即可使用。</p>

<h2 id="自定义设备">自定义设备</h2>

<p>树莓派外接小音箱一只，用来放电台，尝试用 HomeKit 控制树莓派的禁音。命令：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>amixer set PCM on
amixer set PCM off
</code></pre></div></div>

<p>代码：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"os/exec"</span>
        <span class="s">"github.com/brutella/hc"</span>
        <span class="s">"github.com/brutella/hc/accessory"</span>
        <span class="s">"log"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">info</span> <span class="o">:=</span> <span class="n">accessory</span><span class="o">.</span><span class="n">Info</span><span class="p">{</span>
                <span class="n">Name</span><span class="o">:</span>            <span class="s">"Radio"</span><span class="p">,</span>
                <span class="n">SerialNumber</span><span class="o">:</span> <span class="s">"051AC-23AAM2"</span><span class="p">,</span>
                <span class="n">Manufacturer</span><span class="o">:</span> <span class="s">"Apple"</span><span class="p">,</span>
                <span class="n">Model</span><span class="o">:</span>          <span class="s">"RPI3"</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">acc</span> <span class="o">:=</span> <span class="n">accessory</span><span class="o">.</span><span class="n">NewSwitch</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="n">acc</span><span class="o">.</span><span class="n">Switch</span><span class="o">.</span><span class="n">On</span><span class="o">.</span><span class="n">OnValueRemoteUpdate</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">on</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Toggled PCM!"</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">on</span> <span class="o">==</span> <span class="no">true</span> <span class="p">{</span>
                        <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"amixer"</span><span class="p">,</span> <span class="s">"set"</span><span class="p">,</span> <span class="s">"PCM"</span><span class="p">,</span> <span class="s">"on"</span><span class="p">)</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Client changed switch to on"</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"amixer"</span><span class="p">,</span> <span class="s">"set"</span><span class="p">,</span> <span class="s">"PCM"</span><span class="p">,</span> <span class="s">"off"</span><span class="p">)</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Client changed switch to off"</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="p">})</span>

        <span class="n">config</span> <span class="o">:=</span> <span class="n">hc</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span><span class="n">Pin</span><span class="o">:</span> <span class="s">"00102004"</span><span class="p">}</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">hc</span><span class="o">.</span><span class="n">NewIPTransport</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">acc</span><span class="o">.</span><span class="n">Accessory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">hc</span><span class="o">.</span><span class="n">OnTermination</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">t</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span>
        <span class="p">})</span>

        <span class="n">t</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="其他">其他</h2>

<p>HAP 将智能家居分为以下维度：</p>

<ul>
  <li>Accessory: 单个设备，例如开关，温度计，调节器</li>
  <li>Service: 一组值，合起来提供服务，例如中央空调（调节温度，风速等等）</li>
</ul>

<p>TODO</p>]]></content><author><name></name></author><category term="blog" /><category term="ios" /><summary type="html"><![CDATA[9月14日凌晨苹果终于推送了 iOS 10 的更新。从之前发布会来看，并没有多少亮点，除了几天的新鲜感之外， 尤其是对于目前还在用上两代机型的我来说，2333。]]></summary></entry><entry><title type="html">Swift 3.0 尝试——从入门到再学一门(A Glimpse of Swift 3.0)</title><link href="https://andelf.github.io/blog/2016/04/28/a-glimpse-of-swift-3-dot-0/" rel="alternate" type="text/html" title="Swift 3.0 尝试——从入门到再学一门(A Glimpse of Swift 3.0)" /><published>2016-04-28T02:06:53+00:00</published><updated>2016-04-28T02:06:53+00:00</updated><id>https://andelf.github.io/blog/2016/04/28/a-glimpse-of-swift-3-dot-0</id><content type="html" xml:base="https://andelf.github.io/blog/2016/04/28/a-glimpse-of-swift-3-dot-0/"><![CDATA[<p>安装工具</p>

<p>https://github.com/kylef/swiftenv</p>

<h2 id="swift-30-新变化">Swift 3.0 新变化</h2>

<p>以下内容来自 Swift 语言提案<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>。</p>

<p>Swift 3.0 发布计划</p>

<h3 id="swift-package-system">Swift Package System</h3>

<p>https://github.com/donald-pinckney/swift-packages</p>

<h2 id="ast-结构">AST 结构</h2>

<p>代码位于 <code class="language-plaintext highlighter-rouge">include/swift/AST</code> 和 <code class="language-plaintext highlighter-rouge">lib/AST</code>。</p>

<p>ModuleDecl
模块（单个库或是可执行文件）。编译的最小单元，由多个文件组成。</p>

<p>FileUnit（抽象类）
文件作用域，是代码组织的最小单元。</p>

<ul>
  <li>DerivedFileUnit: A container for a module-level definition derived as part of an implicit protocol conformance.</li>
  <li>SourceFile: A file containing Swift source code. .swift 或 .sil 也可以是虚拟 REPL
    <ul>
      <li>Imports: Vec&lt;(ImportedModule, ImportOptions)&gt;</li>
      <li>Identifier</li>
      <li>Decls: Vec<Decl></Decl></li>
      <li>LocalTypeDecl: Vec<TypeDecl></TypeDecl></li>
      <li>ObjCMethods: Map&lt;ObjCSelector, AbstractFunctionDecl&gt;</li>
      <li>infix, postfix, prefix operators: OperatorMap</li>
    </ul>
  </li>
  <li>BuiltinUnit</li>
</ul>

<h2 id="swift-命令入口">swift 命令入口</h2>

<p>入口函数 <code class="language-plaintext highlighter-rouge">tools/driver/driver.cpp</code>，<code class="language-plaintext highlighter-rouge">main</code> 函数。</p>

<p>集成多个子工具。同时若 <code class="language-plaintext highlighter-rouge">PATH</code> 下有名为 <code class="language-plaintext highlighter-rouge">swift-foobar</code> 的可执行文件，则可通过 <code class="language-plaintext highlighter-rouge">swift foobar</code> 调用。</p>

<h3 id="编译器前端-swift--frontend">编译器前端 <code class="language-plaintext highlighter-rouge">swift -frontend</code></h3>

<p>编译。同时支持打印出各种编译时中间结果。</p>

<h3 id="api-notes-功能-swift--apinotes">API Notes 功能 <code class="language-plaintext highlighter-rouge">swift -apinotes</code></h3>

<p>参考信息位于 <a href="https://github.com/apple/swift/tree/master/apinotes">https://github.com/apple/swift/tree/master/apinotes</a> .</p>

<p>简单说，API Notes 机制就是通过 <code class="language-plaintext highlighter-rouge">.apinotes</code> 文件（YAML格式）描述 Objective-C Framework 和对应 Swift API 的关系。最终生成 <code class="language-plaintext highlighter-rouge">.apinotesc</code> 文件，与 <code class="language-plaintext highlighter-rouge">.swiftmodule</code> 文件一起作为 Swift 的模块。</p>

<p>主要功能包括且不限于：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">SwiftBridge</code>：设置对应的 Bridge 类型，例如 NSArray 对应与 <code class="language-plaintext highlighter-rouge">Swift.Array</code></li>
  <li><code class="language-plaintext highlighter-rouge">Nullability</code>/<code class="language-plaintext highlighter-rouge">NullabilityOfRet</code>： 类的属性、方法的参数、返回值对应类型是否可以为 null，即对应与 Swift 的 T 还是 T?</li>
  <li><code class="language-plaintext highlighter-rouge">Availability</code>：方法是否在 Swift 中暴露，并给出 availability message</li>
  <li><code class="language-plaintext highlighter-rouge">SwiftName</code>：方法 Selector 在 Swift 中的重命名，例如 <code class="language-plaintext highlighter-rouge">filteredArrayUsingPredicate:</code> 替换为 <code class="language-plaintext highlighter-rouge">filtered(using:)</code></li>
</ul>

<p>Dump 为YAML文件：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; swift -apinotes -binary-to-yaml /path/to/lib/swift/macosx/x86_64/Dispatch.apinotesc -o=-
</code></pre></div></div>

<h3 id="module-wrap-工具-swift--modulewrap">Module Wrap 工具 <code class="language-plaintext highlighter-rouge">swift -modulewrap</code></h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Wraps .swiftmodule files inside an object file container so they
// can be passed to the linker directly. Mostly useful for platforms
// where the debug info typically stays in the executable.
// (ie. ELF-based platforms).
</code></pre></div></div>

<p>用法：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swift -modulewrap ObjectiveC.swiftmodule -o objc.o
</code></pre></div></div>

<p>实际发现是在 <code class="language-plaintext highlighter-rouge">.o</code> 里定义了 <code class="language-plaintext highlighter-rouge">___Swift_AST</code> 符号。</p>

<h3 id="repl">REPL</h3>

<p>Swift 提供了两个 REPL(Read-Evaluate-Print Loop)，一个是 Swift 本身内置，另一个集成到了 lldb 命令行下。前者只有基本功能，即将废弃，后者功能更强大。</p>

<p>子命令分别是：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">swift -deprecated-integrated-repl</code></li>
  <li><code class="language-plaintext highlighter-rouge">swift -lldb-repl</code>。</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">swift -repl</code> 子命令选择可用的 REPL 进入，一般是 <code class="language-plaintext highlighter-rouge">lldb-repl</code>，除非找不到 lldb 时。这也是 Swift 命令不带任何参数的默认行为。</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>(apple/swift-evolution)[https://github.com/apple/swift-evolution] <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[安装工具]]></summary></entry><entry><title type="html">Rust Pattern Match(Rust中的模式匹配)</title><link href="https://andelf.github.io/blog/2016/03/22/rust-pattern-match/" rel="alternate" type="text/html" title="Rust Pattern Match(Rust中的模式匹配)" /><published>2016-03-22T15:35:19+00:00</published><updated>2016-03-22T15:35:19+00:00</updated><id>https://andelf.github.io/blog/2016/03/22/rust-pattern-match</id><content type="html" xml:base="https://andelf.github.io/blog/2016/03/22/rust-pattern-match/"><![CDATA[<h1 id="模式匹配">模式匹配</h1>

<p>汉语字典中对“模式”的解释是：事物的标准样式。在计算机科学中，它指特定类型的数据（往往是序列或是树形结构）满足某一特定结构或格式。“匹配”本身是指一个判断寻找过程。最早的模式匹配用于文本编辑器中的正则字符串搜索，之后才作为编程语言特性。</p>

<h2 id="模式匹配基础">模式匹配基础</h2>

<p>模式匹配在计算机科学领域有两层意思。其一，可以特指字符串匹配算法，例如为人熟知的 KMP 字符串匹配算法、命令行工具 grep 等。
其二，特指在一些语言中作为一种以结构的方式处理数据的工具，此时的匹配过程往往是树形匹配，与此相伴的往往还有一个特性叫 guard（守卫）。</p>

<p>Rust 中模式匹配随处可见，例如在<code class="language-plaintext highlighter-rouge">let</code>变量绑定语句、<code class="language-plaintext highlighter-rouge">match</code>匹配语句中等。利用好模式匹配这一特性可以使代码更简洁易懂。<code class="language-plaintext highlighter-rouge">Rust</code>支持模式匹配中的变量绑定、结构体/元组解构、守卫条件判断、数值范围匹配等特性。</p>

<h3 id="原始匹配">原始匹配</h3>

<p><code class="language-plaintext highlighter-rouge">match</code> 语句中可以直接匹配字面常量，下划线<code class="language-plaintext highlighter-rouge">_</code>匹配任意情形。</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">match</span> <span class="n">x</span> <span class="p">{</span>
    <span class="mi">1</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"one"</span><span class="p">),</span>
    <span class="mi">2</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"two"</span><span class="p">),</span>
    <span class="mi">3</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"three"</span><span class="p">),</span>
    <span class="n">_</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"anything"</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div>

<p>以上代码会打印出<code class="language-plaintext highlighter-rouge">one</code>。</p>

<h3 id="结构匹配">结构匹配</h3>

<p><code class="language-plaintext highlighter-rouge">match</code> 用于匹配一个表达式的值，寻找满足条件的子分支(<code class="language-plaintext highlighter-rouge">arm</code>)并执行。每个子分支包含三部分：一系列模式、可选的守卫条件以及主体代码块。</p>

<h3 id="多个模式">多个模式</h3>

<p>每个子分支可以是多个模式，通过 <code class="language-plaintext highlighter-rouge">|</code> 符号分割：</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">match</span> <span class="n">x</span> <span class="p">{</span>
    <span class="mi">1</span> <span class="p">|</span> <span class="mi">2</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"one or two"</span><span class="p">),</span>
    <span class="mi">3</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"three"</span><span class="p">),</span>
    <span class="n">_</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"anything"</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div>

<p>以上代码打印出<code class="language-plaintext highlighter-rouge">one or two</code>。</p>

<h3 id="守卫条件">守卫条件</h3>

<p>通过<code class="language-plaintext highlighter-rouge">if</code>引入子分支的守卫条件：</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">OptionalInt</span> <span class="p">{</span>
    <span class="nf">Value</span><span class="p">(</span><span class="nb">i32</span><span class="p">),</span>
    <span class="n">Missing</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nn">OptionalInt</span><span class="p">::</span><span class="nf">Value</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

<span class="k">match</span> <span class="n">x</span> <span class="p">{</span>
    <span class="nn">OptionalInt</span><span class="p">::</span><span class="nf">Value</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"Got an int bigger than five!"</span><span class="p">),</span>
    <span class="nn">OptionalInt</span><span class="p">::</span><span class="nf">Value</span><span class="p">(</span><span class="o">..</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"Got an int!"</span><span class="p">),</span>
    <span class="nn">OptionalInt</span><span class="p">::</span><span class="n">Missing</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"No such luck."</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="模式匹配进阶">模式匹配进阶</h2>

<p>其实进阶，不如直接从<code class="language-plaintext highlighter-rouge">libsyntax</code>源码看看到底模式匹配是如何实现。<code class="language-plaintext highlighter-rouge">syntax::ast::Pat</code>。</p>

<p>从AST源码中寻找语法要素屋外户两个要点，其一，语法要素是如何表达为对应AST的；其二，对应AST在哪些父AST中出现。</p>

<p>Rust中使用<code class="language-plaintext highlighter-rouge">syntax::ast::Pat</code>枚举来表示一个模式匹配。</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">Pat</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">id</span><span class="p">:</span> <span class="n">NodeId</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">node</span><span class="p">:</span> <span class="n">PatKind</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">span</span><span class="p">:</span> <span class="n">Span</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">enum</span> <span class="n">PatKind</span> <span class="p">{</span>
    <span class="cd">/// Represents a wildcard pattern (`_`)</span>
    <span class="cd">/// 表示通配，下划线</span>
    <span class="n">Wild</span><span class="p">,</span>

    <span class="cd">/// A `PatKind::Ident` may either be a new bound variable,</span>
    <span class="cd">/// or a unit struct/variant pattern, or a const pattern (in the last two cases</span>
    <span class="cd">/// the third field must be `None`).</span>
    <span class="cd">///</span>
    <span class="cd">/// In the unit or const pattern case, the parser can't determine</span>
    <span class="cd">/// which it is. The resolver determines this, and</span>
    <span class="cd">/// records this pattern's `NodeId` in an auxiliary</span>
    <span class="cd">/// set (of "PatIdents that refer to unit patterns or constants").</span>
    <span class="nf">Ident</span><span class="p">(</span><span class="n">BindingMode</span><span class="p">,</span> <span class="n">SpannedIdent</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Pat</span><span class="o">&gt;&gt;</span><span class="p">),</span>

    <span class="cd">/// A struct or struct variant pattern, e.g. `Variant {x, y, ..}`.</span>
    <span class="cd">/// The `bool` is `true` in the presence of a `..`.</span>
    <span class="nf">Struct</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Spanned</span><span class="o">&lt;</span><span class="n">FieldPat</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>

    <span class="cd">/// A tuple struct/variant pattern `Variant(x, y, z)`.</span>
    <span class="cd">/// "None" means a `Variant(..)` pattern where we don't bind the fields to names.</span>
    <span class="nf">TupleStruct</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Pat</span><span class="o">&gt;&gt;&gt;</span><span class="p">),</span>

    <span class="cd">/// A path pattern.</span>
    <span class="cd">/// Such pattern can be resolved to a unit struct/variant or a constant.</span>
    <span class="nf">Path</span><span class="p">(</span><span class="n">Path</span><span class="p">),</span>

    <span class="cd">/// An associated const named using the qualified path `&lt;T&gt;::CONST` or</span>
    <span class="cd">/// `&lt;T as Trait&gt;::CONST`. Associated consts from inherent impls can be</span>
    <span class="cd">/// referred to as simply `T::CONST`, in which case they will end up as</span>
    <span class="cd">/// PatKind::Path, and the resolver will have to sort that out.</span>
    <span class="nf">QPath</span><span class="p">(</span><span class="n">QSelf</span><span class="p">,</span> <span class="n">Path</span><span class="p">),</span>

    <span class="cd">/// A tuple pattern `(a, b)`</span>
    <span class="nf">Tup</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Pat</span><span class="o">&gt;&gt;</span><span class="p">),</span>
    <span class="cd">/// A `box` pattern</span>
    <span class="nf">Box</span><span class="p">(</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Pat</span><span class="o">&gt;</span><span class="p">),</span>
    <span class="cd">/// A reference pattern, e.g. `&amp;mut (a, b)`</span>
    <span class="nf">Ref</span><span class="p">(</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Pat</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Mutability</span><span class="p">),</span>
    <span class="cd">/// A literal</span>
    <span class="nf">Lit</span><span class="p">(</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Expr</span><span class="o">&gt;</span><span class="p">),</span>
    <span class="cd">/// A range pattern, e.g. `1...2`</span>
    <span class="nf">Range</span><span class="p">(</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Expr</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">P</span><span class="o">&lt;</span><span class="n">Expr</span><span class="o">&gt;</span><span class="p">),</span>
    <span class="cd">/// `[a, b, ..i, y, z]` is represented as:</span>
    <span class="cd">///     `PatKind::Vec(box [a, b], Some(i), box [y, z])`</span>
    <span class="nf">Vec</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Pat</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Pat</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&lt;</span><span class="n">Pat</span><span class="o">&gt;&gt;</span><span class="p">),</span>
    <span class="cd">/// A macro pattern; pre-expansion</span>
    <span class="nf">Mac</span><span class="p">(</span><span class="n">Mac</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div>

<p>以上AST定义，即说明，到底什么被认为是一个“模式”。</p>

<p>以下介绍<code class="language-plaintext highlighter-rouge">Pat</code>在哪些AST中出现。</p>

<h3 id="全局-item">全局 Item</h3>

<p>全局 Item 中，使用模式匹配的均为函数参数。</p>

<h4 id="itemkindfn">ItemKind::Fn</h4>

<p><code class="language-plaintext highlighter-rouge">Fn</code> 全局函数 -&gt; <code class="language-plaintext highlighter-rouge">FnDecl</code> 函数声明 -&gt; <code class="language-plaintext highlighter-rouge">[Arg]</code> 函数头参数声明。</p>

<h4 id="itemkindtrait">ItemKind::Trait</h4>

<p><code class="language-plaintext highlighter-rouge">Trait</code> -&gt; <code class="language-plaintext highlighter-rouge">[TraitItem]</code> -&gt; <code class="language-plaintext highlighter-rouge">TraitItemKind::Method</code> -&gt; <code class="language-plaintext highlighter-rouge">MethodSig</code> -&gt; <code class="language-plaintext highlighter-rouge">FnDecl</code> 方法声明，同上。</p>

<h4 id="itemkindimpl">ItemKind::Impl</h4>

<p><code class="language-plaintext highlighter-rouge">Impl</code> -&gt; <code class="language-plaintext highlighter-rouge">[ImplItem]</code> -&gt; <code class="language-plaintext highlighter-rouge">ImplItemKind::Method</code> -&gt; <code class="language-plaintext highlighter-rouge">MethodSig</code> -&gt; <code class="language-plaintext highlighter-rouge">FnDecl</code>。</p>

<h3 id="aststmt-语句">ast::Stmt 语句</h3>

<h4 id="stmtkinddecl">StmtKind::Decl</h4>

<p><code class="language-plaintext highlighter-rouge">Decl</code> -&gt; <code class="language-plaintext highlighter-rouge">DeclKind::Local</code>。</p>

<p>即 <code class="language-plaintext highlighter-rouge">let</code> 语句 <code class="language-plaintext highlighter-rouge">let &lt;pat&gt;:&lt;ty&gt; = &lt;expr&gt;;</code>。</p>

<h4 id="stmtkindexpr-表达式">StmtKind::Expr 表达式</h4>

<p>见下。</p>

<h3 id="astexpr">ast::Expr</h3>

<p>除<code class="language-plaintext highlighter-rouge">match</code>外，<code class="language-plaintext highlighter-rouge">if let</code>、<code class="language-plaintext highlighter-rouge">while let</code>、<code class="language-plaintext highlighter-rouge">for</code>控制语句支持同时进行模式匹配。具体实现是一种<code class="language-plaintext highlighter-rouge">desugared</code>过程，即，去语法糖化。</p>

<p>同时类似于函数定义，闭包参数也支持模式匹配。</p>

<h4 id="if-let">if let</h4>

<p><code class="language-plaintext highlighter-rouge">IfLet(P&lt;Pat&gt;, P&lt;Expr&gt;, P&lt;Block&gt;, Option&lt;P&lt;Expr&gt;&gt;)</code></p>

<p><code class="language-plaintext highlighter-rouge">if let pat = expr { block } else { expr }</code></p>

<p>This is desugared to a match expression.</p>

<h4 id="while-let">while let</h4>

<p><code class="language-plaintext highlighter-rouge">WhileLet(P&lt;Pat&gt;, P&lt;Expr&gt;, P&lt;Block&gt;, Option&lt;Ident&gt;)</code></p>

<p><code class="language-plaintext highlighter-rouge">'label: while let pat = expr { block }</code></p>

<h4 id="for">for</h4>

<p><code class="language-plaintext highlighter-rouge">ForLoop(P&lt;Pat&gt;, P&lt;Expr&gt;, P&lt;Block&gt;, Option&lt;Ident&gt;)</code></p>

<p><code class="language-plaintext highlighter-rouge">'label: for pat in expr { block }</code></p>

<h4 id="match">match</h4>

<p><code class="language-plaintext highlighter-rouge">Match(P&lt;Expr&gt;, Vec&lt;Arm&gt;)</code></p>

<p><code class="language-plaintext highlighter-rouge">match</code> 语句，在 <code class="language-plaintext highlighter-rouge">Arm</code> 中出现，其中 <code class="language-plaintext highlighter-rouge">Arm</code> 定义为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pub struct Arm {
    pub attrs: Vec&lt;Attribute&gt;,
    pub pats: Vec&lt;P&lt;Pat&gt;&gt;,
    pub guard: Option&lt;P&lt;Expr&gt;&gt;,
    pub body: P&lt;Expr&gt;,
}
</code></pre></div></div>

<h4 id="闭包">闭包</h4>

<p><code class="language-plaintext highlighter-rouge">Closure(CaptureBy, P&lt;FnDecl&gt;, P&lt;Block&gt;)</code></p>

<p>闭包，例如 <code class="language-plaintext highlighter-rouge">move |a, b, c| {a + b + c}</code>。</p>

<h2 id="相关-feature-gate">相关 feature gate</h2>

<p><code class="language-plaintext highlighter-rouge">advanced_slice_patterns</code> - See the match expressions section for discussion; the exact semantics of slice patterns are subject to change, so some types are still unstable.</p>

<p><code class="language-plaintext highlighter-rouge">slice_patterns</code> - OK, actually, slice patterns are just scary and completely unstable.</p>

<p><code class="language-plaintext highlighter-rouge">box_patterns</code> - Allows box patterns, the exact semantics of which is subject to change.</p>

<h2 id="参考">参考</h2>

<p>https://doc.rust-lang.org/book/patterns.html</p>]]></content><author><name></name></author><category term="blog" /><category term="rust" /><summary type="html"><![CDATA[模式匹配]]></summary></entry><entry><title type="html">广州实时工具App逆向</title><link href="https://andelf.github.io/blog/2015/06/18/guangzhou-realtime-bus/" rel="alternate" type="text/html" title="广州实时工具App逆向" /><published>2015-06-18T09:39:06+00:00</published><updated>2015-06-18T09:39:06+00:00</updated><id>https://andelf.github.io/blog/2015/06/18/guangzhou-realtime-bus</id><content type="html" xml:base="https://andelf.github.io/blog/2015/06/18/guangzhou-realtime-bus/"><![CDATA[<p>简记。用了 IDA Pro，安卓手机的 Remote 客户端。以及 apktool 等。</p>

<p><a href="https://github.com/andelf/guangzhou-realtime-bus">Github: guangzhou-realtime-bus</a></p>

<ul>
  <li>生成 e=3 的 1024 位 RSA 密钥对</li>
  <li>公钥串用查表加密(byte 映射)，然后 base64 封装发送给服务器</li>
  <li>服务器返回一串用公钥加密过的数据</li>
  <li>用本地私钥解密后，该数据包含未知96字节的一段数据和 DES Key</li>
  <li>从此通信用 DES 加密</li>
</ul>

<p>base64封装过程：先打包字符串长度，然后是原始字符串（JSON），然后是<code class="language-plaintext highlighter-rouge">0x10</code>(md5字符串长度)，
然后是 md5 校验值。整个二进制字符串用 base64 转码，POST 给服务器。</p>

<p>具体的登录注册过程还需要进一步抓包分析，不过暂时兴趣不在这里了。</p>]]></content><author><name></name></author><category term="blog" /><category term="crack" /><summary type="html"><![CDATA[简记。用了 IDA Pro，安卓手机的 Remote 客户端。以及 apktool 等。]]></summary></entry><entry><title type="html">Swift 2.0 的错误处理(Swift 2.0 Error Handling)</title><link href="https://andelf.github.io/blog/2015/06/09/swift-2-dot-0-error-handling/" rel="alternate" type="text/html" title="Swift 2.0 的错误处理(Swift 2.0 Error Handling)" /><published>2015-06-09T07:27:58+00:00</published><updated>2015-06-09T07:27:58+00:00</updated><id>https://andelf.github.io/blog/2015/06/09/swift-2-dot-0-error-handling</id><content type="html" xml:base="https://andelf.github.io/blog/2015/06/09/swift-2-dot-0-error-handling/"><![CDATA[<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protocol ErrorType {
  var _domain: String { get }
  var _code: Int { get }
}

@asmname("swift_bridgeErrorTypeToNSError") func _bridgeErrorTypeToNSError(e: ErrorType) -&gt; AnyObject

@asmname("swift_stdlib_getErrorCode") func _stdlib_getErrorCode&lt;T : ErrorType&gt;(x: UnsafePointer&lt;T&gt;) -&gt; Int

@asmname("swift_stdlib_getErrorDomainNSString") func _stdlib_getErrorDomainNSString&lt;T : ErrorType&gt;(x: UnsafePointer&lt;T&gt;) -&gt; AnyObject
</code></pre></div></div>

<h2 id="foundation">Foundation</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protocol _ObjectiveCBridgeableErrorType : ErrorType {
  init?(_bridgedNSError: NSError)
}

struct NSCocoaError : RawRepresentable, _BridgedNSError, _ObjectiveCBridgeableErrorType, ErrorType, __BridgedNSError, Hashable, Equatable {
  let rawValue: Int
  init(rawValue: Int)
  static var _NSErrorDomain: String {
    get {}
  }
  typealias RawValue = Int
}


infix func ==(a: _GenericObjCError, b: _GenericObjCError) -&gt; Bool
infix func ==(a: _GenericObjCError, b: _GenericObjCError) -&gt; Bool
func ==&lt;T : __BridgedNSError where T.RawValue : SignedIntegerType&gt;(lhs: T, rhs: T) -&gt; Bool

@available(OSX 10.11, iOS 9.0, *)
func resolveError(error: NSError?) throws

enum _GenericObjCError : ErrorType {
  case NilError
  var hashValue: Int {
    get {}
  }
  var _domain: String {
    get {}
  }
  var _code: Int {
    get {}
  }
}

@asmname("swift_stdlib_bridgeNSErrorToErrorType")
func _stdlib_bridgeNSErrorToErrorType&lt;T : _ObjectiveCBridgeableErrorType&gt;(error: NSError, out: UnsafeMutablePointer&lt;T&gt;) -&gt; Bool

@asmname("swift_convertNSErrorToErrorType") func _convertNSErrorToErrorType(error: NSError?) -&gt; ErrorType

@objc enum NSURLError : Int, _BridgedNSError, _ObjectiveCBridgeableErrorType, ErrorType, __BridgedNSError { ... }


protocol __BridgedNSError : RawRepresentable {
  static var _NSErrorDomain: String { get }
}
@asmname("swift_convertErrorTypeToNSError") func _convertErrorTypeToNSError(error: ErrorType) -&gt; NSError
func ~=(match: NSCocoaError, error: ErrorType) -&gt; Bool
protocol _BridgedNSError : __BridgedNSError, _ObjectiveCBridgeableErrorType, Hashable {
  static var _NSErrorDomain: String { get }
}
</code></pre></div></div>

<p>ErrorType 在 Swift 中表示。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extension NSError : ErrorType {
  @objc dynamic var _domain: String {
    @objc dynamic get {}
  }
  @objc dynamic var _code: Int {
    @objc dynamic get {}
  }
}
</code></pre></div></div>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[``` protocol ErrorType { var _domain: String { get } var _code: Int { get } }]]></summary></entry><entry><title type="html">北京实时公交分析</title><link href="https://andelf.github.io/blog/2015/06/01/beijing-realtime-bus/" rel="alternate" type="text/html" title="北京实时公交分析" /><published>2015-06-01T05:17:50+00:00</published><updated>2015-06-01T05:17:50+00:00</updated><id>https://andelf.github.io/blog/2015/06/01/beijing-realtime-bus</id><content type="html" xml:base="https://andelf.github.io/blog/2015/06/01/beijing-realtime-bus/"><![CDATA[<p>361 条线路，705条单向线路。 aibang 负责数据服务。</p>

<p>每辆车，每15秒更新一次 GPS，</p>

<p>整理成为 Repo <a href="https://github.com/andelf/beijing-realtime-bus">andelf/beijing-realtime-bus</a>.</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[361 条线路，705条单向线路。 aibang 负责数据服务。]]></summary></entry><entry><title type="html">为第三方扩展创建 Swift 模块</title><link href="https://andelf.github.io/blog/2015/01/23/swift-3rd-library-install-as-swift-modules/" rel="alternate" type="text/html" title="为第三方扩展创建 Swift 模块" /><published>2015-01-23T15:21:00+00:00</published><updated>2015-01-23T15:21:00+00:00</updated><id>https://andelf.github.io/blog/2015/01/23/swift-3rd-library-install-as-swift-modules</id><content type="html" xml:base="https://andelf.github.io/blog/2015/01/23/swift-3rd-library-install-as-swift-modules/"><![CDATA[<p>本文提出了一种将第三方扩展引入到 Swift 标准库的方法。</p>

<p>以 Alamofire 为例，</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd Path-To-Alamofire-Src-Dir
mkdir -p 32 64

# 创建动态链接库，及对应 Swift 模块，32/64版本
xcrun swiftc -sdk $(xcrun --show-sdk-path --sdk iphoneos) Alamofire.swift -target arm64-apple-ios7.1 -target-cpu cyclone -emit-library -emit-module -module-name Alamofire -v -o libswiftAlamofire.dylib -module-link-name swiftAlamofire -Xlinker -install_name -Xlinker @rpath/libswiftAlamofire.dylib

mv Alamofire.swiftdoc Alamofire.swiftmodule libswiftAlamofire.dylib ./64

xcrun swiftc -sdk $(xcrun --show-sdk-path --sdk iphoneos) Alamofire.swift -target armv7-apple-ios7.1 -target-cpu cyclone -emit-library -emit-module -module-name Alamofire -v -o libswiftAlamofire.dylib -module-link-name swiftAlamofire -Xlinker -install_name -Xlinker @rpath/libswiftAlamofire.dylib

mv Alamofire.swiftdoc Alamofire.swiftmodule libswiftAlamofire.dylib ./64

# 创建 universal lib
lipo -create ./{32,64}/libswiftAlamofire.dylib  -output ./libswiftAlamofire.dylib

# 创建模拟器用 lib
xcrun swiftc -sdk $(xcrun --show-sdk-path --sdk iphonesimulator) Alamofire.swift -target i386-apple-ios7.1 -target-cpu yonah -emit-library -emit-module -module-name Alamofire -v -o libswiftAlamofire.dylib -module-link-name swiftAlamofire -Xlinker -install_name -Xlinker @rpath/libswiftAlamofire.dylib
</code></pre></div></div>

<p>其他相关 target</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-target armv7-apple-ios7.1 -target-cpu cortex-a8
-target arm64-apple-ios7.1 -target-cpu cyclone
-target i386-apple-ios7.1 -target-cpu yonah
-target x86_64-apple-ios7.1 -target-cpu core2
</code></pre></div></div>

<p>其实你了解 Swift 模块结构的化，应该回想到，将第三方模块创建为 swiftmodule 应该是最靠谱的选择。不过实际操作发现，
编译命令无法很方便地调整，主要是因为 xcodebuild 系统，和编译命令不知道怎么导出。也是略纠结。</p>

<p>实际上，如果使用 Carthage 的话，即把第三方扩展作为 Framework 引入，会导致无法支持 iOS 7，但是 Swift 本身是支持 iOS 7 的，
在编译命令和生成的文件中检查发现，对于 iOS 7，Swift 使用了纯静态模块编译的方法。所以其实我们引入第三方扩展的时候也可以这样做。</p>

<p>以下是静态编译所需命令：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xcrun swift -sdk $(xcrun --show-sdk-path --sdk macosx) SwiftyJSON.swift -c -parse-as-library -module-name SwiftyJSON -v -o SwiftyJSON.o

ar rvs libswiftSwiftyJSON.a SwiftyJSON.o
</code></pre></div></div>

<p>如何使用？</p>

<p>将编译结果扔到：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift
/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift_static
</code></pre></div></div>

<p>下对应目录。</p>

<p>然后在 Xcode 里，直接 import。</p>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[本文提出了一种将第三方扩展引入到 Swift 标准库的方法。]]></summary></entry><entry><title type="html">Swift beta3 Changes ( Swift 在 beta3 中的变化）</title><link href="https://andelf.github.io/blog/2014/07/08/swift-beta3-changes/" rel="alternate" type="text/html" title="Swift beta3 Changes ( Swift 在 beta3 中的变化）" /><published>2014-07-08T09:22:11+00:00</published><updated>2014-07-08T09:22:11+00:00</updated><id>https://andelf.github.io/blog/2014/07/08/swift-beta3-changes</id><content type="html" xml:base="https://andelf.github.io/blog/2014/07/08/swift-beta3-changes/"><![CDATA[<p>准确说是 beta2 <code class="language-plaintext highlighter-rouge">Swift version 1.0 (swift-600.0.34.4.8)</code> 到 beta3 <code class="language-plaintext highlighter-rouge">Swift version 1.0 (swift-600.0.38.7)</code> 的变化。</p>

<p>对了，补充下。 beta1 <code class="language-plaintext highlighter-rouge">Swift version 1.0 (swift-600.0.34.4.5)</code> 到 beta2 几乎没有什么变化。</p>

<h2 id="语法">语法</h2>

<p><code class="language-plaintext highlighter-rouge">nil</code> 成为关键字。</p>

<p><code class="language-plaintext highlighter-rouge">[KeyType : ValueType]</code> 可以表示字典类型 <code class="language-plaintext highlighter-rouge">Dictionary&lt;KeyType, ValueType&gt;</code>。</p>

<p><code class="language-plaintext highlighter-rouge">[Type]</code> 用于表示原 Array 类型 <code class="language-plaintext highlighter-rouge">Type[]</code>，等价 <code class="language-plaintext highlighter-rouge">Array&lt;T&gt;</code>，原用法会导致警告。</p>

<p><del>增加 @noinline 属性</del></p>

<p><code class="language-plaintext highlighter-rouge">..</code> 运算符改为 <code class="language-plaintext highlighter-rouge">..&lt;</code>，不容易和 <code class="language-plaintext highlighter-rouge">...</code> 混淆。</p>

<h2 id="函数类型">函数、类型</h2>

<p>原 <code class="language-plaintext highlighter-rouge">sort()</code> 改名为 <code class="language-plaintext highlighter-rouge">sorted()</code>。新增 <code class="language-plaintext highlighter-rouge">sort()</code> 函数，参数为 <code class="language-plaintext highlighter-rouge">inout</code>。</p>

<p>Index 类型中的 <code class="language-plaintext highlighter-rouge">.succ()</code> 变为 <code class="language-plaintext highlighter-rouge">.successor()</code>、 <code class="language-plaintext highlighter-rouge">.pred()</code> 变为 <code class="language-plaintext highlighter-rouge">.predecessor()</code>。</p>

<h2 id="cobjc-交互变化">C/ObjC 交互变化</h2>

<p>增加 <code class="language-plaintext highlighter-rouge">UnsafeMutableArray&lt;T&gt;</code> 类型。</p>

<p>增加 <code class="language-plaintext highlighter-rouge">CFunctionPointer&lt;T&gt;</code> 类型。</p>

<p>删除 <code class="language-plaintext highlighter-rouge">CConstVoidPointer</code>、 <code class="language-plaintext highlighter-rouge">CMutableVoidPointer</code>。替换为 <code class="language-plaintext highlighter-rouge">UnsafePointer&lt;()&gt;</code>、<code class="language-plaintext highlighter-rouge">ConstUnsafePointer&lt;Int32&gt;</code>。</p>

<p>删除 <code class="language-plaintext highlighter-rouge">CConstPointer&lt;T&gt;</code>、<code class="language-plaintext highlighter-rouge">CMutablePointer&lt;T&gt;</code>。替换为 <code class="language-plaintext highlighter-rouge">UnsafePointer&lt;T&gt;</code>、<code class="language-plaintext highlighter-rouge">ConstUnsafePointer&lt;T&gt;</code>。</p>

<p>这么一来指针操作简单了好多。原有会出现 <code class="language-plaintext highlighter-rouge">COpaquePointer</code> 的不合理情况，也都对应到适合的类型。</p>

<p><code class="language-plaintext highlighter-rouge">CString</code> 可以从 <code class="language-plaintext highlighter-rouge">UnsafePointer&lt;UInt8&gt;</code> 和 <code class="language-plaintext highlighter-rouge">UnsafePointer&lt;CChar&gt;</code> 两种类型构造获得，之前只支持 <code class="language-plaintext highlighter-rouge">UInt8</code>。</p>

<p>module.map 中头文件声明转换为 Swift 声明不再使用 C 兼容类型，直接使用 Swift 相应类型。原有 <code class="language-plaintext highlighter-rouge">CInt</code>，现在成为 <code class="language-plaintext highlighter-rouge">Int32</code>。</p>

<p>结构体会自动添加构造函数 <code class="language-plaintext highlighter-rouge">init(field1:field2:...)</code> 这样。</p>

<h3 id="nil">nil</h3>

<p>去掉了 <code class="language-plaintext highlighter-rouge">NilType</code>，增加了 <code class="language-plaintext highlighter-rouge">NilLiteralConvertible</code>， <code class="language-plaintext highlighter-rouge">nil</code> 成为关键字。可以认为是 nil 常量。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protocol NilLiteralConvertible {
  class func convertFromNilLiteral() -&gt; Self
}
</code></pre></div></div>

<p>除了 Optional 、上面所提到的指针类型外，<code class="language-plaintext highlighter-rouge">RawOptionSet</code> 也实现了该协议。</p>

<h3 id="array">Array</h3>

<p>去掉了 <code class="language-plaintext highlighter-rouge">.copy()</code>、<code class="language-plaintext highlighter-rouge">unshare()</code> 方法。</p>

<p>增加了以下方法：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func makeUnique(inout buffer: ArrayBuffer&lt;T&gt;, e: T, index: Int)
func sorted(isOrderedBefore: (T, T) -&gt; Bool) -&gt; Array&lt;T&gt;
</code></pre></div></div>

<p>看起来 <code class="language-plaintext highlighter-rouge">Array</code> 对底层容器的引用有了更好的控制 <code class="language-plaintext highlighter-rouge">ArrayBufferType</code> 增加了判断方法 <code class="language-plaintext highlighter-rouge">func isMutableAndUniquelyReferenced() -&gt; Bool</code>。</p>

<p>Array 目前可以认为是真正的值类型。</p>

<h3 id="指针">指针</h3>

<h4 id="增加了-_pointer-protocol">增加了 <code class="language-plaintext highlighter-rouge">_Pointer</code> protocol</h4>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">protocol</span> <span class="nc">_Pointer</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">value</span><span class="k">:</span> <span class="kt">RawPointer</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">init</span><span class="o">(</span><span class="k">_</span> <span class="kt">value:</span> <span class="kt">RawPointer</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>表示一个类型可以对应到原生指针。</p>

<p>同时成为内部桥接类型，编译器内部在转换时使用它（取出 RawPointer, 构造具体指针类型）。</p>

<h2 id="模块">模块</h2>

<p>增加了  StdlibUnittest 模块。 <a href="https://github.com/andelf/Defines-Swift/blob/79ed8d40659e4d038f41e3c30b4b3358106bd50a/StdlibUnittest.swift">声明代码</a>。单元测试终于有了。</p>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[准确说是 beta2 Swift version 1.0 (swift-600.0.34.4.8) 到 beta3 Swift version 1.0 (swift-600.0.38.7) 的变化。]]></summary></entry><entry><title type="html">Use Swift Dynamic Framework （如何科学地引用第三方 Swift 库)</title><link href="https://andelf.github.io/blog/2014/07/07/use-swift-dynamic-library/" rel="alternate" type="text/html" title="Use Swift Dynamic Framework （如何科学地引用第三方 Swift 库)" /><published>2014-07-07T04:09:54+00:00</published><updated>2014-07-07T04:09:54+00:00</updated><id>https://andelf.github.io/blog/2014/07/07/use-swift-dynamic-library</id><content type="html" xml:base="https://andelf.github.io/blog/2014/07/07/use-swift-dynamic-library/"><![CDATA[<p>排名 16 了。啧啧。你看才刚出一个月。</p>

<p>目前已经有了很多非常棒的 Swift 第三方库， JSON 处理啊、 HTTP 访问啊、 UIView 插件啊等等。</p>

<p>如何科学地引用这些第三方库呢？</p>

<h2 id="现状">现状</h2>

<p>CocoaPods 由于完全使用静态链接解决方法，过度依赖 Objective-C ，目前应该是官方 repo 有提到是 <code class="language-plaintext highlighter-rouge">-Xlinker</code> error , 这个问题之前我也遇到过，无解。除非手工执行 <code class="language-plaintext highlighter-rouge">ar</code> 不用 <code class="language-plaintext highlighter-rouge">ld</code> 和 <code class="language-plaintext highlighter-rouge">libtool</code>。</p>

<p>小伙伴有用子目录的方法引用代码，貌似不错，还有就是直接用 <code class="language-plaintext highlighter-rouge">git submodule</code>，看起来维护性也可以。</p>

<h2 id="简单解决方案">简单解决方案</h2>

<p>一个良好的第三方库应该实现为 Cocoa Touch Framework (实际内容为 Header + 动态链接库)。而不是直接把 Swift 代码 Copy 过来放入自己的项目。这里以一个简单项目为例，介绍如何科学使用。</p>

<h3 id="目标描述">目标描述</h3>

<p>用 Swift 创建一个 Demo ，使用 SwiftyJSON 和 LTMorphingLabel 库。</p>

<p>项目的名字叫 DemoApp 。</p>

<h4 id="创建-workspace">创建 Workspace</h4>

<p>创建一个 Workspace ，名字随意，位置能找到就好。这个 Workspace 主要用来管理我们的项目及其依赖的第三方库。</p>

<h4 id="创建-demoapp">创建 DemoApp</h4>

<p>在 Workspace 创建一个 App ，因为是测试所以我选了 Single View Application 。</p>

<h4 id="引入-swiftyjson">引入 SwiftyJSON</h4>

<p>SwiftyJSON 是一个 Cocoa Touch Framework ，可以直接使用， <code class="language-plaintext highlighter-rouge">git clone</code> 后，添加项目到 Workspace 即可。</p>

<p>尝试操作发现。。最容易最不会出错的方法就是直接从 Finder 里把 <code class="language-plaintext highlighter-rouge">.xcodeproj</code> 文件拖动到 Workspace 。</p>

<h4 id="引入-ltmorphinglabel">引入 LTMorphingLabel</h4>

<p>LTMorphingLabel 是一个 App Deme 式项目。其中 Label View 的实现在一个子目录中。可以采用创建 Cocoa
Touch Framework 的方法来引入这几个文件。</p>

<p>当然也可以直接把目录拖到我们的 DemoApp 里，不过太原始粗暴了。</p>

<h4 id="为-app-添加依赖">为 App 添加依赖</h4>

<p>在 DemoApp 的 Genral 选项卡中，添加 Linked Frameworks and Libraries 。选择  Workspace 中 SwiftyJSON 和
LTMorphingLabel 两个 <code class="language-plaintext highlighter-rouge">.framework</code> 。</p>

<p>如果是直接选择来自其他项目的 <code class="language-plaintext highlighter-rouge">.framework</code> 而不是同一 Workspace ，那么这里也许还要同时加入 <code class="language-plaintext highlighter-rouge">Embedded Binaries</code>。</p>

<h4 id="使用">使用</h4>

<p>添加好依赖后，就可以在 DemoApp 项目代码中 <code class="language-plaintext highlighter-rouge">import SwiftyJSON</code> 或者 <code class="language-plaintext highlighter-rouge">import LTMorphingLabel</code> 来使用对应的库。同时还可以用 Command + 鼠标点击的方法查看声明代码。</p>

<h4 id="除错">除错</h4>

<p>比较坑爹的是，实际上按照以上方法， <code class="language-plaintext highlighter-rouge">LTMorphingLabel</code> 并不能正常使用，查看报错信息发现是自动生成的 <code class="language-plaintext highlighter-rouge">LTMorphingLabel-Swift.h</code> 有处语法无法被识别，编辑器找到 <code class="language-plaintext highlighter-rouge">.h</code> 文件，注释掉这行诡异代码即可。</p>

<p>看起来目前的 Bridge Header 和 -emit-objc-header 实现还是有问题的。小伙伴一定要淡定。</p>

<h2 id="对于非-workspace">对于非 Workspace</h2>

<p>如果不喜欢使用 Workspace ，也可以将第三方库的编译结果，一个 <code class="language-plaintext highlighter-rouge">.framework</code> 目录拖到项目文件里，然后添加 <code class="language-plaintext highlighter-rouge">Embedded Binaries</code>。</p>

<h2 id="评论">评论</h2>

<p>创建 Cocoa Touch Framework 选项中，可以使用 Swift 代码，此时编译结果（默认）会包含 <code class="language-plaintext highlighter-rouge">module.modulemap</code> 文件，
之前有介绍过它的作用，通过它， Swift 可以使用第三方模块。参考 <a href="http://andelf.github.io/blog/2014/06/19/modules-for-swift/">Module System of Swift (简析 Swift 的模块系统)</a> 。</p>

<p>实际上这个解决方案绕了一大圈，通过 Swift 文件导出 <code class="language-plaintext highlighter-rouge">ProjName-Swift.h</code>、然后 <code class="language-plaintext highlighter-rouge">module.modulemap</code> 模块描述文件引入、然后再由 Swift 导入。</p>

<p>其实 <code class="language-plaintext highlighter-rouge">.framework</code> 同时也包含了 <code class="language-plaintext highlighter-rouge">ProjName.swiftmodule/[ARCH].swiftmodule</code> 不过看起来没有使用到，而且默认在 IDE 下也不支持 Swift 从 <code class="language-plaintext highlighter-rouge">.swiftmodule</code> 文件导入，比较坑。希望以后版本能加入支持。</p>

<p><code class="language-plaintext highlighter-rouge">.framework</code> 包含了所有 Swift 标准库的动态链接库，小伙伴可能会以为这会导致编译后的 App 变大。其实大可放心，任何 Swift 语言的 App 都会包含这些动态链接库，而且只会包含一个副本。此方法对 App 最终的大小几乎无影响。</p>

<p>注： 个人测试了下，发现这个 <code class="language-plaintext highlighter-rouge">.swiftmodule</code> 是可以通过其他方法使用的，绕过 <code class="language-plaintext highlighter-rouge">module.modulemap</code>，应该是更佳的解决方案，但是需要控制命令行参数。</p>

<p>至于静态链接库，过时了。抛弃吧。</p>

<h2 id="参考">参考</h2>

<ul>
  <li><a href="http://andelf.github.io/blog/2014/06/19/modules-for-swift/">Module System of Swift (简析 Swift 的模块系统)</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/25/write-swift-module-with-swift-cont/">Write Swift Module Cont. Static Library （使用 Swift 创建 Swift 模块 - 静态链接库）</a></li>
</ul>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[排名 16 了。啧啧。你看才刚出一个月。]]></summary></entry><entry><title type="html">Swift Undocumented Grammar （Swift 黑语法）</title><link href="https://andelf.github.io/blog/2014/07/03/swift-undocumented-grammar/" rel="alternate" type="text/html" title="Swift Undocumented Grammar （Swift 黑语法）" /><published>2014-07-03T19:05:11+00:00</published><updated>2014-07-03T19:05:11+00:00</updated><id>https://andelf.github.io/blog/2014/07/03/swift-undocumented-grammar</id><content type="html" xml:base="https://andelf.github.io/blog/2014/07/03/swift-undocumented-grammar/"><![CDATA[<p>本文介绍 Swift 的 Undocumented 语法特性。</p>

<p>电子书上介绍的 default function parameter 这里都不好意思拿出来写。</p>

<p>咳咳。持续更新。</p>

<h2 id="用关键字当变量名">用关键字当变量名</h2>

<p>Keywards as variable name.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// escaped variable name</span>
<span class="n">let</span> <span class="n">`let`</span> <span class="k">=</span> <span class="mi">1000</span>
<span class="nf">dump</span><span class="o">(</span><span class="n">`let`</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="err">"</span><span class="kt">variable</span> <span class="kt">named</span> <span class="kt">let</span><span class="err">"</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="new-关键字"><code class="language-plaintext highlighter-rouge">new</code> 关键字</h2>

<p>The <code class="language-plaintext highlighter-rouge">new</code> keyword.</p>

<p>快速初始化数组。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">an_array_with_100_zero</span> <span class="k">=</span> <span class="nf">new</span><span class="o">(</span><span class="nc">Int</span><span class="o">)[</span><span class="err">100</span><span class="o">]</span>
</code></pre></div></div>

<h2 id="protocol-type">protocol type</h2>

<p>use <code class="language-plaintext highlighter-rouge">protocol&lt;Protocol1, Protocol2, ...&gt;</code> as a type.</p>

<h2 id="how-i-find-it">How I find it?</h2>

<p>瞎试出来的。</p>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[本文介绍 Swift 的 Undocumented 语法特性。]]></summary></entry><entry><title type="html">Cocoa Extensions in Swift ( Cocoa 在 Swift 中所添加的扩展）</title><link href="https://andelf.github.io/blog/2014/07/03/cocoa-in-swift/" rel="alternate" type="text/html" title="Cocoa Extensions in Swift ( Cocoa 在 Swift 中所添加的扩展）" /><published>2014-07-03T17:05:55+00:00</published><updated>2014-07-03T17:05:55+00:00</updated><id>https://andelf.github.io/blog/2014/07/03/cocoa-in-swift</id><content type="html" xml:base="https://andelf.github.io/blog/2014/07/03/cocoa-in-swift/"><![CDATA[<p>最近看到了 <a href="https://github.com/raywenderlich/swift-style-guide">Swift Style Guide</a> 个人觉得内容太少，
Swift 本身作为一门庞大的语言，语素众多。本文就 Swift 本身对 Cocoa 的扩展，看看对日常 Cocoa 风格有什么影响。</p>

<p>Swift 本身的特性，导致它在一些用法上和 Objective-C 上有所不同，比如 ObjC 的 struct 单纯和 C 的一样，但是在 Swift
中的 struct 则要强大得多。</p>

<p>个人认为比如 <code class="language-plaintext highlighter-rouge">CGPointMake</code> 这样的函数，理论上不应该出现在 Swift 代码中。而是应该用 <code class="language-plaintext highlighter-rouge">CGPoint(x:y:)</code>。</p>

<p>本文可以作为参考手册使用。</p>

<h2 id="标准库扩展">标准库扩展</h2>

<h3 id="objectivec">ObjectiveC</h3>

<p>值得注意的是 Selector 相关方法，实现了 <code class="language-plaintext highlighter-rouge">StringLiteralConvertible</code>。也可以从 <code class="language-plaintext highlighter-rouge">nil</code> 获得。</p>

<h3 id="foundation">Foundation</h3>

<p>这里忽略之前介绍过的 <code class="language-plaintext highlighter-rouge">_BridgedToObjectiveC</code> 相关内容。</p>

<h4 id="协议附加">协议附加</h4>

<p>Sequence 协议</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NSMutableArray NSSet NSArray NSMutableDictionary NSMutableSet NSDictionary
</code></pre></div></div>

<p>所有以上这些类型都可以通过 for-in 操作。</p>

<p>*LiteralConvertible</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NSNumber NSString NSArray NSDictionary
</code></pre></div></div>

<h4 id="隐式类型转换">隐式类型转换</h4>

<p>CF 几乎都对应到了 NS 类型。这里略去</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">NilType</code> -&gt; <code class="language-plaintext highlighter-rouge">NSZone</code></li>
  <li><code class="language-plaintext highlighter-rouge">Dictionary&lt;KeyType: Hashable, ValueType&gt;</code> -&gt; <code class="language-plaintext highlighter-rouge">NSDictionary</code></li>
  <li><code class="language-plaintext highlighter-rouge">NSDictionary</code> -&gt; <code class="language-plaintext highlighter-rouge">Dictionary&lt;NSObject, AnyObject&gt;</code></li>
  <li><code class="language-plaintext highlighter-rouge">String</code> &lt;-&gt; <code class="language-plaintext highlighter-rouge">NSString</code></li>
  <li><code class="language-plaintext highlighter-rouge">NSArray</code> -&gt; <code class="language-plaintext highlighter-rouge">AnyObject[]</code></li>
  <li><code class="language-plaintext highlighter-rouge">A[]</code> -&gt; <code class="language-plaintext highlighter-rouge">NSArray</code></li>
  <li><code class="language-plaintext highlighter-rouge">Float Double Int UInt Bool</code> -&gt; <code class="language-plaintext highlighter-rouge">NSNumber</code></li>
  <li><code class="language-plaintext highlighter-rouge">NSRange</code> -&gt; <code class="language-plaintext highlighter-rouge">Range&lt;Int&gt;</code> // 比较有意思的一个</li>
</ul>

<h4 id="方法扩展">方法扩展</h4>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// let s = NSSet(objects: 12, 32, 23, 12)</span>
<span class="n">extension</span> <span class="nc">NSSet</span> <span class="o">{</span>
  <span class="n">convenience</span> <span class="nf">init</span><span class="o">(</span><span class="n">objects</span> <span class="n">elements</span><span class="k">:</span> <span class="kt">AnyObject...</span><span class="o">)</span>
<span class="o">}</span>
<span class="n">extension</span> <span class="nc">NSOrderedSet</span> <span class="o">{</span>
  <span class="n">convenience</span> <span class="nf">init</span><span class="o">(</span><span class="n">objects</span> <span class="n">elements</span><span class="k">:</span> <span class="kt">AnyObject...</span><span class="o">)</span>
<span class="o">}</span>
<span class="c1">// 这里注意，NSRange 和 Swift Range 对 range 结束的表述方法不同</span>
<span class="c1">// NSRange 保存 range 元素个数</span>
<span class="c1">// Swift Range 保存的是结束元素</span>
<span class="c1">// let r = NSRange(0..20)</span>
<span class="n">extension</span> <span class="nc">NSRange</span> <span class="o">{</span>
  <span class="nf">init</span><span class="o">(</span><span class="k">_</span> <span class="n">x</span><span class="k">:</span> <span class="kt">Range&lt;Int&gt;</span><span class="o">)</span>
<span class="o">}</span>
<span class="c1">// let prop = NSDictionary(objectsAndKeys: "Feather", "name", "Programming", "hobby")</span>
<span class="n">extension</span> <span class="nc">NSDictionary</span> <span class="o">{</span>
  <span class="n">convenience</span> <span class="nf">init</span><span class="o">(</span><span class="n">objectsAndKeys</span> <span class="n">objects</span><span class="k">:</span> <span class="kt">AnyObject...</span><span class="o">)</span>
<span class="o">}</span>
<span class="n">extension</span> <span class="nc">NSObject</span> <span class="k">:</span> <span class="kt">CVarArg</span> <span class="o">{</span>
  <span class="kt">@objc</span> <span class="kt">func</span> <span class="kt">encode</span><span class="o">()</span> <span class="kt">-&gt;</span> <span class="kt">Word</span><span class="o">[]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>字符串的扩展方法非常多。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">static</span> <span class="n">func</span> <span class="nf">availableStringEncodings</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">NSStringEncoding</span><span class="o">[]</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">defaultCStringEncoding</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">NSStringEncoding</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">localizedNameOfStringEncoding</span><span class="o">(</span><span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">localizedStringWithFormat</span><span class="o">(</span><span class="n">format</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">_</span> <span class="n">arguments</span><span class="k">:</span> <span class="kt">CVarArg...</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">pathWithComponents</span><span class="o">(</span><span class="n">components</span><span class="k">:</span> <span class="kt">String</span><span class="o">[])</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">stringWithContentsOfFile</span><span class="o">(</span><span class="n">path</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">encoding</span> <span class="n">enc</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">,</span> <span class="n">error</span><span class="k">:</span> <span class="kt">NSErrorPointer</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">?</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">stringWithContentsOfFile</span><span class="o">(</span><span class="n">path</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">usedEncoding</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;NSStringEncoding&gt;</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">error</span><span class="k">:</span> <span class="kt">NSErrorPointer</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">?</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">stringWithContentsOfURL</span><span class="o">(</span><span class="n">url</span><span class="k">:</span> <span class="kt">NSURL</span><span class="o">,</span> <span class="n">encoding</span> <span class="n">enc</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">,</span> <span class="n">error</span><span class="k">:</span> <span class="kt">NSErrorPointer</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">?</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">stringWithContentsOfURL</span><span class="o">(</span><span class="n">url</span><span class="k">:</span> <span class="kt">NSURL</span><span class="o">,</span> <span class="n">usedEncoding</span> <span class="n">enc</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;NSStringEncoding&gt;</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">error</span><span class="k">:</span> <span class="kt">NSErrorPointer</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">?</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">stringWithCString</span><span class="o">(</span><span class="n">cString</span><span class="k">:</span> <span class="kt">CString</span><span class="o">,</span> <span class="n">encoding</span> <span class="n">enc</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">?</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">stringWithUTF8String</span><span class="o">(</span><span class="n">bytes</span><span class="k">:</span> <span class="kt">CString</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">?</span>
  <span class="n">func</span> <span class="nf">canBeConvertedToEncoding</span><span class="o">(</span><span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
  <span class="k">var</span> <span class="n">capitalizedString</span><span class="k">:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">func</span> <span class="kt">capitalizedStringWithLocale</span><span class="o">(</span><span class="kt">locale:</span> <span class="kt">NSLocale</span><span class="o">)</span> <span class="kt">-&gt;</span> <span class="kt">String</span>
  <span class="n">func</span> <span class="nf">caseInsensitiveCompare</span><span class="o">(</span><span class="n">aString</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">NSComparisonResult</span>
  <span class="n">func</span> <span class="nf">commonPrefixWithString</span><span class="o">(</span><span class="n">aString</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">options</span><span class="k">:</span> <span class="kt">NSStringCompareOptions</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">compare</span><span class="o">(</span><span class="n">aString</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">options</span> <span class="n">mask</span><span class="k">:</span> <span class="kt">NSStringCompareOptions</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">range</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;?</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">locale</span><span class="k">:</span> <span class="kt">NSLocale?</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">NSComparisonResult</span>
  <span class="n">func</span> <span class="nf">completePathIntoString</span><span class="o">(</span><span class="k">_</span> <span class="n">outputName</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;String&gt;</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">caseSensitive</span><span class="k">:</span> <span class="kt">Bool</span><span class="o">,</span> <span class="n">matchesIntoArray</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;String</span><span class="o">[]&gt;</span> <span class="k">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">filterTypes</span><span class="k">:</span> <span class="kt">String</span><span class="o">[]?</span> <span class="k">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Int</span>
  <span class="n">func</span> <span class="nf">componentsSeparatedByCharactersInSet</span><span class="o">(</span><span class="n">separator</span><span class="k">:</span> <span class="kt">NSCharacterSet</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">[]</span>
  <span class="n">func</span> <span class="nf">componentsSeparatedByString</span><span class="o">(</span><span class="n">separator</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">[]</span>
  <span class="n">func</span> <span class="nf">cStringUsingEncoding</span><span class="o">(</span><span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">CChar</span><span class="o">[]?</span>
  <span class="n">func</span> <span class="nf">dataUsingEncoding</span><span class="o">(</span><span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">,</span> <span class="n">allowLossyConversion</span><span class="k">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">NSData</span>
  <span class="k">var</span> <span class="n">decomposedStringWithCanonicalMapping</span><span class="k">:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">var</span> <span class="kt">decomposedStringWithCompatibilityMapping:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">func</span> <span class="kt">enumerateLines</span><span class="o">(</span><span class="kt">body:</span> <span class="o">(</span><span class="kt">line:</span> <span class="kt">String</span><span class="o">,</span> <span class="kt">inout</span> <span class="kt">stop:</span> <span class="kt">Bool</span><span class="o">)</span> <span class="kt">-&gt;</span> <span class="o">())</span>
  <span class="n">func</span> <span class="nf">enumerateLinguisticTagsInRange</span><span class="o">(</span><span class="n">range</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">scheme</span> <span class="n">tagScheme</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">options</span> <span class="n">opts</span><span class="k">:</span> <span class="kt">NSLinguisticTaggerOptions</span><span class="o">,</span> <span class="n">orthography</span><span class="k">:</span> <span class="kt">NSOrthography?</span><span class="o">,</span> <span class="k">_</span> <span class="n">body</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">,</span> <span class="nc">Range</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">.</span><span class="py">Index</span><span class="o">&gt;,</span> <span class="n">inout</span> <span class="nc">Bool</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">())</span>
  <span class="n">func</span> <span class="nf">enumerateSubstringsInRange</span><span class="o">(</span><span class="n">range</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">options</span> <span class="n">opts</span><span class="k">:</span> <span class="kt">NSStringEnumerationOptions</span><span class="o">,</span> <span class="k">_</span> <span class="n">body</span><span class="k">:</span> <span class="o">(</span><span class="kt">substring:</span> <span class="kt">String</span><span class="o">,</span> <span class="kt">substringRange:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">enclosingRange</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">inout</span> <span class="nc">Bool</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">())</span>
  <span class="k">var</span> <span class="n">fastestEncoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">func</span> <span class="kt">fileSystemRepresentation</span><span class="o">()</span> <span class="kt">-&gt;</span> <span class="kt">CChar</span><span class="o">[]</span>
  <span class="n">func</span> <span class="nf">getBytes</span><span class="o">(</span><span class="n">inout</span> <span class="n">buffer</span><span class="k">:</span> <span class="kt">UInt8</span><span class="o">[],</span> <span class="n">maxLength</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">usedLength</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;Int&gt;</span><span class="o">,</span> <span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">,</span> <span class="n">options</span><span class="k">:</span> <span class="kt">NSStringEncodingConversionOptions</span><span class="o">,</span> <span class="n">range</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">remainingRange</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;Range&lt;String.Index&gt;&gt;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
  <span class="n">func</span> <span class="nf">getCString</span><span class="o">(</span><span class="n">inout</span> <span class="n">buffer</span><span class="k">:</span> <span class="kt">CChar</span><span class="o">[],</span> <span class="n">maxLength</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
  <span class="n">func</span> <span class="nf">getFileSystemRepresentation</span><span class="o">(</span><span class="n">inout</span> <span class="n">buffer</span><span class="k">:</span> <span class="kt">CChar</span><span class="o">[],</span> <span class="n">maxLength</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
  <span class="n">func</span> <span class="nf">getLineStart</span><span class="o">(</span><span class="n">start</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">contentsEnd</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">forRange</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">)</span>
  <span class="n">func</span> <span class="nf">getParagraphStart</span><span class="o">(</span><span class="n">start</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">contentsEnd</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">forRange</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">)</span>
  <span class="k">var</span> <span class="n">hash</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">static</span> <span class="kt">func</span> <span class="kt">stringWithBytes</span><span class="o">(</span><span class="kt">bytes:</span> <span class="kt">UInt8</span><span class="o">[],</span> <span class="n">length</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">?</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">stringWithBytesNoCopy</span><span class="o">(</span><span class="n">bytes</span><span class="k">:</span> <span class="kt">CMutableVoidPointer</span><span class="o">,</span> <span class="n">length</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">,</span> <span class="n">freeWhenDone</span> <span class="n">flag</span><span class="k">:</span> <span class="kt">Bool</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">?</span>
  <span class="nf">init</span><span class="o">(</span><span class="n">utf16CodeUnits</span><span class="k">:</span> <span class="kt">CConstPointer&lt;unichar&gt;</span><span class="o">,</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
  <span class="nf">init</span><span class="o">(</span><span class="n">utf16CodeUnitsNoCopy</span><span class="k">:</span> <span class="kt">CConstPointer&lt;unichar&gt;</span><span class="o">,</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">freeWhenDone</span> <span class="n">flag</span><span class="k">:</span> <span class="kt">Bool</span><span class="o">)</span>
  <span class="nf">init</span><span class="o">(</span><span class="n">format</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">_</span> <span class="nc">_arguments</span><span class="k">:</span> <span class="kt">CVarArg...</span><span class="o">)</span>
  <span class="nf">init</span><span class="o">(</span><span class="n">format</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">arguments</span><span class="k">:</span> <span class="kt">CVarArg</span><span class="o">[])</span>
  <span class="nf">init</span><span class="o">(</span><span class="n">format</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">locale</span><span class="k">:</span> <span class="kt">NSLocale?</span><span class="o">,</span> <span class="k">_</span> <span class="n">args</span><span class="k">:</span> <span class="kt">CVarArg...</span><span class="o">)</span>
  <span class="nf">init</span><span class="o">(</span><span class="n">format</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">locale</span><span class="k">:</span> <span class="kt">NSLocale?</span><span class="o">,</span> <span class="n">arguments</span><span class="k">:</span> <span class="kt">CVarArg</span><span class="o">[])</span>
  <span class="k">var</span> <span class="n">lastPathComponent</span><span class="k">:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">var</span> <span class="kt">utf16count:</span> <span class="kt">Int</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">func</span> <span class="kt">lengthOfBytesUsingEncoding</span><span class="o">(</span><span class="kt">encoding:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="kt">-&gt;</span> <span class="kt">Int</span>
  <span class="n">func</span> <span class="nf">lineRangeForRange</span><span class="o">(</span><span class="n">aRange</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Range</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">.</span><span class="py">Index</span><span class="o">&gt;</span>
  <span class="n">func</span> <span class="nf">linguisticTagsInRange</span><span class="o">(</span><span class="n">range</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">,</span> <span class="n">scheme</span> <span class="n">tagScheme</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">options</span> <span class="n">opts</span><span class="k">:</span> <span class="kt">NSLinguisticTaggerOptions</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">orthography</span><span class="k">:</span> <span class="kt">NSOrthography?</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">tokenRanges</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;Range&lt;String.Index&gt;</span><span class="err">[]</span><span class="kt">&gt;</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">[]</span>
  <span class="n">func</span> <span class="nf">localizedCaseInsensitiveCompare</span><span class="o">(</span><span class="n">aString</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">NSComparisonResult</span>
  <span class="n">func</span> <span class="nf">localizedCompare</span><span class="o">(</span><span class="n">aString</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">NSComparisonResult</span>
  <span class="n">func</span> <span class="nf">localizedStandardCompare</span><span class="o">(</span><span class="n">string</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">NSComparisonResult</span>
  <span class="n">func</span> <span class="nf">lowercaseStringWithLocale</span><span class="o">(</span><span class="n">locale</span><span class="k">:</span> <span class="kt">NSLocale</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">maximumLengthOfBytesUsingEncoding</span><span class="o">(</span><span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Int</span>
  <span class="n">func</span> <span class="nf">paragraphRangeForRange</span><span class="o">(</span><span class="n">aRange</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Range</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">.</span><span class="py">Index</span><span class="o">&gt;</span>
  <span class="k">var</span> <span class="n">pathComponents</span><span class="k">:</span> <span class="kt">String</span><span class="o">[]</span> <span class="o">{</span> <span class="n">get</span> <span class="o">}</span>
  <span class="k">var</span> <span class="n">pathExtension</span><span class="k">:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">var</span> <span class="kt">precomposedStringWithCanonicalMapping:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">var</span> <span class="kt">precomposedStringWithCompatibilityMapping:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">func</span> <span class="kt">propertyList</span><span class="o">()</span> <span class="kt">-&gt;</span> <span class="kt">AnyObject</span>
  <span class="n">func</span> <span class="nf">propertyListFromStringsFileFormat</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">Dictionary</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span>
  <span class="n">func</span> <span class="nf">rangeOfCharacterFromSet</span><span class="o">(</span><span class="n">aSet</span><span class="k">:</span> <span class="kt">NSCharacterSet</span><span class="o">,</span> <span class="n">options</span> <span class="n">mask</span><span class="k">:</span> <span class="kt">NSStringCompareOptions</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">range</span> <span class="n">aRange</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;?</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Range</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">.</span><span class="py">Index</span><span class="o">&gt;</span>
  <span class="n">func</span> <span class="nf">rangeOfComposedCharacterSequenceAtIndex</span><span class="o">(</span><span class="n">anIndex</span><span class="k">:</span> <span class="kt">String.Index</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Range</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">.</span><span class="py">Index</span><span class="o">&gt;</span>
  <span class="n">func</span> <span class="nf">rangeOfComposedCharacterSequencesForRange</span><span class="o">(</span><span class="n">range</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Range</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">.</span><span class="py">Index</span><span class="o">&gt;</span>
  <span class="n">func</span> <span class="nf">rangeOfString</span><span class="o">(</span><span class="n">aString</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">options</span> <span class="n">mask</span><span class="k">:</span> <span class="kt">NSStringCompareOptions</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">range</span> <span class="n">searchRange</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;?</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">locale</span><span class="k">:</span> <span class="kt">NSLocale?</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Range</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">.</span><span class="py">Index</span><span class="o">&gt;</span>
  <span class="k">var</span> <span class="n">smallestEncoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">func</span> <span class="kt">stringByAbbreviatingWithTildeInPath</span><span class="o">()</span> <span class="kt">-&gt;</span> <span class="kt">String</span>
  <span class="n">func</span> <span class="nf">stringByAddingPercentEncodingWithAllowedCharacters</span><span class="o">(</span><span class="n">allowedCharacters</span><span class="k">:</span> <span class="kt">NSCharacterSet</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">stringByAddingPercentEscapesUsingEncoding</span><span class="o">(</span><span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">stringByAppendingFormat</span><span class="o">(</span><span class="n">format</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">_</span> <span class="n">arguments</span><span class="k">:</span> <span class="kt">CVarArg...</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">stringByAppendingPathComponent</span><span class="o">(</span><span class="n">aString</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">stringByAppendingPathExtension</span><span class="o">(</span><span class="n">ext</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">stringByAppendingString</span><span class="o">(</span><span class="n">aString</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="k">var</span> <span class="n">stringByDeletingLastPathComponent</span><span class="k">:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">var</span> <span class="kt">stringByDeletingPathExtension:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">var</span> <span class="kt">stringByExpandingTildeInPath:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">func</span> <span class="kt">stringByFoldingWithOptions</span><span class="o">(</span><span class="kt">options:</span> <span class="kt">NSStringCompareOptions</span><span class="o">,</span> <span class="kt">locale:</span> <span class="kt">NSLocale</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">stringByPaddingToLength</span><span class="o">(</span><span class="n">newLength</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">withString</span> <span class="n">padString</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">startingAtIndex</span> <span class="n">padIndex</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="k">var</span> <span class="n">stringByRemovingPercentEncoding</span><span class="k">:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">func</span> <span class="kt">stringByReplacingCharactersInRange</span><span class="o">(</span><span class="kt">range:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">,</span> <span class="kt">withString</span> <span class="kt">replacement:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">stringByReplacingOccurrencesOfString</span><span class="o">(</span><span class="n">target</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">withString</span> <span class="n">replacement</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">options</span><span class="k">:</span> <span class="kt">NSStringCompareOptions</span> <span class="o">=</span> <span class="n">default</span><span class="o">,</span> <span class="n">range</span> <span class="n">searchRange</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;?</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">stringByReplacingPercentEscapesUsingEncoding</span><span class="o">(</span><span class="n">encoding</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="k">var</span> <span class="n">stringByResolvingSymlinksInPath</span><span class="k">:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">var</span> <span class="kt">stringByStandardizingPath:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">func</span> <span class="kt">stringByTrimmingCharactersInSet</span><span class="o">(</span><span class="kt">set:</span> <span class="kt">NSCharacterSet</span><span class="o">)</span> <span class="kt">-&gt;</span> <span class="kt">String</span>
  <span class="n">func</span> <span class="nf">stringsByAppendingPaths</span><span class="o">(</span><span class="n">paths</span><span class="k">:</span> <span class="kt">String</span><span class="o">[])</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">[]</span>
  <span class="n">func</span> <span class="nf">substringFromIndex</span><span class="o">(</span><span class="n">index</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">substringToIndex</span><span class="o">(</span><span class="n">index</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">substringWithRange</span><span class="o">(</span><span class="n">aRange</span><span class="k">:</span> <span class="kt">Range&lt;String.Index&gt;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">uppercaseStringWithLocale</span><span class="o">(</span><span class="n">locale</span><span class="k">:</span> <span class="kt">NSLocale</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">String</span>
  <span class="n">func</span> <span class="nf">writeToFile</span><span class="o">(</span><span class="n">path</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">atomically</span> <span class="n">useAuxiliaryFile</span><span class="k">:</span> <span class="kt">Bool</span><span class="o">,</span> <span class="n">encoding</span> <span class="n">enc</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">,</span> <span class="n">error</span><span class="k">:</span> <span class="kt">NSErrorPointer</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
  <span class="n">func</span> <span class="nf">writeToURL</span><span class="o">(</span><span class="n">url</span><span class="k">:</span> <span class="kt">NSURL</span><span class="o">,</span> <span class="n">atomically</span> <span class="n">useAuxiliaryFile</span><span class="k">:</span> <span class="kt">Bool</span><span class="o">,</span> <span class="n">encoding</span> <span class="n">enc</span><span class="k">:</span> <span class="kt">NSStringEncoding</span><span class="o">,</span> <span class="n">error</span><span class="k">:</span> <span class="kt">NSErrorPointer</span> <span class="o">=</span> <span class="n">default</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
</code></pre></div></div>

<h3 id="coregraphics">CoreGraphics</h3>

<p>几个常用基本类型都有了 Swift-style 的构造函数。其中 <code class="language-plaintext highlighter-rouge">CGRect</code> 有很多的相关运算都被封装为方法，很不错。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">extension</span> <span class="nc">CGPoint</span> <span class="k">:</span> <span class="kt">Equatable</span> <span class="o">{</span>
  <span class="kt">static</span> <span class="kt">var</span> <span class="kt">zeroPoint:</span> <span class="kt">CGPoint</span>
  <span class="kt">init</span><span class="o">()</span>
  <span class="kt">init</span><span class="o">(</span><span class="kt">x:</span> <span class="kt">Int</span><span class="o">,</span> <span class="kt">y:</span> <span class="kt">Int</span><span class="o">)</span>
<span class="o">}</span>
<span class="n">extension</span> <span class="nc">CGSize</span> <span class="o">{</span>
  <span class="n">static</span> <span class="k">var</span> <span class="n">zeroSize</span><span class="k">:</span> <span class="kt">CGSize</span>
  <span class="nf">init</span><span class="o">()</span>
  <span class="nf">init</span><span class="o">(</span><span class="n">width</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">height</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
<span class="o">}</span>
<span class="n">extension</span> <span class="nc">CGVector</span> <span class="o">{</span>
  <span class="n">static</span> <span class="k">var</span> <span class="n">zeroVector</span><span class="k">:</span> <span class="kt">CGVector</span>
  <span class="nf">init</span><span class="o">(</span><span class="k">_</span> <span class="n">dx</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">,</span> <span class="k">_</span> <span class="n">dy</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">)</span>
  <span class="nf">init</span><span class="o">(</span><span class="k">_</span> <span class="n">dx</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="k">_</span> <span class="n">dy</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
<span class="o">}</span>
<span class="n">extension</span> <span class="nc">CGRect</span> <span class="k">:</span> <span class="kt">Equatable</span> <span class="o">{</span>
  <span class="c1">// 全为 0</span>
  <span class="kt">static</span> <span class="kt">var</span> <span class="kt">zeroRect:</span> <span class="kt">CGRect</span>
  <span class="c1">// 原点为无穷大，表示空</span>
  <span class="n">static</span> <span class="k">var</span> <span class="n">nullRect</span><span class="k">:</span> <span class="kt">CGRect</span>
  <span class="c1">// 原点无穷小，宽高无穷大</span>
  <span class="n">static</span> <span class="k">var</span> <span class="n">infiniteRect</span><span class="k">:</span> <span class="kt">CGRect</span>
  <span class="nf">init</span><span class="o">()</span>
  <span class="nf">init</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">,</span> <span class="n">width</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">,</span> <span class="n">height</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">)</span>
  <span class="nf">init</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">width</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">height</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
  <span class="k">var</span> <span class="n">width</span><span class="k">:</span> <span class="kt">CGFloat</span>
  <span class="k">var</span> <span class="n">height</span><span class="k">:</span> <span class="kt">CGFloat</span>
  <span class="k">var</span> <span class="n">minX</span><span class="k">:</span> <span class="kt">CGFloat</span>
  <span class="k">var</span> <span class="n">minY</span><span class="k">:</span> <span class="kt">CGFloat</span>
  <span class="c1">// 中点</span>
  <span class="k">var</span> <span class="n">midX</span><span class="k">:</span> <span class="kt">CGFloat</span>
  <span class="k">var</span> <span class="n">midY</span><span class="k">:</span> <span class="kt">CGFloat</span>
  <span class="k">var</span> <span class="n">maxX</span><span class="k">:</span> <span class="kt">CGFloat</span>
  <span class="k">var</span> <span class="n">maxY</span><span class="k">:</span> <span class="kt">CGFloat</span>
  <span class="k">var</span> <span class="n">isNull</span><span class="k">:</span> <span class="kt">Bool</span>
  <span class="k">var</span> <span class="n">isEmpty</span><span class="k">:</span> <span class="kt">Bool</span>
  <span class="k">var</span> <span class="n">isInfinite</span><span class="k">:</span> <span class="kt">Bool</span>
  <span class="k">var</span> <span class="n">standardizedRect</span><span class="k">:</span> <span class="kt">CGRect</span>
  <span class="n">func</span> <span class="nf">standardize</span><span class="o">()</span>
  <span class="k">var</span> <span class="n">integerRect</span><span class="k">:</span> <span class="kt">CGRect</span>
  <span class="n">func</span> <span class="nf">integerize</span><span class="o">()</span>
  <span class="n">func</span> <span class="nf">rectByInsetting</span><span class="o">(</span><span class="k">#</span><span class="n">dx</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">,</span> <span class="n">dy</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">CGRect</span>
  <span class="n">func</span> <span class="nf">inset</span><span class="o">(</span><span class="k">#</span><span class="n">dx</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">,</span> <span class="n">dy</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">)</span>
  <span class="n">func</span> <span class="nf">rectByOffsetting</span><span class="o">(</span><span class="k">#</span><span class="n">dx</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">,</span> <span class="n">dy</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">CGRect</span>
  <span class="n">func</span> <span class="nf">offset</span><span class="o">(</span><span class="k">#</span><span class="n">dx</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">,</span> <span class="n">dy</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">)</span>
  <span class="n">func</span> <span class="nf">rectByUnion</span><span class="o">(</span><span class="n">withRect</span><span class="k">:</span> <span class="kt">CGRect</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">CGRect</span>
  <span class="n">func</span> <span class="nf">union</span><span class="o">(</span><span class="n">withRect</span><span class="k">:</span> <span class="kt">CGRect</span><span class="o">)</span>
  <span class="n">func</span> <span class="nf">rectByIntersecting</span><span class="o">(</span><span class="n">withRect</span><span class="k">:</span> <span class="kt">CGRect</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">CGRect</span>
  <span class="n">func</span> <span class="nf">intersect</span><span class="o">(</span><span class="n">withRect</span><span class="k">:</span> <span class="kt">CGRect</span><span class="o">)</span>
  <span class="n">func</span> <span class="nf">rectsByDividing</span><span class="o">(</span><span class="n">atDistance</span><span class="k">:</span> <span class="kt">CGFloat</span><span class="o">,</span> <span class="n">fromEdge</span><span class="k">:</span> <span class="kt">CGRectEdge</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">slice</span><span class="k">:</span> <span class="kt">CGRect</span><span class="o">,</span> <span class="n">remainder</span><span class="k">:</span> <span class="kt">CGRect</span><span class="o">)</span>
  <span class="n">func</span> <span class="nf">contains</span><span class="o">(</span><span class="n">rect</span><span class="k">:</span> <span class="kt">CGRect</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
  <span class="n">func</span> <span class="nf">contains</span><span class="o">(</span><span class="n">point</span><span class="k">:</span> <span class="kt">CGPoint</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
  <span class="n">func</span> <span class="nf">intersects</span><span class="o">(</span><span class="n">rect</span><span class="k">:</span> <span class="kt">CGRect</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="appkit">AppKit</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">extension</span> <span class="nc">NSGradient</span> <span class="o">{</span>
  <span class="n">convenience</span> <span class="nf">init</span><span class="o">(</span><span class="n">colorsAndLocations</span> <span class="n">objects</span><span class="k">:</span> <span class="o">(</span><span class="kt">AnyObject</span><span class="o">,</span> <span class="kt">CGFloat</span><span class="o">)...)</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="uikit">UIKit</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">extension</span> <span class="nc">UIDeviceOrientation</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">isPortrait</span><span class="k">:</span> <span class="kt">Bool</span>
  <span class="c1">// also isLandscape isValidInterfaceOrientation isFlat</span>
<span class="o">}</span>
<span class="n">extension</span> <span class="nc">UIInterfaceOrientation</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">isPortrait</span><span class="k">:</span> <span class="kt">Bool</span>
  <span class="k">var</span> <span class="n">isLandscape</span><span class="k">:</span> <span class="kt">Bool</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这个模块是交叉编译的。。不太容易获得信息。不过好在扩展内容不多。</p>

<h3 id="spritekit">SpriteKit</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">extension</span> <span class="nc">SKNode</span> <span class="o">{</span>
  <span class="nd">@objc</span> <span class="nf">subscript</span> <span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">SKNode</span><span class="o">[]</span> <span class="o">{</span> <span class="n">get</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="特殊-mirror-实现">特殊 Mirror 实现</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NSSet NSDate NSArray NSRange NSURL NSDictionary NSString
CGPoint CGRect CGSize
NSView
UIView
SKTextureAtlas SKTexture SKSpriteNode SKShapeNode
</code></pre></div></div>

<p>单独添加了自己的 <code class="language-plaintext highlighter-rouge">Mirror</code> 类型，单独实现。</p>

<p><code class="language-plaintext highlighter-rouge">Mirror</code> 类型其实是为 <code class="language-plaintext highlighter-rouge">QuickLookObject</code> 准备的，也就是在 Xcode Playground 中快速查看。</p>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[最近看到了 Swift Style Guide 个人觉得内容太少， Swift 本身作为一门庞大的语言，语素众多。本文就 Swift 本身对 Cocoa 的扩展，看看对日常 Cocoa 风格有什么影响。]]></summary></entry><entry><title type="html">Swift Type Hierarchy ( Swift 类型层次结构 ）</title><link href="https://andelf.github.io/blog/2014/06/30/swift-type-hierarchy/" rel="alternate" type="text/html" title="Swift Type Hierarchy ( Swift 类型层次结构 ）" /><published>2014-06-30T07:10:41+00:00</published><updated>2014-06-30T07:10:41+00:00</updated><id>https://andelf.github.io/blog/2014/06/30/swift-type-hierarchy</id><content type="html" xml:base="https://andelf.github.io/blog/2014/06/30/swift-type-hierarchy/"><![CDATA[<p>声明： 转载请注明，方便的情况下请知会本人. <a href="http://weibo.com/234632333">weibo</a></p>

<p>本文主要介绍 Swift 所有标准库类型的层次结构，及所有标准类型。本文可作为参考手册使用。</p>

<p>本人不保证内容及时性和正确性，请善于怀疑并反馈。谢谢。</p>

<p>本文探索 Swift 所有基础类型和高级类型，以及所有协议和他们之间的继承关系。</p>

<p>为了简化问题，某些类型略去了中间的过渡类型，人肉保证不歧义。</p>

<h2 id="swift-基础类型">Swift 基础类型</h2>

<h3 id="数值类型">数值类型</h3>

<h4 id="位">位</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Bit
</code></pre></div></div>

<p>只有一位，实现为 <code class="language-plaintext highlighter-rouge">enum</code>， <code class="language-plaintext highlighter-rouge">.zero</code> 或 <code class="language-plaintext highlighter-rouge">.one</code>。简单明了。</p>

<p>协议: <code class="language-plaintext highlighter-rouge">RandomAccessIndex IntegerArithmetic</code></p>

<h4 id="整型">整型</h4>

<p>有符号:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Int Int8 Int16 Int32 Int64
</code></pre></div></div>

<p>协议：<code class="language-plaintext highlighter-rouge">SignedInteger RandomAccessIndex BitwiseOperations SignedNumber CVarArg</code></p>

<p>无符号:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UInt UInt8 UInt16 UInt32 UInt64
</code></pre></div></div>
<p>协议：<code class="language-plaintext highlighter-rouge">UnsignedInteger RandomAccessIndex BitwiseOperations</code></p>

<p>别名:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IntMax = Int64
UIntMax = UInt64
IntegerLiteralType = Int
Word = Int // 字长
UWord = UInt
</code></pre></div></div>

<h4 id="浮点型">浮点型</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Float Double Float80
</code></pre></div></div>

<p>别名：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FloatLiteralType = Double
Float64 = Double
</code></pre></div></div>

<p>协议：<code class="language-plaintext highlighter-rouge">FloatingPointNumber</code>。</p>

<h3 id="逻辑型">逻辑型</h3>

<p>只有一个 <code class="language-plaintext highlighter-rouge">Bool</code>。</p>

<p>实例： <code class="language-plaintext highlighter-rouge">true</code>、<code class="language-plaintext highlighter-rouge">false</code></p>

<p>协议：<code class="language-plaintext highlighter-rouge">LogicValue</code>。</p>

<h3 id="空">空</h3>

<p>只有一个 <code class="language-plaintext highlighter-rouge">NilType</code>。</p>

<p>唯一实例 <code class="language-plaintext highlighter-rouge">nil</code>。</p>

<h3 id="字符串类型">字符（串）类型</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">String</code></li>
  <li><code class="language-plaintext highlighter-rouge">Character</code> Unicode 字符</li>
  <li><code class="language-plaintext highlighter-rouge">UnicodeScalar</code> 相当于 C 中的 <code class="language-plaintext highlighter-rouge">wchar_t</code></li>
  <li><code class="language-plaintext highlighter-rouge">CString</code> 用于表示 C 中的 <code class="language-plaintext highlighter-rouge">const char *</code>，请参考相关文章</li>
  <li><code class="language-plaintext highlighter-rouge">StaticString</code> 静态字符串，内部使用，例如 <code class="language-plaintext highlighter-rouge">fatalError</code></li>
</ul>

<p>别名：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>StringLiteralType = String
ExtendedGraphemeClusterType = String
</code></pre></div></div>

<p>官方文档</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">Character</code> represents some Unicode grapheme cluster as
defined by a canonical, localized, or otherwise tailored
segmentation algorithm.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">String</code> 实现协议：<code class="language-plaintext highlighter-rouge">Collection ExtensibleCollection OutputStream TargetStream</code>。</p>

<h3 id="array-类型">Array 类型</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Array&lt;T&gt;</code></li>
  <li><code class="language-plaintext highlighter-rouge">ContiguousArray&lt;T&gt;</code></li>
</ul>

<p>实现协议 <code class="language-plaintext highlighter-rouge">ArrayType</code>。</p>

<p>内部容器：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ArrayBuffer&lt;T&gt;</code></li>
  <li><code class="language-plaintext highlighter-rouge">ContiguousArrayBuffer&lt;T&gt;</code></li>
</ul>

<p>这两个类型看起来是 Array 的内部容器，一般不应该直接使用。</p>

<h3 id="字典类型">字典类型</h3>

<p><code class="language-plaintext highlighter-rouge">Dictionary&lt;KeyType : Hashable, ValueType&gt;</code></p>

<p>只实现了 <code class="language-plaintext highlighter-rouge">Collection</code>。</p>

<h3 id="元祖类型">元祖类型</h3>

<p>除正常元祖外，还有个特殊的别名</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Void = ()
</code></pre></div></div>

<p>其实很多语言都这么定义的，比如 Haskell 。</p>

<h3 id="optional-类型">Optional 类型</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Optional&lt;T&gt;</code> 即 <code class="language-plaintext highlighter-rouge">T?</code></li>
  <li><code class="language-plaintext highlighter-rouge">ImplicitlyUnwrappedOptional&lt;T&gt;</code> 即 <code class="language-plaintext highlighter-rouge">T!</code></li>
</ul>

<p>实现协议: <code class="language-plaintext highlighter-rouge">LogicValue</code>，行为是判断是否为 <code class="language-plaintext highlighter-rouge">.None</code>。</p>

<p>另外 <a href="http://andelf.github.io/blog/2014/06/08/swift-implicit-type-cast/">Swift 的隐式类型转换</a>
有提到，为什么 <code class="language-plaintext highlighter-rouge">nil</code> 可以给 <code class="language-plaintext highlighter-rouge">Optional</code> 类型赋值的问题。</p>

<h3 id="cobjc-兼容类型">C/ObjC 兼容类型</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CBool = Bool
CFloat = Float
CDouble = Double
CChar = Int8
CSignedChar = Int8
CUnsignedChar = UInt8
CChar16 = UInt16
CWideChar = UnicodeScalar
CChar32 = UnicodeScalar
CInt = Int32
CUnsignedInt = UInt32
CShort = Int16
CUnsignedShort = UInt16
CLong = Int
CUnsignedLong = UInt
CLongLong = Int64
CUnsignedLongLong = UInt64
</code></pre></div></div>

<p>具体使用参考 C 交互的几篇文章，基本没区别。</p>

<h3 id="any-类型">Any 类型</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AnyObject
// 别名
Any = protocol&lt;&gt;
AnyClass = AnyObject.Type
</code></pre></div></div>

<p>还有个用在函数定义的类型签名上， <code class="language-plaintext highlighter-rouge">Any.Type</code>。</p>

<p>顺便这里看到一个奇异的语法 <code class="language-plaintext highlighter-rouge">protocol&lt;&gt;</code>，这个也是 Swift 一种用来表示类型限制的方法，可以用在类型的位置，尖括号里可以是协议的列表。</p>

<h3 id="指针类型">指针类型</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UnsafePointer&lt;T&gt;
CMutableVoidPointer
CConstVoidPointer
COpaquePointer
CConstPointer&lt;T&gt;
AutoreleasingUnsafePointer&lt;T&gt;
CVaListPointer
CMutablePointer&lt;T&gt;
</code></pre></div></div>

<p>参考 C 交互文章。</p>

<ul>
  <li><a href="http://andelf.github.io/blog/2014/06/15/swift-and-c-interop/">简析Swift和C的交互</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/18/swift-and-c-interop-cont/">简析 Swift 和 C 的交互，Part 二</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/28/swift-interop-with-c-slash-objc/">Swift 与 ObjC 和 C 的交互，第三部分</a></li>
</ul>

<h3 id="其他辅助类型">其他辅助类型</h3>

<p>多了去了。比如 for-in 实现时候的 Generator 、比如反射时候用的 <code class="language-plaintext highlighter-rouge">*Mirror</code>、比如切片操作用的 <code class="language-plaintext highlighter-rouge">Range&lt;T&gt;</code>。比如内部储存类。</p>

<p>还有储存辅助类 <code class="language-plaintext highlighter-rouge">OnHeap&lt;T&gt;</code> 等等。以后有机会再探索。</p>

<h2 id="swift-标准库协议">Swift 标准库协议</h2>

<h3 id="打印相关-printable-debugprintable">打印相关 <code class="language-plaintext highlighter-rouge">Printable DebugPrintable</code></h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">protocol</span> <span class="nc">Printable</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
<span class="o">}</span>
<span class="n">protocol</span> <span class="nc">DebugPrintable</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">debugDescription</span><span class="k">:</span> <span class="kt">String</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>用于打印和字符串的 Interpolation 。</p>

<h3 id="literalconvertible"><code class="language-plaintext highlighter-rouge">*LiteralConvertible</code></h3>

<p>从字面常量获取。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ArrayLiteralConvertible
IntegerLiteralConvertible
DictionaryLiteralConvertible
CharacterLiteralConvertible
FloatLiteralConvertible
ExtendedGraphemeClusterLiteralConvertible
StringLiteralConvertible
</code></pre></div></div>

<p>其中字符串和字符的字面常量表示有所重合，也就是说 <code class="language-plaintext highlighter-rouge">"a"</code> 可以是字符串也可以是字符。<a href="http://andelf.github.io/blog/2014/06/17/nsobject-pattern-match-in-swift/">简析 Swift 中的 Pattern Match</a> 一文中就是遇到了类似的情况。</p>

<h3 id="logicvalue"><code class="language-plaintext highlighter-rouge">LogicValue</code></h3>

<p>相当于重载 <code class="language-plaintext highlighter-rouge">if</code>、<code class="language-plaintext highlighter-rouge">while</code> 的行为。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">protocol</span> <span class="nc">LogicValue</span> <span class="o">{</span>
  <span class="n">func</span> <span class="nf">getLogicValue</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="sequence"><code class="language-plaintext highlighter-rouge">Sequence</code></h3>

<p>相当于重载 for-in 。和 <code class="language-plaintext highlighter-rouge">Generator</code> 联用。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">protocol</span> <span class="nc">Sequence</span> <span class="o">{</span>
  <span class="n">typealias</span> <span class="nc">GeneratorType</span> <span class="k">:</span> <span class="kt">Generator</span>
  <span class="n">func</span> <span class="nf">generate</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">GeneratorType</span>
<span class="o">}</span>

<span class="n">protocol</span> <span class="nc">Generator</span> <span class="o">{</span>
  <span class="n">typealias</span> <span class="nc">Element</span>
  <span class="n">mutating</span> <span class="n">func</span> <span class="nf">next</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">Element</span><span class="o">?</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// for .. in { }</span>
<span class="k">var</span> <span class="nc">__g</span> <span class="k">=</span> <span class="nv">someSequence</span><span class="o">.</span><span class="py">generate</span><span class="o">()</span>
<span class="k">while</span> <span class="n">let</span> <span class="n">x</span> <span class="k">=</span> <span class="nv">__g</span><span class="o">.</span><span class="py">next</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}}</span>
</code></pre></div></div>

<h3 id="整型-index-相关协议">整型、 Index 相关协议</h3>

<p>这些协议都是用来表示容器类型的索引、及相关的索引运算。</p>

<p>这里略去了部分私有内容。略去了 <code class="language-plaintext highlighter-rouge">Printable</code> 等。</p>

<p><img src="/assets/swift-integer.png" alt="Swift Integer Type Hierarchy" /></p>

<h3 id="rawoptionset-相关协议">RawOptionSet 相关协议</h3>

<p>一般用来表示二进制的选项，类似于 C enum ，很多 Cocoa 的 flag 被映射到它。相当于一个 Wrapper 的作用。</p>

<p><img src="/assets/swift-rawoptset.png" alt="Swift RawOptionSet" /></p>

<p>可以看到要求被 Wrap 的对象支持 <code class="language-plaintext highlighter-rouge">BitwiseOperations</code>。</p>

<h3 id="array-相关协议">Array 相关协议</h3>

<p>图中用虚线标注了和 <code class="language-plaintext highlighter-rouge">Generator</code> 的关系。</p>

<p><img src="/assets/swift-collection.png" alt="Swift Collection Protocol" /></p>

<p><code class="language-plaintext highlighter-rouge">Array&lt;T&gt;</code> 类型实现了 <code class="language-plaintext highlighter-rouge">ArrayType</code> 协议。</p>

<p><code class="language-plaintext highlighter-rouge">Dictionary</code> 类型实现了 <code class="language-plaintext highlighter-rouge">Collection</code> 协议。</p>

<h3 id="反射相关协议">反射相关协议</h3>

<p>包括 <code class="language-plaintext highlighter-rouge">Mirror</code>、<code class="language-plaintext highlighter-rouge">MirrorDisposition</code>、<code class="language-plaintext highlighter-rouge">Reflectable</code>。</p>

<p>请参考 <a href="http://andelf.github.io/blog/2014/06/20/swift-reflection/">Swift 的反射</a>。</p>

<h3 id="浮点数协议">浮点数协议</h3>

<p>只有一个 <code class="language-plaintext highlighter-rouge">FloatingPointNumber</code>。单独存在。是为了定义完整而存在。看官自己搞定。</p>

<h3 id="io-输出伪输出相关">IO 输出，伪输出相关</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protocol Streamable {
  func writeTo&lt;Target : OutputStream&gt;(inout target: Target)
}
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Streamable</code> 表示可以被写入到输出流中，比如字符串、字符等。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protocol OutputStream {
  func write(string: String)
}
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">OutputStream</code> 表示一个输出流，比如标准输出（<code class="language-plaintext highlighter-rouge">stdout</code>），也可以表示一个伪输出流，例如字符串 <code class="language-plaintext highlighter-rouge">String</code>。</p>

<p>标准输出的获取方法</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var stdout = _Stdout()
</code></pre></div></div>

<p>看起来是私有结构，某一天不能用的话，别怪我。调用时候用 <code class="language-plaintext highlighter-rouge">inout</code> 引用语法。</p>

<h3 id="cvararg-处理">CVarArg 处理</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protocol CVarArg {
  func encode() -&gt; Word[]
}
</code></pre></div></div>

<p>用于处理 C 函数的可变参数，参考 <a href="http://andelf.github.io/blog/2014/06/18/swift-and-c-interop-cont/">简析 Swift 和 C 的交互，Part 二</a>。</p>

<h3 id="bridge-协议">Bridge 协议</h3>

<p>这里有个疑问就是编译过程中这些 Bridge 协议有没有参与。目前还没办法确定。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">_BridgedToObjectiveC</code></li>
  <li><code class="language-plaintext highlighter-rouge">_ConditionallyBridgedToObjectiveC</code></li>
</ul>

<p>具体内容可以参考 <a href="http://andelf.github.io/blog/2014/06/11/swift-and-objectivec-interop/">Swift 与 Objective-C 之间的交互</a>一文。</p>

<h3 id="其他">其他</h3>

<p><code class="language-plaintext highlighter-rouge">Sink</code> 看起来是一个容器，可能是用来编码时使用。</p>

<p><code class="language-plaintext highlighter-rouge">ArrayBufferType</code> 用于表示 <code class="language-plaintext highlighter-rouge">ArrayType</code> 的内部储存，看起来似乎也可以直接用。</p>

<p><code class="language-plaintext highlighter-rouge">UnicodeCodec</code> 用于处理编码。有 <code class="language-plaintext highlighter-rouge">UTF8</code>、<code class="language-plaintext highlighter-rouge">UTF16</code>、<code class="language-plaintext highlighter-rouge">UTF32</code> 可用。</p>

<p><code class="language-plaintext highlighter-rouge">ArrayBound</code> 用来处理数组边界，详细原理和作用过程未知。</p>

<h2 id="总结">总结</h2>

<p>无。</p>

<p>参考：</p>

<ul>
  <li><a href="https://github.com/andelf/Defines-Swift">我的 Github andelf/Defines-Swift</a></li>
</ul>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[声明： 转载请注明，方便的情况下请知会本人. weibo]]></summary></entry><entry><title type="html">My View of Swift （闲扯对 Swift 语言的看法）</title><link href="https://andelf.github.io/blog/2014/06/30/my-view-of-swift/" rel="alternate" type="text/html" title="My View of Swift （闲扯对 Swift 语言的看法）" /><published>2014-06-30T03:05:13+00:00</published><updated>2014-06-30T03:05:13+00:00</updated><id>https://andelf.github.io/blog/2014/06/30/my-view-of-swift</id><content type="html" xml:base="https://andelf.github.io/blog/2014/06/30/my-view-of-swift/"><![CDATA[<p>其实这是很早就像要说的了，大概当时信誓旦旦说要看完那本 epub 写个读后感谈谈对 Swift 看法什么的。后来不了了之。
现在觉得这个时机或许差不多，对 Swift 的了解也算凑合了。</p>

<p>纯个人观点。</p>

<h3 id="swift-是系统编程语言">Swift 是系统编程语言</h3>

<p>一开始大家还不太了解的时候，可能会有很多误解。现在好歹一个月了。误解终于少了。</p>

<p>是的， Swift 是系统编程语言，原因是因为它 ABI 兼容 C （不包括 name mangling 部分）。基于强大的 llvm 生成具体平台代码。不是翻译为 Objective-C 的。</p>

<p>编译器参数还显示， Swift 文件的中间编译结果（介于 Swift 代码和 llvm ir ）是 SIL ，猜测是 Swift Intermediate Language 。好像和 llvm ir 有所联系。而且至少有两个 stage 。</p>

<p>不是脚本语言，也不是胶水语言。但是它的标准库 (import Swift 库) 几乎不含任何 IO 网络 等内容，随便做个功能强依赖 Cocoa 框架。也可以 <code class="language-plaintext highlighter-rouge">import Darwin</code> 用 C 语言的标准库来写。</p>

<p>猜测写个 Python C 模块这种任务是可以轻易胜任的。</p>

<p>而 Golang 、 Rust 本身 ABI 是和 C 不兼容的。虽然 Rust 通过 <code class="language-plaintext highlighter-rouge">extern "C"</code> 可以修改单个函数为兼容。</p>

<h3 id="swift-是现代语言">Swift 是现代语言</h3>

<p>自动类型推导、泛型、 LLVM 。当然语言研究党都知道这些都是几十年前的“新东西”。</p>

<h3 id="swift-是半完成品">Swift 是半完成品</h3>

<p>这么说主要是指 Swift 对 Cocoa 的库实在是太半吊子了。只是 Foundation 有 Bridge 支持，其他库中，明显的列表都无法支持 subscript 、 for-in 这样简单的操作。原因很简单，这些库都是自动转换 ObjC 头文件而来（参考模块那篇文章）。没有额外的封装代码。</p>

<p>所以其实真要用起来，可能会很纠结。或者可以预计很快就有第三方的 Bridge 库给这些类型加上舒服的 Swift 支持。</p>

<p>另外命令行没有静态链接库支持。只能用其他命令拼装。也侧面说明， Apple 希望开发者更多用动态链接库， Framework 。</p>

<p>另外目前的编译器 coredump 、 stackoverflow 太多太多。错哪都不知道。</p>

<h3 id="swift-隐藏细节太多">Swift 隐藏细节太多</h3>

<p>就对应到 Foundation 类型这个特性太说，太多黑魔法，隐式类型转换、 BridgeToObjectiveC 协议、指针类型转换。</p>

<p>这些隐藏的特性多少都会成为 Swift 的坑。</p>

<p>要知道定义在 ObjC 库的 <code class="language-plaintext highlighter-rouge">NSString</code> 参数某些情况下在 Swift 中被转换为 <code class="language-plaintext highlighter-rouge">String</code>。 <code class="language-plaintext highlighter-rouge">NSArray</code> 都被转换为 <code class="language-plaintext highlighter-rouge">AnyObject[]</code>。即使有隐式类型转换，某些极端情况下，还是会有编译时错误。</p>

<h3 id="swfit-的性能">Swfit 的性能</h3>

<p>我没做过测试，但就语言特性来说， Swift 是比 ObjC 快的，因为静态类型使得他在编译时就已经知道调用函数的具体位置。而不是 Objective-C 的消息发送、 Selector 机制。</p>

<p>目前来看， Swift 性能略差原因主要是编译器还没足够优化、还有就是 Cocoa 拖了后腿， Cocoa 本身有大量的 <code class="language-plaintext highlighter-rouge">AnyObject</code> 返回值。所以实际写 Swift 代码时，多用 <code class="language-plaintext highlighter-rouge">as</code> 一定是好习惯。明确类型。</p>

<h3 id="swift-的未来">Swift 的未来</h3>

<p>我不知道。至少好像感觉很多培训机构都看到了前途开始疯狂的做视频。</p>

<p>倒是觉得什么时候 Cocoa for Swift 出了才算它完全完成任务。</p>

<p>总觉得 Cocoa 拖后腿，不然放到其他平台也不错。</p>

<p>对了，之前不是在 App 开发领域，这才知道原来这个地盘水很深，太多唯利的培训机构，太多嗷嗷待哺等视频教程的新人。觉得挺有意思。就拿 ? ! 这个 Optional 为例，太多介绍的文章。可惜能说明白的太少太少。糊里糊涂做开发就是当前现状吧。</p>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[其实这是很早就像要说的了，大概当时信誓旦旦说要看完那本 epub 写个读后感谈谈对 Swift 看法什么的。后来不了了之。 现在觉得这个时机或许差不多，对 Swift 的了解也算凑合了。]]></summary></entry><entry><title type="html">Swift Interop with C/ObjC Part 3 (Swift 与 ObjC 和 C 的交互，第三部分）</title><link href="https://andelf.github.io/blog/2014/06/28/swift-interop-with-c-slash-objc/" rel="alternate" type="text/html" title="Swift Interop with C/ObjC Part 3 (Swift 与 ObjC 和 C 的交互，第三部分）" /><published>2014-06-28T13:58:35+00:00</published><updated>2014-06-28T13:58:35+00:00</updated><id>https://andelf.github.io/blog/2014/06/28/swift-interop-with-c-slash-objc</id><content type="html" xml:base="https://andelf.github.io/blog/2014/06/28/swift-interop-with-c-slash-objc/"><![CDATA[<p>声明： 转载请注明，方便的情况下请知会本人. <a href="http://weibo.com/234632333">weibo</a></p>

<p>之前说那是最后一篇。可惜越来越发现有很多东西还没介绍到。事不过三。再坑一篇。</p>

<h2 id="前言">前言</h2>

<p>本文解决如下问题</p>

<ul>
  <li>ObjC/C 中定义的某个类型、结构体，通过 Bridge Header 或者 Module 对应到 Swift 到底是什么类型</li>
  <li>指针间的转换问题</li>
</ul>

<p>补充之前没解决的一些问题，比如提到 <code class="language-plaintext highlighter-rouge">CMutablePointer</code> 的 <code class="language-plaintext highlighter-rouge">sizeof</code> 是两个字长，那么在函数调用中是如何对应到 C 的指针的？</p>

<p>预备内容：</p>

<ul>
  <li><a href="http://andelf.github.io/blog/2014/06/11/swift-and-objectivec-interop/">Swift 与 Objective-C 之间的交互</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/15/swift-and-c-interop/">简析Swift和C的交互</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/18/swift-and-c-interop-cont/">简析 Swift 和 C 的交互，Part 二</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/16/swift-nserror-internals/">Swift NSError Internals（解析 Swift 对 NSError 操作）</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/08/swift-implicit-type-cast/">Swift 的隐式类型转换</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/06/swift-attributes/">Swift Attributes</a></li>
</ul>

<h2 id="cobjc-to-swift-对应规则">C/ObjC to Swift 对应规则</h2>

<p>以下内容均适合 Objective-C 。第一部分适合 C 。</p>

<p><strong>以下内容再 Xcode6-beta3 中不适用</strong> 请参考 <a href="http://andelf.github.io/blog/2014/07/08/swift-beta3-changes/">Swift 在 Xcode6-beta3 中的变化</a>。</p>

<h3 id="for-c">for C</h3>

<h4 id="可导出的类型定义">可导出的类型定义</h4>

<p>函数、枚举、结构体、常量定义、宏定义。</p>

<p>结构体定义支持：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Name</span> <span class="p">{...}</span> <span class="n">Name</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">Name_t</span> <span class="p">{...}</span> <span class="n">Name</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Name</span> <span class="p">{</span> <span class="p">...</span> <span class="p">};</span>
</code></pre></div></div>

<p>其中无法处理的结构体、函数类型、 varargs 定义不导出。预计以后版本会修复。带 bit field 的结构体也无法识别。</p>

<h4 id="类型对应关系">类型对应关系</h4>

<p>仔细分析发现，诡异情况还很多。基础类型请参考上几篇。</p>

<p>在函数定义参数中：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">类型</th>
      <th style="text-align: center">对应为</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">void *</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">CMutableVoidPointer</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">Type *</code>、<code class="language-plaintext highlighter-rouge">Type[]</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">CMutablePointer&lt;Type&gt;</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">const char *</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">CString</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">const Type *</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">CConstPointer&lt;Type&gt;</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">const void *</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">CConstVoidPointer</code></td>
    </tr>
  </tbody>
</table>

<p>在函数返回、结构体字段中：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">类型</th>
      <th style="text-align: center">对应为</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">const char *</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">CString</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">Type *</code>、<code class="language-plaintext highlighter-rouge">const Type *</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">UnsafePointer&lt;Type&gt;</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">void *</code>、<code class="language-plaintext highlighter-rouge">const void *</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">COpaquePointer</code></td>
    </tr>
    <tr>
      <td style="text-align: center">无法识别的结构指针</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">COpaquePointer</code></td>
    </tr>
  </tbody>
</table>

<p>另外还有如下情况：</p>

<p>全局变量、全局常量(<code class="language-plaintext highlighter-rouge">const</code>)、宏定义常量(<code class="language-plaintext highlighter-rouge">#define</code>) 均使用 <code class="language-plaintext highlighter-rouge">var</code>，常量不带 <code class="language-plaintext highlighter-rouge">set</code>。</p>

<p>结构体中的数组，对应为元祖，例如 <code class="language-plaintext highlighter-rouge">int data[2]</code> 对应为 <code class="language-plaintext highlighter-rouge">(CInt, CInt)</code>，所以也许。。会很长。数组有多少元素就是几元祖。</p>

<h3 id="for-objc">for ObjC</h3>

<p>ObjC 明显情况要好的多，官方文档也很详细。</p>

<p>除了 <code class="language-plaintext highlighter-rouge">NSError **</code> 转为 <code class="language-plaintext highlighter-rouge">NSErrorPointer</code> 外，需要注意的就是：</p>

<p>函数参数、返回中的 <code class="language-plaintext highlighter-rouge">NSString *</code> 被替换为 <code class="language-plaintext highlighter-rouge">String!</code>、<code class="language-plaintext highlighter-rouge">NSArray *</code> 被替换为 <code class="language-plaintext highlighter-rouge">AnyObject[]!</code>。</p>

<p>而全局变量、常量的 <code class="language-plaintext highlighter-rouge">NSString *</code> 不变。</p>

<h2 id="关于-cmutablepointer-的行为">关于 <code class="language-plaintext highlighter-rouge">CMutablePointer</code> 的行为</h2>

<p>上回说到 <code class="language-plaintext highlighter-rouge">CMutablePointer</code>、<code class="language-plaintext highlighter-rouge">CConstPointer</code>、<code class="language-plaintext highlighter-rouge">CMutableVoidPointer</code>、<code class="language-plaintext highlighter-rouge">CConstVoidPointer</code>
四个指针类型的字长是 2，也就是说，不可以直接对应为 C 中的指针。但是前面说类型对应关系的时候， C 函数声明转为 Swift
时候又用到了这些类型，所以看起来自相矛盾。仔细分析了 lldb 反汇编代码后发现，有如下隐藏行为:</p>

<h3 id="in-swift">in Swift</h3>

<p>在纯 Swift 环境下，函数定义等等、这些类型字长都为 2，不会有任何意外情况出现。</p>

<h3 id="in-cobjc">in C/ObjC</h3>

<p>当一个函数的声明是由 Bridge Header 或者 LLVM Module 隐式转换而来，且用到了这四个指针类型，那么代码编译过程中类型转换规则、隐式转换调用等规则依然有效。只不过在代码最生成一步，会插入以下私有函数调用之一：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@transparent</span> <span class="n">func</span> <span class="nc">_convertCMutablePointerToUnsafePointer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">p</span><span class="k">:</span> <span class="kt">CMutablePointer&lt;T&gt;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">UnsafePointer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="nd">@transparent</span> <span class="n">func</span> <span class="nc">_convertCConstPointerToUnsafePointer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">p</span><span class="k">:</span> <span class="kt">CConstPointer&lt;T&gt;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">UnsafePointer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="nd">@transparent</span> <span class="n">func</span> <span class="nc">_convertCMutableVoidPointerToCOpaquePointer</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">CMutableVoidPointer</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">COpaquePointer</span>
<span class="nd">@transparent</span> <span class="n">func</span> <span class="nc">_convertCConstVoidPointerToCOpaquePointer</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">CConstVoidPointer</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">COpaquePointer</span>
</code></pre></div></div>

<p>这个过程是背后隐藏的。然后将转换的结果传参给对应的 C/ObjC 函数。实现了指针类型字长正确、一致。</p>

<h3 id="结论">结论</h3>

<p>作为程序员，需要保证调用 C 函数的时候类型一致。如果有特殊需求重新声明了对应的 C 函数，那么以上规则不起作用，所以重声明 C 中的函数时表示指针不可以使用这四个指针类型。</p>

<h2 id="再说指针">再说指针</h2>

<p><img src="/assets/swift-pointers.png" alt="Swift Pointers" /></p>

<p>虚线表示直接隐式类型转换。其中 <code class="language-plaintext highlighter-rouge">UnsafePointer&lt;T&gt;</code> 可以通过用其他任何指针调用构造函数获得。</p>

<p><code class="language-plaintext highlighter-rouge">CMutablePointer&lt;T&gt;</code> 和 <code class="language-plaintext highlighter-rouge">CMutableVoidPointer</code> 也可以通过 <code class="language-plaintext highlighter-rouge">Array&lt;T&gt;</code> 的引用隐式类型转换获得 （ <code class="language-plaintext highlighter-rouge">&amp;arr</code> ）。</p>

<p>椭圆表示类型 <code class="language-plaintext highlighter-rouge">sizeof</code> 为字长，可以用于声明 C 函数。</p>

<p>四大指针可以用 <code class="language-plaintext highlighter-rouge">withUnsafePointer</code> 操作。转换为 <code class="language-plaintext highlighter-rouge">UnsafePointer&lt;T&gt;</code>。上一节提到的私有转换函数请不要使用。</p>

<h2 id="字符串">字符串</h2>

<p>之前的文章已经介绍过怎么从 <code class="language-plaintext highlighter-rouge">CString</code> 获取 <code class="language-plaintext highlighter-rouge">String</code> （静态方法 <code class="language-plaintext highlighter-rouge">String.fromCString</code>）。</p>

<p>从 <code class="language-plaintext highlighter-rouge">String</code> 获取 <code class="language-plaintext highlighter-rouge">CString</code> 也说过， 是用 <code class="language-plaintext highlighter-rouge">withCString</code>。</p>

<p>也可以从 <code class="language-plaintext highlighter-rouge">CString(UnsafePointer.alloc(100))</code> 来分配空数组。</p>

<h2 id="参考">参考</h2>

<ul>
  <li><a href="https://github.com/andelf/Defines-Swift">我的 Github andelf/Defines-Swift</a></li>
</ul>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[声明： 转载请注明，方便的情况下请知会本人. weibo]]></summary></entry><entry><title type="html">Tilde Arrow in Swift （Swift 标准库中的波浪箭头 ~&amp;gt; ）</title><link href="https://andelf.github.io/blog/2014/06/25/tilde-arrow-in-swift/" rel="alternate" type="text/html" title="Tilde Arrow in Swift （Swift 标准库中的波浪箭头 ~&amp;gt; ）" /><published>2014-06-25T14:44:29+00:00</published><updated>2014-06-25T14:44:29+00:00</updated><id>https://andelf.github.io/blog/2014/06/25/tilde-arrow-in-swift</id><content type="html" xml:base="https://andelf.github.io/blog/2014/06/25/tilde-arrow-in-swift/"><![CDATA[<p>本文瞎写，没实际内容。请不用看了。</p>

<h2 id="摘要">摘要</h2>

<p>本文挖掘 Swift 标准库中的诡异操作符 <code class="language-plaintext highlighter-rouge">~&gt;</code> 波浪箭头的作用。</p>

<h2 id="正文">正文</h2>

<p>查看标准库定义的时候，发现了一个奇怪的运算符 <code class="language-plaintext highlighter-rouge">~&gt;</code>，看起来高大上，所以探索下它到底起什么作用。</p>

<p>标准库对 <code class="language-plaintext highlighter-rouge">~&gt;</code> 用到的地方很多，我取最简单的一个来做说明。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protocol SignedNumber : _SignedNumber {
  func -(x: Self) -&gt; Self
  func ~&gt;(_: Self, _: (_Abs, ())) -&gt; Self
}
func ~&gt;&lt;T : _SignedNumber&gt;(x: T, _: (_Abs, ())) -&gt; T
func abs(_: CInt) -&gt; CInt
func abs&lt;T : SignedNumber&gt;(x: T) -&gt; T
</code></pre></div></div>

<p>这是对有符号整型的一个协议，我去掉了额外的属性。事实上 <code class="language-plaintext highlighter-rouge">_Abs</code> 类型是一个空结构， <code class="language-plaintext highlighter-rouge">sizeof</code> 为 0 。</p>

<p>写个测试程序，计算下 <code class="language-plaintext highlighter-rouge">abs(-100)</code> 看看情况，发现 <code class="language-plaintext highlighter-rouge">top_level_code()</code> 调用了 <code class="language-plaintext highlighter-rouge">SignedNumber</code> 版本的 <code class="language-plaintext highlighter-rouge">abs()</code>：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>callq  0x100001410               ; Swift.abs &lt;A : Swift.SignedNumber&gt;(A) -&gt; A
</code></pre></div></div>

<p>反汇编这个库函数，发现一个有意思的调用：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>callq  0x10000302a               ; symbol stub for: Swift._abs &lt;A&gt;(A) -&gt; (Swift._Abs, A)
</code></pre></div></div>

<p>这个 <code class="language-plaintext highlighter-rouge">_abs()</code> 函数是私有函数， Swift 中把很多私有的函数、成员变量、结构、协议都以下划线开头，意思就是不希望我们去调用或者访问的函数，在缺乏成员访问控制的语言中，其实这么做也不错。大家可以借鉴。</p>

<p>而 <code class="language-plaintext highlighter-rouge">_abs()</code> 函数很简单，将任意类型 T 直接封装成 <code class="language-plaintext highlighter-rouge">(_Abs, T)</code> 元组，返回。</p>

<p>然后代码的逻辑就是用这个元祖解开重新组装，调用 <code class="language-plaintext highlighter-rouge">~&gt;</code>。逻辑如下：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// logic of abs() funciton</span>
<span class="nf">let</span> <span class="o">(</span><span class="n">operation</span><span class="o">,</span> <span class="k">val</span><span class="o">)</span> <span class="k">=</span> <span class="nc">_abs</span><span class="o">(-</span><span class="mi">100</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">~&gt;</span> <span class="o">(</span><span class="n">operation</span><span class="o">,</span> <span class="o">())</span> <span class="c1">// 返回 100</span>
</code></pre></div></div>

<p>到这里就清楚了。实际上 <code class="language-plaintext highlighter-rouge">~&gt;</code> 将一个简单的操作复杂化。多调用了层，实际开销主要在元祖的解开和重组装（实际开销理论上在优化模式下应该可以忽略，因为包含 <code class="language-plaintext highlighter-rouge">_Abs</code>， size 为 0）。</p>

<p>到这里很多朋友应该已经知道怎么回事了。 <code class="language-plaintext highlighter-rouge">SignedNumber</code> 中的 <code class="language-plaintext highlighter-rouge">~&gt;</code> 操作是为我们提供了一个方法可以 hook 到标准库的 <code class="language-plaintext highlighter-rouge">abs()</code> 函数。来自 Haskell 的同学应该会见过这种单纯地用类型签名来实现函数分发调用的方式。</p>

<h3 id="优点">优点？</h3>

<p>暂时正在考虑。想明白会发出来。</p>

<h3 id="延伸">延伸</h3>

<p>其实很多标准库函数都用到了类似的方法实现。都用到了 <code class="language-plaintext highlighter-rouge">~&gt;</code> 运算符。包括：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>countElements()
// _countElements() 工具函数  _CountElements 结构
underestimateCount()
// _underestimateCount() 、 _UnderestimateCount
advance()
// _advance() 、 _Advance
</code></pre></div></div>

<p>等。</p>

<h2 id="附录">附录</h2>

<p>这里列出部分定义：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protocol Sequence : _Sequence_ {
  typealias GeneratorType : Generator
  func generate() -&gt; GeneratorType
  func ~&gt;(_: Self, _: (_UnderestimateCount, ())) -&gt; Int
  func ~&gt;&lt;R&gt;(_: Self, _: (_PreprocessingPass, ((Self) -&gt; R))) -&gt; R?
  func ~&gt;(_: Self, _: (_CopyToNativeArrayBuffer, ())) -&gt; ContiguousArrayBuffer&lt;Self.GeneratorType.Element&gt;
}
protocol Collection : _Collection, Sequence {
  subscript (i: Self.IndexType) -&gt; Self.GeneratorType.Element { get }
  func ~&gt;(_: Self, _: (_CountElements, ())) -&gt; Self.IndexType.DistanceType
}

protocol ForwardIndex : _ForwardIndex {
  func ~&gt;(start: Self, _: (_Distance, Self)) -&gt; Self.DistanceType
  func ~&gt;(start: Self, _: (_Advance, Self.DistanceType)) -&gt; Self
  func ~&gt;(start: Self, _: (_Advance, (Self.DistanceType, Self))) -&gt; Self
}
</code></pre></div></div>

<p>相关更多声明代码信息请参考 我的 Github : <a href="https://github.com/andelf/Defines-Swift">andelf/Defines-Swift</a> 。</p>

<h2 id="总结">总结</h2>

<p>通过 <code class="language-plaintext highlighter-rouge">~&gt;</code> 和 <code class="language-plaintext highlighter-rouge">protocol</code> 可以自定义编译器的行为。相当于 hook 标准库函数。由于内部实现未知，还不能继续断言它还有什么作用。</p>

<p>但是和直接用 extension 实现协议的方法相比，这个有什么好处呢？待考。</p>

<h2 id="更新">更新</h2>

<p>可以避免 <code class="language-plaintext highlighter-rouge">protocol</code> 中的静态函数混淆空间，如果用全局函数，那么相当于全局函数去调用静态函数。</p>

<p>还有就是在使用操作符的时候，如果定义多个，那么需要编译器去寻找可用的一个版本。</p>

<p>仔细查看目前的 <code class="language-plaintext highlighter-rouge">protocol</code> 实现，发现还是有点 BUG ，类型限制还是不清楚，表述高阶类型的时候。</p>

<p>为了描述 <code class="language-plaintext highlighter-rouge">~&gt;</code> 的用法，我写了个 <a href="https://gist.github.com/andelf/6a8432ef0820de9991f6">Monad.swift</a> 。</p>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[本文瞎写，没实际内容。请不用看了。]]></summary></entry><entry><title type="html">Write Swift Module Cont. Static Library （使用 Swift 创建 Swift 模块 - 静态链接库）</title><link href="https://andelf.github.io/blog/2014/06/25/write-swift-module-with-swift-cont/" rel="alternate" type="text/html" title="Write Swift Module Cont. Static Library （使用 Swift 创建 Swift 模块 - 静态链接库）" /><published>2014-06-25T13:20:55+00:00</published><updated>2014-06-25T13:20:55+00:00</updated><id>https://andelf.github.io/blog/2014/06/25/write-swift-module-with-swift-cont</id><content type="html" xml:base="https://andelf.github.io/blog/2014/06/25/write-swift-module-with-swift-cont/"><![CDATA[<p>声明： 转载注明我或者 SwiftChina, 请在方便的情况下情尽量告知. <a href="http://weibo.com/234632333">weibo</a></p>

<p>本文的发现基于个人研究。请尊重原创。</p>

<h2 id="摘要">摘要</h2>

<p>本文提出了一种可以编译 Swift 静态链接模块的方法，通过对 swift 编译命令行参数的控制，生成可以自由分发的静态链接库和 swift module 描述文件。同时还提出了导出 objC 头文件供 Objective-C 调用的可能。</p>

<p>关键词： Swift 模块 静态链接库</p>

<p>上次一篇文章 <a href="http://andelf.github.io/blog/2014/06/19/modules-for-swift/">Module System of Swift (简析 Swift 的模块系统)</a> 中提到：</p>

<blockquote>
  <p>静态链接库 .a 目前还没有找到方法， -Xlinker -static 会报错。</p>
</blockquote>

<p>最近摸索了下用 Swift 创建静态链接库的方法。有所收获，这里记录下。</p>

<h2 id="废话">废话</h2>

<p>我们中的很多人都知道，编译器编译的最后一个步骤一般都是链接，一般都是调用 <code class="language-plaintext highlighter-rouge">ld</code>。经过仔细分析，之前为什么不能生成 <code class="language-plaintext highlighter-rouge">.a</code> 静态链接库的原因，发现有如下问题：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-Xlinker -static</code> 参数传递的时候， swift 命令本身不能识别，讲 <code class="language-plaintext highlighter-rouge">-dylib</code> 与 <code class="language-plaintext highlighter-rouge">-static</code> 一起传递（这倒不是问题，参数优先级，静态盖掉了动态）</li>
  <li>链接到 <code class="language-plaintext highlighter-rouge">-lSystem</code> 时候，这个库没有静态链接。</li>
</ul>

<p>所以总会报错。</p>

<h3 id="思考">思考</h3>

<p>实际上之前的方法是走了弯路，根本没有必要去调用 <code class="language-plaintext highlighter-rouge">ld</code>，作为一个合格的 <code class="language-plaintext highlighter-rouge">.a</code> 静态链接库，只要有对应的 <code class="language-plaintext highlighter-rouge">.o</code> 就可以了，没必要去链接 <code class="language-plaintext highlighter-rouge">-lSystem</code>，也许是 swift 本身没有编译为静态链接库的参数支持。</p>

<p>检查 Swift 标准库中的静态链接库，果然只包含对应 <code class="language-plaintext highlighter-rouge">.swift</code> 代码编译后的 <code class="language-plaintext highlighter-rouge">.o</code> 文件。（检查方法是用 <code class="language-plaintext highlighter-rouge">ar -t libName.a</code>）</p>

<p>说到底， Swift 静态链接库的目标很简单，就是包含对应 Swift 模块的所有代码，这样就避免了对应动态链接库的引入。和什么 <code class="language-plaintext highlighter-rouge">-lSystem</code> 没啥相干。</p>

<h2 id="解决方法-howto">解决方法 HOWTO</h2>

<p>以 lingoer 的 <a href="https://github.com/lingoer/SwiftyJSON">SwiftyJSON</a> 为例。</p>

<p>我们的目标很简单，就是生成 <code class="language-plaintext highlighter-rouge">ModName.swiftmodule</code>、<code class="language-plaintext highlighter-rouge">ModName.swiftdoc</code>(可选)、<code class="language-plaintext highlighter-rouge">libswiftModName.a</code> 三个文件。</p>

<h3 id="编译">编译</h3>

<h4 id="生成-swiftmodule-swiftdoc">生成 <code class="language-plaintext highlighter-rouge">.swiftmodule</code> <code class="language-plaintext highlighter-rouge">.swiftdoc</code></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xcrun swift -sdk $(xcrun --show-sdk-path --sdk macosx) SwiftyJSON.swift -emit-library -emit-module -module-name SwiftyJSON -v -o libswiftSwiftyJSON.dylib -module-link-name swiftSwiftyJSON
</code></pre></div></div>

<h4 id="生成-o">生成 <code class="language-plaintext highlighter-rouge">.o</code></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xcrun swift -sdk $(xcrun --show-sdk-path --sdk macosx) -c SwiftyJSON.swift -parse-as-library -module-name SwiftyJSON -v -o SwiftyJSON.o
</code></pre></div></div>

<h4 id="生成-a">生成 <code class="language-plaintext highlighter-rouge">.a</code></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ar rvs libswiftSwiftyJSON.a SwiftyJSON.o
</code></pre></div></div>

<p>大功告成。</p>

<p>同时应该也可以用 <code class="language-plaintext highlighter-rouge">lipo</code> 来合成不同平台下的 <code class="language-plaintext highlighter-rouge">.a</code> 链接库。</p>

<h3 id="使用">使用</h3>

<p>和静态链接库类似，需要 <code class="language-plaintext highlighter-rouge">-I</code> 包含 <code class="language-plaintext highlighter-rouge">.swiftmodule</code> 所在目录， <code class="language-plaintext highlighter-rouge">-L</code> 包含 <code class="language-plaintext highlighter-rouge">.a</code> 所在目录。</p>

<p>如果动态链接库和静态链接库两者同时存在，可以依靠不同目录来区分。</p>

<h2 id="你丫闲的">你丫闲的！</h2>

<p>可能不少人要群嘲，你这意义是啥。你丫闲的。</p>

<p>其实在分发 library 的时候，很多时候我们需要二进制分发，希望别人可以方便地使用。这种情况下，静态链接更佳（虽然新的 iOS 8 支持动态链接，但是看起来是基于 Framework 的，略复杂些。）</p>

<p>甚至我们可以用 <code class="language-plaintext highlighter-rouge">lipo</code> 创建全平台可用的静态链接库。多赞。</p>

<h2 id="补充">补充</h2>

<p>多个 Swift 文件可以分别编译为 <code class="language-plaintext highlighter-rouge">.o</code> 然后用 <code class="language-plaintext highlighter-rouge">ar</code> 合并。</p>

<p>对于 CocoaPods ，也许可以按照这个逻辑将 Swift 模块暴露出去。需要多加一个参数 <code class="language-plaintext highlighter-rouge">-emit-objc-header</code> （以及 <code class="language-plaintext highlighter-rouge">-emit-objc-header-path</code>）即可。</p>

<h2 id="参考文献">参考文献</h2>

<ul>
  <li>我的另一篇 <a href="http://andelf.github.io/blog/2014/06/19/modules-for-swift/">Module System of Swift (简析 Swift 的模块系统)</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/23/use-cocoapods-with-swift/">Use CocoaPods With Swift (在 Swift 中使用 CocoaPods）</a></li>
</ul>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[声明： 转载注明我或者 SwiftChina, 请在方便的情况下情尽量告知. weibo]]></summary></entry><entry><title type="html">Use CocoaPods with Swift (在 Swift 中使用 CocoaPods）</title><link href="https://andelf.github.io/blog/2014/06/23/use-cocoapods-with-swift/" rel="alternate" type="text/html" title="Use CocoaPods with Swift (在 Swift 中使用 CocoaPods）" /><published>2014-06-23T12:15:39+00:00</published><updated>2014-06-23T12:15:39+00:00</updated><id>https://andelf.github.io/blog/2014/06/23/use-cocoapods-with-swift</id><content type="html" xml:base="https://andelf.github.io/blog/2014/06/23/use-cocoapods-with-swift/"><![CDATA[<p>声明： 转载注明我或者 SwiftChina 。请在方便的情况下情尽量告知. <a href="http://weibo.com/234632333">weibo</a></p>

<p>本文的发现基于个人研究。请尊重原创。已授权 CocoaChina 转载个人文章。</p>

<p>本文介绍如何在 Swift 项目中使用 CocoaPods 。如果你已经精通 Bridging Header 的方法，请直接跳到 “扩展 CocoaPods” 一节。</p>

<h2 id="什么是-cocoapods">什么是 CocoaPods</h2>

<blockquote>
  <p>CocoaPods is the dependency manager for Objective-C projects.
It has thousands of libraries and can help you scale your projects elegantly. <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p>
</blockquote>

<p>从介绍看，它是主要给 Objective-C 项目用的，但是我们可以很容易地混合 Objective-C 和 Swift 到同个项目，从而利用大量的 CocoaPods 库和 Swift 漂亮舒服的语法。</p>

<p>作为 iOS 开发新手，一定是要紧跟前人脚步，学习使用 CocoaPods 。</p>

<h2 id="基础用法">基础用法</h2>

<p>这里简单略过，请参考其他无数的文章。</p>

<h3 id="安装">安装</h3>

<p>系统默认安装，可以参考其他教程<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> 。在命令行下执行。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo gem install cocoapods
</code></pre></div></div>

<p>我的环境是 HomeBrew</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 添加 taobao Mirror 不然被墙掉没办法下载
gem sources -a http://ruby.taobao.org/
# 安装
gem install cocoapods
# 更新命令
rbenv rehash
# 执行
pod
# 此时一般会下载官方的所有 PodSpec 库，也可以用 pod setup 初始化环境
</code></pre></div></div>

<p>本文不打算在安装部分耗费太多时间。希望看到这里保证你的命令行下有可用的 <code class="language-plaintext highlighter-rouge">pod</code> 命令。</p>

<h3 id="使用">使用</h3>

<p>假设我们已经有个项目，叫 ProjName ，需要使用一些注明的 CocoaPods 库，比如 AFNetworking<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>.</p>

<p>首先，命令行 cd 到我们的项目目录，一般 ls 命令会看到如下几个文件夹：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ProjName
ProjName.xcodeproj
ProjNameTests
</code></pre></div></div>

<p>赞，就是这里，创建一个 <code class="language-plaintext highlighter-rouge">Podfile</code> 文本文件，写入如下内容</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>platform :ios, "8.0"
pod "AFNetworking", "~&gt; 2.0"
</code></pre></div></div>

<p>一般这么简单的文件都是直接 nano 写。 :)</p>

<p>直接创建 <code class="language-plaintext highlighter-rouge">Podfile</code> ， CocoaPods 会创建一个项目同名的 WorkSpace ，然后添加一个叫 Pods 的项目，这个项目编译结果是一个叫 <code class="language-plaintext highlighter-rouge">libPods.a</code>的链接库，
它会添加到我们之前的 ProjName 项目中作为编译依赖。</p>

<p>当然，通过命令行执行 <code class="language-plaintext highlighter-rouge">pod init</code> 也可以自动创建 <code class="language-plaintext highlighter-rouge">Podfile</code>，而且可以自动分析当前项目的 target ，相对来说更好，也更优雅。具体请参考官方手册。这样的好处是更细致，还可以区分多个子项目子 target 。原理大同小异。</p>

<p>然后接下来，命令行执行 <code class="language-plaintext highlighter-rouge">open ProjName.xcworkspace</code>，注意这个可不是 <code class="language-plaintext highlighter-rouge">.xcodeproj</code>，这个是 CocoaPods 为我们创建的一个 WorkSpace ，包含我们之前的项目，和 Pods 依赖。</p>

<p>开始编码过程。直接在代码里调用，比如写在某个按钮的 <code class="language-plaintext highlighter-rouge">@IBAction</code> 里：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">let</span> <span class="n">manager</span> <span class="k">=</span> <span class="nc">AFHTTPRequestOperationManager</span><span class="o">()</span>
        <span class="n">let</span> <span class="n">url</span> <span class="k">=</span> <span class="s">"http://api.openweathermap.org/data/2.5/weather"</span>
        <span class="nf">println</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>

        <span class="n">let</span> <span class="n">params</span> <span class="k">=</span> <span class="o">[</span><span class="err">"</span><span class="kt">lat</span><span class="err">"</span><span class="kt">:</span> <span class="err">39</span><span class="kt">.</span><span class="err">26</span>, <span class="err">"</span><span class="kt">lon</span><span class="err">"</span><span class="kt">:</span> <span class="err">41</span><span class="kt">.</span><span class="err">03</span>, <span class="err">"</span><span class="kt">cnt</span><span class="err">"</span><span class="kt">:</span><span class="err">0</span><span class="o">]</span>
        <span class="nf">println</span><span class="o">(</span><span class="n">params</span><span class="o">)</span>

        <span class="nv">manager</span><span class="o">.</span><span class="py">GET</span><span class="o">(</span><span class="n">url</span><span class="o">,</span>
            <span class="n">parameters</span><span class="k">:</span> <span class="kt">params</span><span class="o">,</span>
            <span class="n">success</span><span class="k">:</span> <span class="o">{</span> <span class="o">(</span><span class="kt">operation:</span> <span class="kt">AFHTTPRequestOperation!</span><span class="o">,</span>
                        <span class="kt">responseObject:</span> <span class="kt">AnyObject!</span><span class="o">)</span> <span class="kt">in</span>
                <span class="nf">println</span><span class="o">(</span><span class="s">"JSON: "</span> <span class="o">+</span> <span class="nv">responseObject</span><span class="o">.</span><span class="py">description</span><span class="o">!)</span>
            <span class="o">},</span>
            <span class="n">failure</span><span class="k">:</span> <span class="o">{</span> <span class="o">(</span><span class="kt">operation:</span> <span class="kt">AFHTTPRequestOperation!</span><span class="o">,</span>
                        <span class="kt">error:</span> <span class="kt">NSError!</span><span class="o">)</span> <span class="kt">in</span>
                <span class="nf">println</span><span class="o">(</span><span class="s">"Error: "</span> <span class="o">+</span> <span class="nv">error</span><span class="o">.</span><span class="py">localizedDescription</span><span class="o">)</span>
            <span class="o">})</span>
</code></pre></div></div>

<p>这里直接抄了 JakeLin 的 SwiftWeather 代码<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">4</a></sup>，就一小段，希望他不会打我。</p>

<h4 id="swift-坑爹了">Swift 坑爹了</h4>

<p>看起来貌似我们已经可以在 Swift 中使用 <code class="language-plaintext highlighter-rouge">AFNetworking</code> 了。结果刚写几句代码一堆类和变量找不到定义，而且坑爹的是很多时候我们只能靠猜测，判断这些 Objective-C 的定义转换成 Swift 定义是什么样子，用起来就是完全靠蒙！</p>

<p>这不科学！</p>

<p>这都三礼拜了，所以大家都摸索出了调用的方法，那就是按照和 Objective-C 代码混编的例子，添加 Bridging Header ！</p>

<h4 id="继续">继续</h4>

<p>之前简单介绍过和  Objective-C 交互的内容<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">5</a></sup>，大家可以去围观。</p>

<p>一般说来，你在 Swift 项目新建 Objective-C 类的时候，直接弹出是否创建 Bridge Header 的窗口，点 YES 就是了，这时候一般多出来个 <code class="language-plaintext highlighter-rouge">ProjectName-Bridging-Header.h</code> 。然后删掉这个类， Bridging Header 头文件还在。</p>

<p>在这个 Bridging Header 文件里写入要导入的 CocoaPods 库，就可以在 Swift 中使用了。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import &lt;AFNetworking/AFNetworking.h&gt;
</code></pre></div></div>

<p>如果没有自动创建头文件的话，这个配置在项目的 Build Settings 中的 Swift Compiler - Code Generation 子项里。</p>

<p>创建一个头文件，指定为 Bridging Header 也可以。</p>

<p>然后编译，成功执行！</p>

<h4 id="这就完事了">这就完事了？</h4>

<p>实际上，前两天刚写一篇 <a href="http://andelf.github.io/blog/2014/06/19/modules-for-swift/">Swift 的模块系统</a> ， 把任意 Objective-C 库当做 Swift Module 是可行的。当时就觉得这个东西应该是可能完全进入 CocoaPods 的，但是在官方 repo 找了下发现，以前有人提过增加 <code class="language-plaintext highlighter-rouge">module.map</code> 支持，结果 CocoaPods 的人认为这个是 llvm 内部特性， issue 被关闭了。<a href="https://github.com/CocoaPods/CocoaPods/issues/2216">#2216</a> 最近又被提起，我在后面提了下 Swift 支持，希望官方靠谱。</p>

<p>所以下面的内容，就是，我们是否可以在 CocoaPods 上加入 <code class="language-plaintext highlighter-rouge">module.map</code> 支持，然后直接在 Swift 中 <code class="language-plaintext highlighter-rouge">import ModuleName</code> ？</p>

<h2 id="扩展-cocoapods">扩展 CocoaPods</h2>

<p>考虑了多种方式，最后选择了 Hook 的方式。如果 Ruby 技术足够好，或许可以直接写个插件。或者直接改官方代码给官方提交。但是实在能力有限。相关的 <code class="language-plaintext highlighter-rouge">module.map</code> 语法参考 llvm 官方手册 <a href="http://clang.llvm.org/docs/Modules.html">Modules – Clang 3.5 documentation</a>。用了最简单的功能。也许遇到复杂的 PodSpec 就不起作用了，但是原理如此，相信小伙伴们已经知道怎么做了。</p>

<p>目前我的 <code class="language-plaintext highlighter-rouge">Podfile</code> 大概是这个样子：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">platform</span> <span class="ss">:ios</span><span class="p">,</span> <span class="s2">"8.0"</span>
<span class="n">pod</span> <span class="s2">"AFNetworking"</span><span class="p">,</span> <span class="s2">"~&gt; 2.0"</span>
<span class="n">pod</span> <span class="s2">"Baidu-Maps-iOS-SDK"</span><span class="p">,</span> <span class="s2">"~&gt; 2.0"</span>

<span class="n">post_install</span> <span class="k">do</span> <span class="o">|</span><span class="n">installer</span><span class="o">|</span>
  <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">installer</span><span class="p">.</span><span class="nf">sandbox_root</span><span class="si">}</span><span class="s2">/Headers/module.map"</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">fp</span><span class="o">|</span>
    <span class="n">installer</span><span class="p">.</span><span class="nf">pods</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pod</span><span class="o">|</span>
      <span class="n">normalized_pod_name</span> <span class="o">=</span> <span class="n">pod</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
      <span class="n">fp</span><span class="p">.</span><span class="nf">write</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
module </span><span class="si">#{</span><span class="n">normalized_pod_name</span><span class="si">}</span><span class="sh"> [system] {
  umbrella "</span><span class="si">#{</span><span class="n">pod</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="sh">"
  export *
}
</span><span class="no">EOF</span>
      <span class="nb">puts</span> <span class="s2">"Generating Swift Module </span><span class="si">#{</span><span class="n">normalized_pod_name</span><span class="p">.</span><span class="nf">green</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">pod</span><span class="si">}</span><span class="s2"> OK!"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">post_install</code> 是 <code class="language-plaintext highlighter-rouge">Podfile</code> 的一种 hook 机制，可以用来加入自定义操作。我在这里的写的逻辑就是，针对所有的 Pod 生成一个 <code class="language-plaintext highlighter-rouge">module.map</code> 文件。
位于 <code class="language-plaintext highlighter-rouge">Pods/Headers/</code>，这个目录被 CocoaPods 自动设置为项目的 Header Search Path 所以不需要额外处理。默认我们的 Swift 文件就找得到。</p>

<p>其中 <code class="language-plaintext highlighter-rouge">normalized_pod_name</code> 用于处理百度地图 API SDK 这一类名字带减号的库，因为他们不能作为 Module Name ，实际上或许有更好的方法来处理。</p>

<h3 id="实际效果">实际效果</h3>

<p>实测发现完全没有问题，直接 <code class="language-plaintext highlighter-rouge">import AFNetworking</code> 或者 <code class="language-plaintext highlighter-rouge">import BaiduMapsiOSSDK</code> 都可以。</p>

<p>而且很不错的一点是，按住 Command 键，然后鼠标点击模块名、类名等，会跳转到 Swift 定义。</p>

<h3 id="坑">坑</h3>

<p>遇到提示 <code class="language-plaintext highlighter-rouge">.pcm</code> 文件 outdate 的情况下需要你删除 <code class="language-plaintext highlighter-rouge">$HOME/Library/Developer/Xcode/DerivedData/ModuleCache</code> 目录，这个目录保存的是预编译模块，类似于预编译头文件。</p>

<p>目前 Swift 还是有很多 BUG 的，调用 <code class="language-plaintext highlighter-rouge">NSObject</code> 也许会让编译器直接 segment fault ，不带任何出错信息。很伤情。此时请第一时间检查语法是否有诡异，其次将所有用到字符串或者 <code class="language-plaintext highlighter-rouge">Optional</code> 的地方都额外用变量处理，避免用字面常量。（个人经验）</p>

<p>如果多次调用 <code class="language-plaintext highlighter-rouge">pod install</code> 并在其中修改过 <code class="language-plaintext highlighter-rouge">Podfile</code>，那么有可能你的项目依赖会乱掉，多了不存在的 <code class="language-plaintext highlighter-rouge">.a</code> 文件到依赖或者多次包含。手工在项目树和项目选项里删除就可以了。此类编译错误都是链接错误。</p>

<h2 id="总结">总结</h2>

<p>本文提出了一种 Bridging Header 之外的使用 CocoaPods 库的方法。利用有限的 Ruby 知识写了个 Hook 。目前测试 OK 。</p>

<h2 id="参考">参考</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="http://cocoapods.org/">CocoaPods Offical Site</a> CocoaPods 官网 <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="http://www.cocoachina.com/applenews/devnews/2014/0623/8917.html">CocoaPods - CocoaChina</a> CocoaChina 对 CocoaPods 的介绍 <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="https://github.com/AFNetworking/AFNetworking">AFNetworking - Github</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p><a href="https://github.com/JakeLin/SwiftWeather/blob/master/Swift%20Weather/ViewController.swift">SwiftWeather</a> <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p><a href="http://andelf.github.io/blog/2014/06/11/swift-and-objectivec-interop/">Swift and ObjectiveC Interop (Swift 与 Objective-C 之间的交互)</a> <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[声明： 转载注明我或者 SwiftChina 。请在方便的情况下情尽量告知. weibo]]></summary></entry><entry><title type="html">Swift Reflection （Swift 的反射）</title><link href="https://andelf.github.io/blog/2014/06/20/swift-reflection/" rel="alternate" type="text/html" title="Swift Reflection （Swift 的反射）" /><published>2014-06-20T15:48:51+00:00</published><updated>2014-06-20T15:48:51+00:00</updated><id>https://andelf.github.io/blog/2014/06/20/swift-reflection</id><content type="html" xml:base="https://andelf.github.io/blog/2014/06/20/swift-reflection/"><![CDATA[<p>Swift 其实是支持反射的，不过功能略弱。本文介绍基本的反射用法和相关类型。</p>

<h2 id="metatype-和-type-语法">MetaType 和 Type 语法</h2>

<blockquote>
  <p>The metatype of a class, structure, or enumeration type is the name of that type followed by .Type. The metatype of a protocol type—not the concrete type that conforms to the protocol at runtime—is the name of that protocol followed by .Protocol. For example, the metatype of the class type SomeClass is SomeClass.Type and the metatype of the protocol SomeProtocol is SomeProtocol.Protocol.</p>
</blockquote>

<blockquote>
  <p>You can use the postfix self expression to access a type as a value. For example, SomeClass.self returns SomeClass itself, not an instance of SomeClass. And SomeProtocol.self returns SomeProtocol itself, not an instance of a type that conforms to SomeProtocol at runtime.</p>
</blockquote>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>metatype-type -&gt; <code class="language-plaintext highlighter-rouge">type</code>.<strong>Type</strong></td>
          <td><code class="language-plaintext highlighter-rouge">type</code>.<strong>Protocol</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>type-as-value -&gt; <code class="language-plaintext highlighter-rouge">type</code>.self</li>
</ul>

<p>其中 metatype-type 出现在代码中需要类型的地方， type-as-value 出现在代码中需要值、变量的地方。</p>

<p><code class="language-plaintext highlighter-rouge">Any.Type</code> 类型大家可以猜下它表示什么。</p>

<h2 id="基础定义">基础定义</h2>

<p>反射信息用 <code class="language-plaintext highlighter-rouge">Mirror</code> 类型表示，类型协议是 <code class="language-plaintext highlighter-rouge">Reflectable</code>，但实际看起来 <code class="language-plaintext highlighter-rouge">Reflectable</code> 没有任何作用。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protocol Reflectable {
  func getMirror() -&gt; Mirror
}
protocol Mirror {
  var value: Any { get }
  var valueType: Any.Type { get }
  var objectIdentifier: ObjectIdentifier? { get }
  var count: Int { get }
  subscript (i: Int) -&gt; (String, Mirror) { get }
  var summary: String { get }
  var quickLookObject: QuickLookObject? { get }
  var disposition: MirrorDisposition { get }
}
</code></pre></div></div>

<p>实际上所有类型都实现了 <code class="language-plaintext highlighter-rouge">Reflectable</code>。</p>

<p><code class="language-plaintext highlighter-rouge">Mirror</code> 协议相关字段：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">value</code> 相当于变量的 <code class="language-plaintext highlighter-rouge">as Any</code> 操作</li>
  <li><code class="language-plaintext highlighter-rouge">valueType</code> 获得变量类型</li>
  <li><code class="language-plaintext highlighter-rouge">objectIdentifier</code> 相当于一个 UInt 作用未知，可能是 metadata 表用到</li>
  <li><code class="language-plaintext highlighter-rouge">count</code> 子项目个数（可以是类、结构体的成员变量，也可以是字典，数组的数据）</li>
  <li><code class="language-plaintext highlighter-rouge">subscript(Int)</code> 访问子项目, 和子项目的名字</li>
  <li><code class="language-plaintext highlighter-rouge">summary</code> 相当于 <code class="language-plaintext highlighter-rouge">description</code></li>
  <li><code class="language-plaintext highlighter-rouge">quickLookObject</code> 是一个枚举，这个在 WWDC 有讲到，就是 Playground 代码右边栏的显示内容，比如常见类型，颜色，视图都可以</li>
  <li><code class="language-plaintext highlighter-rouge">disposition</code> 表示变量类型的性质，基础类型 or 结构 or 类 or 枚举 or 索引对象 or … 如下</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enum MirrorDisposition {
  case Struct // 结构体
  case Class // 类
  case Enum // 枚举
  case Tuple // 元组
  case Aggregate // 基础类型
  case IndexContainer // 索引对象
  case KeyContainer // 键-值对象
  case MembershipContainer // 未知
  case Container // 未知
  case Optional // Type?
  var hashValue: Int { get }
}
</code></pre></div></div>

<p>通过函数 <code class="language-plaintext highlighter-rouge">func reflect&lt;T&gt;(x: T) -&gt; Mirror</code> 可以获得反射对象 <code class="language-plaintext highlighter-rouge">Mirror</code> 。它定义在 <code class="language-plaintext highlighter-rouge">Any</code> 上，所有类型均可用。</p>

<h2 id="实际操作">实际操作</h2>

<h3 id="valuetype-处理"><code class="language-plaintext highlighter-rouge">.valueType</code> 处理</h3>

<p><code class="language-plaintext highlighter-rouge">Any.Type</code> 是所有类型的元类型，所以 <code class="language-plaintext highlighter-rouge">.valueType</code> 属性表示类型。实际使用的时候还真是有点诡异：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let mir = reflect(someVal)
swith mir.valueType {
case _ as String.Type:
    println("type = string")
case _ as Range&lt;Int&gt;.Type:
    println("type = range of int")
case _ as Dictionary&lt;Int, Int&gt;.Type:
    println("type = dict of int")
case _ as Point.Type:
    println("type = a point struct")
default:
    println("unkown type")
}
</code></pre></div></div>

<p>或者使用 <code class="language-plaintext highlighter-rouge">is</code> 判断：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if mir.valueType is String.Type {
    println("!!!type =&gt; String")
}
</code></pre></div></div>

<p>勘误： 这里之前笔误了。遗漏了 <code class="language-plaintext highlighter-rouge">.valueType</code> 。</p>

<p><code class="language-plaintext highlighter-rouge">is String</code> 判断变量是否是 String 类型，而 <code class="language-plaintext highlighter-rouge">is String.Type</code> 这里用来判断类型是否是 String 类型。</p>

<h3 id="subscriptint-处理"><code class="language-plaintext highlighter-rouge">subscript(Int)</code> 处理</h3>

<p>实测发现直接用 <code class="language-plaintext highlighter-rouge">mir[0]</code> 访问偶尔会出错，也许是 beta 的原因。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for r in 0..mir.count {
    let (name, subref) = mir[r]
    prtln("name: \(name)")
    // visit sub Mirror here
}
</code></pre></div></div>

<p>通过上面的方法，基本上可以遍历大部分结构。</p>

<h2 id="不同类型的处理">不同类型的处理</h2>

<h3 id="struct-结构体-class-类">Struct 结构体、 Class 类</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.count</code> 为字段个数。</li>
  <li><code class="language-plaintext highlighter-rouge">subscript(Int)</code> 返回 （字段名，字段值反射 <code class="language-plaintext highlighter-rouge">Mirror</code>） 元组</li>
  <li><code class="language-plaintext highlighter-rouge">summary</code> 为 mangled name</li>
</ul>

<h3 id="tuple-元组">Tuple 元组</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.count</code> 为元组子元素个数</li>
  <li><code class="language-plaintext highlighter-rouge">subscript(Int)</code> 的 name 为 “.0”, “.1” …</li>
</ul>

<h3 id="aggregate-基础类型">Aggregate 基础类型</h3>

<p>包括数字、字符串（含 <code class="language-plaintext highlighter-rouge">NSString</code>）、函数、部分 Foundation 类型、 MetaType 。</p>

<p>很奇怪一点是测试发现枚举也被反射为基础类型。怀疑是没实现完。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.count</code> 为 0</li>
</ul>

<h3 id="indexcontainer-索引对象">IndexContainer 索引对象</h3>

<p>包括 <code class="language-plaintext highlighter-rouge">Array&lt;T&gt;</code>, <code class="language-plaintext highlighter-rouge">T[]</code>, <code class="language-plaintext highlighter-rouge">NSArray</code> 等。可以通过 subscript 访问。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.count</code> 为元组子元素个数</li>
  <li><code class="language-plaintext highlighter-rouge">subscript(Int)</code> 的 name 为 “[0]”, “[1]” …</li>
</ul>

<h3 id="keycontainer-键-值对象">KeyContainer 键-值对象</h3>

<p>包括 <code class="language-plaintext highlighter-rouge">Dictionary&lt;T, U&gt;</code>、<code class="language-plaintext highlighter-rouge">NSDictionary</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.count</code> 为元组子元素个数</li>
  <li><code class="language-plaintext highlighter-rouge">subscript(Int)</code> 的 name 为 “[0]”, “[1]” … 实际访问是 <code class="language-plaintext highlighter-rouge">(name, (reflect(key), reflect(val)))</code></li>
</ul>

<h3 id="optional-type">Optional Type?</h3>

<p>只包括 <code class="language-plaintext highlighter-rouge">Type?</code>，不包括 <code class="language-plaintext highlighter-rouge">Type!</code>。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.count</code> 为 0 或者 1 (对应 nil 和有值的情况)</li>
  <li><code class="language-plaintext highlighter-rouge">subscript(Int)</code> , name 为 “Some”</li>
</ul>

<h3 id="其他">其他</h3>

<ul>
  <li>Enum 枚举 看起来是未使用</li>
  <li>MembershipContainer // 未知</li>
  <li>Container // 未知</li>
</ul>

<h2 id="示例代码">示例代码</h2>

<p><a href="https://gist.github.com/anonymous/190fc7ecee30e83a5dca">Gist</a></p>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[Swift 其实是支持反射的，不过功能略弱。本文介绍基本的反射用法和相关类型。]]></summary></entry><entry><title type="html">Module System of Swift (简析 Swift 的模块系统)</title><link href="https://andelf.github.io/blog/2014/06/19/modules-for-swift/" rel="alternate" type="text/html" title="Module System of Swift (简析 Swift 的模块系统)" /><published>2014-06-19T07:14:31+00:00</published><updated>2014-06-19T07:14:31+00:00</updated><id>https://andelf.github.io/blog/2014/06/19/modules-for-swift</id><content type="html" xml:base="https://andelf.github.io/blog/2014/06/19/modules-for-swift/"><![CDATA[<p>声明： 转载注明我或者 SwiftChina, 请在方便的情况下情尽量告知. <a href="http://weibo.com/234632333">weibo</a></p>

<p>本文的发现基于个人研究。请尊重原创。</p>

<h2 id="引子">引子</h2>

<blockquote>
  <p>你之所以认为 Swift 最像 Scala, 那是因为你还没学过 Rust. —- 猫·仁波切</p>
</blockquote>

<p>Swift 中模块是什么？当写下 Swift 中一句 <code class="language-plaintext highlighter-rouge">import Cocoa</code> 的时候到底整了个什么玩意？官方 ibook 很含糊只是提了半页不到。</p>

<p>本文解决如下问题</p>

<ul>
  <li>介绍 Swift 中两种可 import 的模块</li>
  <li>如何用 Swift 写一个可被其他 Swift 代码使用的模块</li>
  <li>分析 Swift 的标准库实现方式</li>
</ul>

<h2 id="第一部分-clang-模块系统模块">第一部分 Clang 模块（系统模块）</h2>

<p>Clang 模块是来自系统底层的模块，一般是 C/ObjC 的头文件。原始 API 通过它们暴露给 Swift ，编译时需要链接到对应的 Library。</p>

<p>例如 <code class="language-plaintext highlighter-rouge">UIKit</code>、<code class="language-plaintext highlighter-rouge">Foundation</code> 模块，从这些模块 dump 出的定义来看，几乎是完全自动生成的。当然， <code class="language-plaintext highlighter-rouge">Foundation</code> 模块更像是自动生成 + 人工扩展（我是说其中的隐式类型转换定义、对 Swift 对象的扩展等，以及 <code class="language-plaintext highlighter-rouge">@availability</code> 禁用掉部分函数。）。相关函数声明可以从 <a href="https://github.com/andelf/Defines-Swift">我的 Github andelf/Defines-Swift</a> 获得。</p>

<p>我可不觉得这些定义全部都是官方生成后给封装进去的。所以在整个 Xcode-6 beta2 目录树里进行了探索。</p>

<p>在 Xcode 目录寻找相关信息，最后目标锁定到了一个特殊的文件名 <code class="language-plaintext highlighter-rouge">module.map</code>。</p>

<p>原来这个文件叫 Module map(这个名字还真是缺乏想象力)，属于 llvm 的 Module 系统。本来是用来颠覆传统的 C/C++/Objc 中的 <code class="language-plaintext highlighter-rouge">#include</code> 和 <code class="language-plaintext highlighter-rouge">#import</code>。最早在 2012 年 11 月的 LLVM DevMeeting 中由 Apple 的 Doug Gregor 提出 <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>。相关内容 CSDN 也有文章介绍，不过是直译版，没有提出自己见解 <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>。</p>

<h3 id="关于-llvm-module-系统">关于 llvm Module 系统</h3>

<p>2012 年提出概念，所以其实这个东西已经很早就实现了 。简单说就是用树形的结构化描述来取代以往的平坦式 <code class="language-plaintext highlighter-rouge">#include</code>， 例如传统的 <code class="language-plaintext highlighter-rouge">#include &lt;stdio.h&gt;</code> 现在变成了 <code class="language-plaintext highlighter-rouge">import std.io;</code>， 逼格更高。主要好处有：</p>

<ul>
  <li>语义上完整描述了一个框架的作用</li>
  <li>提高编译时可扩展性，只编译或 include 一次。避免头文件多次引用，只解析一次头文件甚至不需要解析（类似预编译头文件）</li>
  <li>减少碎片化，每个 module 只处理一次，环境的变化不会导致不一致</li>
  <li>对工具友好，工具（语言编译器）可以获取更多关于 module 的信息，比如链接库，比如语言是 C++ 还是 C</li>
  <li>等等</li>
</ul>

<p>所以这么好的一个东西， Apple 作为 llvm 的主力，在它的下一代语言中采用几乎是一定的。</p>

<p>算了，我是个半路出家的，之前没接触过 iOS / MacOSX 开发，其实 2013 年的 WWDC， Apple 为 Objective-C 加入的 <code class="language-plaintext highlighter-rouge">@import</code> 语法就是它。可以认为，这是第一次这个 Module 系统得到应用。</p>

<h4 id="modulemap-文件">module.map 文件</h4>

<p><code class="language-plaintext highlighter-rouge">module.map</code> 文件就是对一个框架，一个库的所有头文件的结构化描述。通过这个描述，桥接了新语言特性和老的头文件。默认文件名是 <code class="language-plaintext highlighter-rouge">module.modulemap</code>，<code class="language-plaintext highlighter-rouge">module.map</code> 其实是为了兼容老标准，不过现在 Xcode 里的还都是这个文件名，相信以后会改成新名字。</p>

<p>文件的内容以 <code class="language-plaintext highlighter-rouge">Module Map Language</code> 描述，大概语法我从 llvm 官方文档 <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> 摘录一段，大家体会一下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module MyLib {
  explicit module A {
    header "A.h"
    export *
  }

  explicit module B {
    header "B.h"
    export *
  }
}
</code></pre></div></div>

<p>类似上面的语法，描述了 <code class="language-plaintext highlighter-rouge">MyLib</code>、<code class="language-plaintext highlighter-rouge">MyLib.A</code>、<code class="language-plaintext highlighter-rouge">MyLib.B</code> 这样的模块结构。</p>

<p>官方文档 <sup id="fnref:3:1" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> 中有更多相关内容，可以描述框架，描述系统头文件，控制导出的范围，描述依赖关系，链接参数等等。这里不多叙述，举个 libcurl 的例子：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module curl [system] [extern_c] {
    header "/usr/include/curl/curl.h"
    link "curl"
    export *
}
</code></pre></div></div>

<p>将此 <code class="language-plaintext highlighter-rouge">module.map</code> 文件放入任意文件夹，通过 Xcode 选项或者命令行参数，添加路径到 import search path （swift 的 -I 参数）。
然后就可以在 Swift 代码里直接通过 <code class="language-plaintext highlighter-rouge">import curl</code> 导入所有的接口函数、结构体、常量等，(实测，发现 <code class="language-plaintext highlighter-rouge">curl_easy_setopt</code>
无法自动导入，看起来是声明语法太复杂导致）。甚至可以直接从 swift repl 调用，体验脚本语言解释器般的快感（因为我们已经指定了链接到 curl 库）。</p>

<p>Xcode 选项位于 Build Settings 下面的 Swift Compiler - Search Paths 。添加路劲即可。</p>

<p>再举个复杂点的 <code class="language-plaintext highlighter-rouge">SDL2.framework</code> 的例子，看看如何实现树形的模块结构，这个需要把 <code class="language-plaintext highlighter-rouge">module.map</code> 放到 <code class="language-plaintext highlighter-rouge">.framework</code> 目录里</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>framework module SDL2 [system] {
  umbrella header "SDL.h"
  link -framework SDL2

  module Version {
    header "SDL_version.h"
    export *
  }

  module Event {
    header "SDL_events.h"
    export *
  }
  // ....
  export *
  module * {
    export *
  }
}
</code></pre></div></div>

<h3 id="小结">小结</h3>

<p>Swift 的 C 模块（也是它的标准库部分）完全就是 llvm 的 Module 系统，在 import search path 的所有 module.map 中的模块都可以被识别，唯一缺点可能是如果有过于复杂用到太多高级 C 或者黑暗 C 语法的函数，无法很好识别，相信以后的版本会有所改善。</p>

<p>所以当有人问 Swift 到底有多少标准库的时候，答案就是，基本上系统里所有的 Objective-C 和 C 头文件都可以调用。自 iOS 7 时代，这些头文件就已经被组织为 Module 了，包括标准 C 库 <code class="language-plaintext highlighter-rouge">Darwin.C</code>。同样因为 Module 系统来自于传统的 C/C++/Objc 头文件，所以 Swift 虽然可以有 <code class="language-plaintext highlighter-rouge">import ModA.ModB.ModC</code> 的语句，但是整个模块函数名字空间还是平坦的。</p>

<p>一些有意思的模块可以探索探索，比如 <code class="language-plaintext highlighter-rouge">simd</code>，比如 <code class="language-plaintext highlighter-rouge">Python</code>（没错是的，直接调用 Python 解释器）等。</p>

<p>另外 Swift 的 <code class="language-plaintext highlighter-rouge">-module-cache-path</code> 参数可以控制这类模块预编译头的存放位置（ .pcm 文件： pre compiled module）。</p>

<p>Xcode 项目的 Build Settings ， Apple LLVM 6.0 - Language - Modules 有项目对 Module 支持的相关选项，默认是打开的。</p>

<h2 id="第二部分-swift-模块">第二部分 Swift 模块</h2>

<p>说完了系统模块，该说 Swift 模块了。 Swift 自身的这个系统还是很赞的。</p>

<p>本节介绍怎样用 Swift 创建一个可 import 的模块。</p>

<h3 id="几个文件类型">几个文件类型</h3>

<p>先清楚几个文件类型。假设 <code class="language-plaintext highlighter-rouge">ModName.swift</code> 是我们的 Swift 源码文件。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ModName.swiftmodule</code> Swift 的模块文件，有了它，才能 import</li>
  <li><code class="language-plaintext highlighter-rouge">ModName.swiftdoc</code> 保存了从源码获得的文档注释
    <ul>
      <li>文档注释以 <code class="language-plaintext highlighter-rouge">///</code> 开头</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">libswiftModName.dylib</code> 动态链接库</li>
  <li><code class="language-plaintext highlighter-rouge">libswiftModName.a</code>  静态链接库</li>
</ul>

<p>TODO: 目前有个疑问就是 <code class="language-plaintext highlighter-rouge">.swiftmodule</code> 和链接库到底什么时候用哪个，以及具体作用。</p>

<h4 id="swift-源码文件">.swift 源码文件</h4>

<p>先明确一个概念，一个 .swift 文件执行是从它的第一条非声明语句（表达式、控制结构）开始的，同时包括声明中的赋值部分（对应为 mov 指令或者 lea 指令），所有这些语句，构成了该 .swift 文件的 <code class="language-plaintext highlighter-rouge">top_level_code()</code> 函数。</p>

<p>而所有的声明，包括结构体、类、枚举及其方法，都不属于 <code class="language-plaintext highlighter-rouge">top_level_code()</code> 代码部分，其中的代码逻辑，包含在其他区域，<code class="language-plaintext highlighter-rouge">top_level_code()</code> 可以直接调用他们。</p>

<p>程序的入口是隐含的一个 <code class="language-plaintext highlighter-rouge">main(argc, argv)</code> 函数，该函数执行逻辑是设置全局变量 <code class="language-plaintext highlighter-rouge">C_ARGC</code> <code class="language-plaintext highlighter-rouge">C_ARGV</code>，然后调用 <code class="language-plaintext highlighter-rouge">top_level_code()</code>。</p>

<p>不是所有的 .swift 文件都可以作为模块，目前看，任何包含表达式语句和控制控制的 .swift 文件都不可以作为模块。正常情况下模块可以包含全局变量(<code class="language-plaintext highlighter-rouge">var</code>)、全局常量(<code class="language-plaintext highlighter-rouge">let</code>)、结构体(<code class="language-plaintext highlighter-rouge">struct</code>)、类(<code class="language-plaintext highlighter-rouge">class</code>)、枚举(<code class="language-plaintext highlighter-rouge">enum</code>)、协议(<code class="language-plaintext highlighter-rouge">protocol</code>)、扩展(<code class="language-plaintext highlighter-rouge">extension</code>)、函数(func)、以及全局属性(<code class="language-plaintext highlighter-rouge">var { get set }</code>)。这里的全局，指的是定义在 top level 。</p>

<p>这里说的表达式指 expression ，语句指 statement ，声明指 declaration 。可能和有些人对相关概念的定义不同。实际上我特无奈有些人纠结于概念问题，而不是问题本身，本来翻译过来的舶来品就有可能有误差，当你明白那指的是什么的时候，就可以了。</p>

<h3 id="模块编译方法">模块编译方法</h3>

<p>这里先以命令行操作为例，</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xcrun swift -sdk $(xcrun --show-sdk-path --sdk macosx) ModName.swift -emit-library -emit-module -module-name ModName -v -o libswiftModName.dylib -module-link-name swiftModName
</code></pre></div></div>

<p>执行后获得 <code class="language-plaintext highlighter-rouge">ModName.swiftdoc</code>、<code class="language-plaintext highlighter-rouge">ModName.swiftmodule</code>、<code class="language-plaintext highlighter-rouge">libswiftModName.dylib</code>.</p>

<p>这三个文件就可以表示一个可 import 的 Swift 模块。目前看起来 dylib 是必须得有的，否则链接过程报错。实际感觉 <code class="language-plaintext highlighter-rouge">.swiftmodule</code> 文件所包含的信息还需要继续挖掘挖掘。</p>

<p>多个源码文件直接依次传递所有文件名即可。</p>

<p>静态链接库 <code class="language-plaintext highlighter-rouge">.a</code> 目前还没有找到方法， <code class="language-plaintext highlighter-rouge">-Xlinker -static</code> 会报错。</p>

<h4 id="命令行参数解释">命令行参数解释</h4>

<p>相关命令行参数：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-module-name &lt;value&gt;</code>       Name of the module to build 模块名</li>
  <li><code class="language-plaintext highlighter-rouge">-emit-library</code>              编译为链接库文件</li>
  <li><code class="language-plaintext highlighter-rouge">-emit-module-path &lt;path&gt;</code>   Emit an importable module to <path> 编译模块到路径（全路径，包含文件名）</path></li>
  <li><code class="language-plaintext highlighter-rouge">-emit-module</code>               Emit an importable module</li>
  <li><code class="language-plaintext highlighter-rouge">-module-link-name &lt;value&gt;</code>  Library to link against when using this module 该模块的链接库名，就是 <code class="language-plaintext highlighter-rouge">libswiftModName.dylib</code>，这个信息会直接写入到 <code class="language-plaintext highlighter-rouge">.swiftmodule</code></li>
</ul>

<h3 id="使用模块">使用模块</h3>

<p>使用模块就很简单了，记住两个参数：</p>

<p><code class="language-plaintext highlighter-rouge">-I</code> 表示 import search path ，前面介绍过，保证 <code class="language-plaintext highlighter-rouge">.swiftmodule</code> 文件可以在 import search path 找到（这点很类似 module.map 文件，找得到这个就可以 import 可以编译）</p>

<p><code class="language-plaintext highlighter-rouge">-L</code> 表示 链接库搜索路径，保证 <code class="language-plaintext highlighter-rouge">.dylib</code> 文件可以在其中找到，如果已经在系统链接库目录中，就不需要这个参数。</p>

<p>例如：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xcrun swift -sdk $(xcrun --show-sdk-path --sdk macosx) mymodtest.swift -I. -L.
</code></pre></div></div>

<p>此时表示所有 module 文件都在当前目录。</p>

<p>这两个选项都可以在 Xcode 中指定，所以如果你有小伙伴编译好的 module 想在你的项目里用是完全 ok 的。</p>

<h3 id="for-xcode">For Xcode</h3>

<p>很不幸，没能在 Xcode 中找到编译模块的相关方法。等我发现如何搞定的时候我会补上这个坑。</p>

<p>不过在任何含 Swift 项目的编译过程中， <code class="language-plaintext highlighter-rouge">.swiftmodule</code> 文件总是伴随着 <code class="language-plaintext highlighter-rouge">.o</code> 文件传递。</p>

<h2 id="第三部分-瞎分析-swiftmodule-文件">第三部分 瞎分析 .swiftmodule 文件</h2>

<p>简单分析下一个 .swiftmodule 所包含的信息。</p>

<h3 id="foundation">Foundation</h3>

<p>这里先以标准库的 <code class="language-plaintext highlighter-rouge">Foundation.swiftmodule</code> 下手。</p>

<p>用 hexdump 查看发现它包含所有导出符号，以及 mangled name 。还有个文件列表，表示它是从哪些文件获得的（可以是 .swift 也可以是 .swiftmodule ）。</p>

<p>用 strings 列出内容，发现 Foundation 库有如下特征:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
Foundation
LLVM 3.5svn
/SourceCache/compiler_KLONDIKE/compiler_KLONDIKE-600.0.34.4.8/src/tools/swift/stdlib/objc/Foundation/Foundation.swift
/SourceCache/compiler_KLONDIKE/compiler_KLONDIKE-600.0.34.4.8/src/tools/swift/stdlib/objc/Foundation/KVO.swift
/SourceCache/compiler_KLONDIKE/compiler_KLONDIKE-600.0.34.4.8/src/tools/swift/stdlib/objc/Foundation/NSStringAPI.swift
CoreFoundation
Foundation
Swift
swiftFoundation
...
</code></pre></div></div>

<p>可以大胆猜测对应下：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-module-name</code> =&gt; <code class="language-plaintext highlighter-rouge">Foundation</code></li>
  <li>编译环境 =&gt; LLVM 3.5svn</li>
  <li>源文件列表 =&gt; …</li>
  <li>依赖列表 =&gt; <code class="language-plaintext highlighter-rouge">CoreFoundation</code>, <code class="language-plaintext highlighter-rouge">Foundation</code>, <code class="language-plaintext highlighter-rouge">Swift</code></li>
  <li><code class="language-plaintext highlighter-rouge">-module-link-name</code> =&gt; <code class="language-plaintext highlighter-rouge">swiftFoundation</code></li>
</ul>

<p>我由此猜测， <code class="language-plaintext highlighter-rouge">Foundation</code> 的确是只有少量 Swift 代码做桥接。然后通过 Clang 模块将剩下工作交到底层。</p>

<p>分析其他类似模块也得到相同结果。</p>

<h3 id="swift-标准库">Swift 标准库</h3>

<p>接下来有点好奇标准库 Swift 是怎么实现的。得到如下结果。</p>

<p>节选重要部分到 <a href="https://gist.github.com/andelf/8f28ead66cdc3637f978">我的 Gist</a></p>

<p>里面有些很有意思的信息，有兴趣的同学可以去看看。</p>

<p>依赖模块 SwiftShims 是一个 <code class="language-plaintext highlighter-rouge">module.map</code> 定义的模块，桥接的部分头文件。源文件有相关信息和注释。大致意思是用来实现几个底层接口对象，比如 <code class="language-plaintext highlighter-rouge">NSRange</code> 邓。</p>

<p>其中<code class="language-plaintext highlighter-rouge">-module-link-name</code> 是 <code class="language-plaintext highlighter-rouge">swift_stdlib_core</code>。</p>

<h2 id="结论">结论</h2>

<p>LLVM Module 作为 Apple 提出的特性，已经被 Swift 完全采用，直接在它基础上建立了自己的模块系统。我相信它会影响到我们处理第三方库的方式方法。相信不久就会有相关工具基于它来管理依赖关系，比如老的 cocoapods<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> 可以加入新特性。</p>

<p>用 Swift 写模块目前并没有很好的 IDE 支持，所以不是很方便。基于猜测验证，上面的方法可以实现在 Swift 里 import Swift 模块，方法和结果看起来完全和官方模块相同。</p>

<p>Swift 的标准库完全是上面两种模块的结合体，用 Swift 模块封装 Clang 模块。这就解决了文章一开始提出的问题：为什么标准库大部分看起来是自动生成代码，少部分又好像是人工写的接口代码。</p>

<h2 id="参考文献">参考文献</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Modules - Doug Gregor, Apple, 2012 LLVM DevMeeting <a href="http://llvm.org/devmtg/2012-11/Gregor-Modules.pdf">PDF</a> <a href="http://llvm.org/devmtg/2012-11/videos/Gregor-Modules.mp4">Video</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="http://www.csdn.net/article/2012-11-28/2812274-module-replace-C-based-languages-headers">为什么应该用模块取代C/C++中的头文件？</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="http://clang.llvm.org/docs/Modules.html">Modules - Clang 3.5 documentation</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:3:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p><a href="http://cocoapods.org/">CocoaPods</a> <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[声明： 转载注明我或者 SwiftChina, 请在方便的情况下情尽量告知. weibo]]></summary></entry><entry><title type="html">Swift and C Interop Cont. (简析 Swift 和 C 的交互，Part 二)</title><link href="https://andelf.github.io/blog/2014/06/18/swift-and-c-interop-cont/" rel="alternate" type="text/html" title="Swift and C Interop Cont. (简析 Swift 和 C 的交互，Part 二)" /><published>2014-06-18T15:38:01+00:00</published><updated>2014-06-18T15:38:01+00:00</updated><id>https://andelf.github.io/blog/2014/06/18/swift-and-c-interop-cont</id><content type="html" xml:base="https://andelf.github.io/blog/2014/06/18/swift-and-c-interop-cont/"><![CDATA[<p>声明： 转载注明我或者 SwiftChina . <a href="http://weibo.com/234632333">weibo</a></p>

<p>本文的发现基于个人研究，目测是官方外的首创。请尊重原创。</p>

<p>本文是讲述 Swift 与 C 交互操作系列文章的第二部分。解决之前的所有遗留问题。</p>

<p>第一部分请参考 <a href="http://andelf.github.io/blog/2014/06/15/swift-and-c-interop/">Swift and C Interop 简析Swift和C的交互</a></p>

<p>本文将介绍实际应用过程中会遇到的各类情况。</p>

<h2 id="再看类型对应">再看类型对应</h2>

<p>标准类型这里就不提了，上面的文章讲的很明白了。</p>

<h3 id="7-种指针类型">7 种指针类型</h3>

<p>从代码看，我认为 Swift 对应 C 的指针时候，存在一个最原始的类型 <code class="language-plaintext highlighter-rouge">RawPointer</code>，但是它是内部表示，不可以直接使用。所以略过。但它是基础，可以认为它相当于 <code class="language-plaintext highlighter-rouge">Word</code> 类型（机器字长）。</p>

<p><strong>以下内容再 Xcode6-beta3 中不适用</strong> 请参考 <a href="http://andelf.github.io/blog/2014/07/08/swift-beta3-changes/">Swift 在 Xcode6-beta3 中的变化</a>。</p>

<h4 id="copaquepointer">COpaquePointer</h4>

<p>不透明指针。之前我以为它很少会用到，不过现在看来想错了，虽然类型不安全，但是很多场合只能用它。它是直接对应 <code class="language-plaintext highlighter-rouge">RawPointer</code> 的。字长相等。</p>

<blockquote>
  <p>In computer programming, an opaque pointer is a special case of an opaque data type, a datatype declared to be a pointer to a record or data structure of some unspecified type. - 来自 Wikipedia</p>
</blockquote>

<p>几乎没有任何操作方法，不带类型，主要用于 Bridging Header 中表示 C 中的复杂结构指针</p>

<p>比如一个例子， libcurl 中的 <code class="language-plaintext highlighter-rouge">CURL *</code> 的处理，其实就是对应为 <code class="language-plaintext highlighter-rouge">COpaquePointer</code>。</p>

<h4 id="unsafepointer">UnsafePointer<T></T></h4>

<p>泛型指针。直接对应 <code class="language-plaintext highlighter-rouge">RawPointer</code>。字长相等。</p>

<p>处理指针的主力类型。常量中的 <code class="language-plaintext highlighter-rouge">C_ARGV</code> 的类型也是它 <code class="language-plaintext highlighter-rouge">UnsafePointer&lt;CString&gt;</code>。</p>

<p>支持大量操作方法：</p>

<ul>
  <li>通过 <code class="language-plaintext highlighter-rouge">.memory</code> 属性 <code class="language-plaintext highlighter-rouge">{ get set }</code> 操作指针指向的内容</li>
  <li>支持 subscript ，直接对应于 C 的数组，例如 <code class="language-plaintext highlighter-rouge">C_ARGV[1]</code></li>
  <li>通过 <code class="language-plaintext highlighter-rouge">alloc(num: Int)</code> 分配数组空间</li>
  <li><code class="language-plaintext highlighter-rouge">initialize(val: T)</code> 直接初始化</li>
  <li>offset 操作 <code class="language-plaintext highlighter-rouge">.succ()</code> <code class="language-plaintext highlighter-rouge">.pred()</code></li>
  <li>可以从任意一种指针直接调用构造函数获得</li>
  <li>隐式类型转换为非 <code class="language-plaintext highlighter-rouge">COpaquePointer</code> 之外的任意一种指针</li>
</ul>

<h4 id="autoreleasingunsafepointer">AutoreleasingUnsafePointer<T></T></h4>

<p>之前特地写文介绍过这个指针类型。<code class="language-plaintext highlighter-rouge">NSError</code> 的处理就主要用它。传送门： <a href="http://andelf.github.io/blog/2014/06/16/swift-nserror-internals/">Swift NSError Internals（解析 Swift 对 NSError 操作）</a></p>

<p>内部实现用了语言内置特性，从名字也可以看出来，这个应该是非常棒的一个指针，可以帮助管理内存，逼格也高。内存直接对应 <code class="language-plaintext highlighter-rouge">RawPointer</code> 可以传递给 C 函数。</p>

<ul>
  <li>通过 <code class="language-plaintext highlighter-rouge">.memory</code> 属性 <code class="language-plaintext highlighter-rouge">{ get set }</code> 操作指针指向的内容</li>
  <li>直接从 <code class="language-plaintext highlighter-rouge">&amp;T</code> 类型获得，使用方法比较诡异，建议参考文章</li>
</ul>

<h4 id="cmutablepointer-cconstpointer">CMutablePointer<T> CConstPointer<T></T></T></h4>

<p>分别对应于 C 中的 <code class="language-plaintext highlighter-rouge">T *</code>、<code class="language-plaintext highlighter-rouge">const T *</code>。不可直接传递给 C 函数，因为表示结构里还有一个 <code class="language-plaintext highlighter-rouge">owner</code> 域，应该是用来自动管理生命周期的。<code class="language-plaintext highlighter-rouge">sizeof</code> 操作返回 16。但是可以有隐式类型转换。</p>

<p>操作方法主要是 <code class="language-plaintext highlighter-rouge">func withUnsafePointer&lt;U&gt;(f: UnsafePointer&lt;T&gt; -&gt; U) -&gt; U</code>，用 Trailing Closure 语法非常方便。</p>

<h4 id="cmutablevoidpointer-cconstvoidpointer">CMutableVoidPointer CConstVoidPointer</h4>

<p>分别对应于 C 中的 <code class="language-plaintext highlighter-rouge">void *</code>、<code class="language-plaintext highlighter-rouge">const void *</code>。其他内容同上一种。</p>

<h4 id="小结指针">小结指针</h4>

<p>以上 7 种指针类型可以分未两类，我给他们起名为 第一类指针 和 第二类指针 。（你看我在黑马克思耶，算了这个梗太深，参考马克思主义政治经济学）</p>

<ul>
  <li>可以直接用于 C 函数声明的 第一类指针
    <ul>
      <li><code class="language-plaintext highlighter-rouge">COpaquePointer</code> <code class="language-plaintext highlighter-rouge">UnsafePointer&lt;T&gt;</code> <code class="language-plaintext highlighter-rouge">AutoreleasingUnsafePointer&lt;T&gt;</code></li>
      <li>是对 <code class="language-plaintext highlighter-rouge">RawPointer</code> 的封装，直接对应于 C 的指针，它们的 <code class="language-plaintext highlighter-rouge">sizeof</code> 都是单位字长</li>
    </ul>
  </li>
  <li>不可用于声明 第二类指针
    <ul>
      <li><code class="language-plaintext highlighter-rouge">CMutablePointer&lt;T&gt; CConstPointer&lt;T&gt; CMutableVoidPointer CConstVoidPointer</code></li>
      <li>直接从 Swift 对象的引用获得（一个隐藏特性，引用隐式转换）（主要构造方法）</li>
      <li>包含了一个 <code class="language-plaintext highlighter-rouge">owner</code> 字段，可以管理生命周期，理论上在 Swift 中使用</li>
      <li>通过 <code class="language-plaintext highlighter-rouge">.withUnsafePointer</code> 方法调用</li>
    </ul>
  </li>
</ul>

<p>所有指针都实现了 <code class="language-plaintext highlighter-rouge">LogicValue</code> 协议，可以直接 <code class="language-plaintext highlighter-rouge">if a_pointer</code> 判断是否为 <code class="language-plaintext highlighter-rouge">NULL</code>。</p>

<p><code class="language-plaintext highlighter-rouge">nil</code> 类型实现了到所有指针类型的隐式类型转换，等价于 C 中的 ``NULL`，可以直接判断。</p>

<p>什么时候用什么？这个问题我也在考虑中，以下是我的建议。</p>

<ul>
  <li>对应复杂结构体，不操作结构体字段的： <code class="language-plaintext highlighter-rouge">COpaquePointer</code> 例如 <code class="language-plaintext highlighter-rouge">CURL *</code></li>
  <li>日常操作： <code class="language-plaintext highlighter-rouge">UnsafePointer&lt;T&gt;</code></li>
  <li>同时需要在 Swift 和 C 中操作结构体字段，由 Swift 管理内存：<code class="language-plaintext highlighter-rouge">AutoreleasingUnsafePointer&lt;T&gt;</code></li>
  <li>Swift 中创建对象，传递给 C： 第二类指针</li>
</ul>

<h2 id="工具类型">工具类型</h2>

<h3 id="cvararg-cvalistpointer-valistbuilder">CVarArg CVaListPointer VaListBuilder</h3>

<p>用于处理 C 语言中的可变参数 valist 函数。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">protocol</span> <span class="nc">CVarArg</span> <span class="o">{</span>
  <span class="n">func</span> <span class="nf">encode</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">Word</span><span class="o">[]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>表示该类型可以作为可变参数，相当多的类型都实现了这个。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">struct</span> <span class="nc">CVaListPointer</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">value</span><span class="k">:</span> <span class="kt">UnsafePointer&lt;Void&gt;</span>
    <span class="kt">init</span><span class="o">(</span><span class="kt">fromUnsafePointer</span> <span class="kt">from:</span> <span class="kt">UnsafePointer&lt;Void&gt;</span><span class="o">)</span>
    <span class="kt">@conversion</span> <span class="kt">func</span> <span class="k">__</span><span class="kt">conversion</span><span class="o">()</span> <span class="kt">-&gt;</span> <span class="kt">CMutableVoidPointer</span>
<span class="o">}</span>
</code></pre></div></div>

<p>对应于 C，直接给 C 函数传递，声明、定义时使用。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">VaListBuilder</span> <span class="o">{</span>
    <span class="nf">init</span><span class="o">()</span>
    <span class="n">func</span> <span class="nf">append</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span> <span class="kt">CVarArg</span><span class="o">)</span>
    <span class="n">func</span> <span class="nf">va_list</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">CVaListPointer</span>
<span class="o">}</span>
</code></pre></div></div>

<p>工具类，方便地创建 <code class="language-plaintext highlighter-rouge">CVaListPointer</code>。</p>

<p>还有一些工具函数：</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">func</span> <span class="nf">getVaList</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">CVarArg</span><span class="o">[])</span> <span class="o">-&gt;</span> <span class="nc">CVaListPointer</span>
<span class="n">func</span> <span class="n">withVaList</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;(</span><span class="n">args</span><span class="k">:</span> <span class="kt">CVarArg</span><span class="o">[],</span> <span class="n">f</span><span class="k">:</span> <span class="o">(</span><span class="kt">CVaListPointer</span><span class="o">)</span> <span class="kt">-&gt;</span> <span class="kt">R</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">R</span>
<span class="n">func</span> <span class="n">withVaList</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;(</span><span class="n">builder</span><span class="k">:</span> <span class="kt">VaListBuilder</span><span class="o">,</span> <span class="n">f</span><span class="k">:</span> <span class="o">(</span><span class="kt">CVaListPointer</span><span class="o">)</span> <span class="kt">-&gt;</span> <span class="kt">R</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">R</span>
</code></pre></div></div>

<p>非常方便。</p>

<h3 id="unsafearray">UnsafeArray<T></T></h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">struct</span> <span class="nc">UnsafeArray</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">:</span> <span class="kt">Collection</span><span class="o">,</span> <span class="nc">Generator</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">startIndex</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">var</span> <span class="kt">endIndex:</span> <span class="kt">Int</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">subscript</span> <span class="o">(</span><span class="kt">i:</span> <span class="kt">Int</span><span class="o">)</span> <span class="kt">-&gt;</span> <span class="kt">T</span> <span class="o">{</span> <span class="kt">get</span> <span class="o">}</span>
  <span class="kt">init</span><span class="o">(</span><span class="kt">start:</span> <span class="kt">UnsafePointer&lt;T&gt;</span><span class="o">,</span> <span class="kt">length:</span> <span class="kt">Int</span><span class="o">)</span>
  <span class="n">func</span> <span class="nf">next</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="o">?</span>
  <span class="n">func</span> <span class="nf">generate</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">UnsafeArray</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>处理 C 数组的工具类型，可以直接 for-in 处理。当然，只读的，略可惜。</p>

<h3 id="unmanaged">Unmanaged<T></T></h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">struct</span> <span class="nc">Unmanaged</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="k">var</span> <span class="nc">_value</span><span class="k">:</span> <span class="kt">T</span>
  <span class="nf">init</span><span class="o">(</span><span class="nc">_private</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span>
  <span class="n">func</span> <span class="nf">fromOpaque</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">COpaquePointer</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Unmanaged</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
  <span class="n">func</span> <span class="nf">toOpaque</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">COpaquePointer</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">passRetained</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Unmanaged</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
  <span class="n">static</span> <span class="n">func</span> <span class="nf">passUnretained</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Unmanaged</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
  <span class="n">func</span> <span class="nf">takeUnretainedValue</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="n">T</span>
  <span class="n">func</span> <span class="nf">takeRetainedValue</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="n">T</span>
  <span class="n">func</span> <span class="nf">retain</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">Unmanaged</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
  <span class="n">func</span> <span class="nf">release</span><span class="o">()</span>
  <span class="n">func</span> <span class="nf">autorelease</span><span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">Unmanaged</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>顾名思义，手动管理 RC 的。避免 Swift 插入的 ARC 代码影响程序逻辑。</p>

<h2 id="c-头文件的导入行为">C 头文件的导入行为</h2>

<h3 id="宏定义">宏定义</h3>

<p>数字常量 CInt, CDouble (带类型后缀则为对应类型，如 1.0f ）
字符常量 CString
其他宏 展开后，无定义</p>

<h3 id="枚举-enum">枚举 enum</h3>

<p>创建 enum 类型，并继承自 <code class="language-plaintext highlighter-rouge">CUnsignedInt</code> 或 <code class="language-plaintext highlighter-rouge">CInt</code> （enum 是否有负初始值）</p>

<p>可以通过 <code class="language-plaintext highlighter-rouge">.value</code> 访问。</p>

<h3 id="结构体-struct">结构体 struct</h3>

<p>创建 struct 类型，只有默认 init ，需要加上所有结构体字段名创建。</p>

<h3 id="可变参数函数">可变参数函数</h3>

<p>转为 <code class="language-plaintext highlighter-rouge">CVaListPointer</code>。手动重声明更好。这里举 <code class="language-plaintext highlighter-rouge">Darwin</code> 模块的例子说。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func vprintf(_: CString, _: CVaListPointer) -&gt; CInt
</code></pre></div></div>

<h2 id="从-c-调用-swift">从 C 调用 Swift</h2>

<p>只能调用函数。</p>

<p>之前说过，用 <code class="language-plaintext highlighter-rouge">@asmname("name")</code> 指定 mangled name 即可。</p>

<p>然后 C 语言中人工声明下函数。很可惜自动导出头文件不适用于 C 语言，只适用于 Objective-C 。</p>

<p>目测暂时无法导出结构体，因为 Swift 闭源不提供相关头文件。靠猜有风险。</p>

<p>全局变量不支持用 <code class="language-plaintext highlighter-rouge">@asmname("name")</code> 控制导出符号名。目测可以尝试用 mangled name 访问，但是很不方便。</p>

<h2 id="示例">示例</h2>

<p>我尝试调用了下 libcurl 。</p>

<p>项目地址在 <a href="https://github.com/andelf/curl-swift">andelf/curl-swift</a> 包含编译脚本（就一句命令）。</p>

<p>Bridging Header 只写入 <code class="language-plaintext highlighter-rouge">#include&lt;curl/curl.h&gt;</code> 即可。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@asmname</span><span class="o">(</span><span class="s">"curl_easy_setopt"</span><span class="o">)</span> <span class="n">func</span> <span class="nf">curl_easy_setopt</span><span class="o">(</span><span class="n">curl</span><span class="k">:</span> <span class="kt">COpaquePointer</span><span class="o">,</span> <span class="n">option</span><span class="k">:</span> <span class="kt">CURLoption</span><span class="o">,</span> <span class="n">param</span><span class="k">:</span> <span class="kt">CString</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">CURLcode</span>
<span class="nd">@asmname</span><span class="o">(</span><span class="s">"curl_easy_setopt"</span><span class="o">)</span> <span class="n">func</span> <span class="nf">curl_easy_setopt</span><span class="o">(</span><span class="n">curl</span><span class="k">:</span> <span class="kt">COpaquePointer</span><span class="o">,</span> <span class="n">option</span><span class="k">:</span> <span class="kt">CURLoption</span><span class="o">,</span> <span class="n">param</span><span class="k">:</span> <span class="kt">CBool</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">CURLcode</span>

<span class="n">let</span> <span class="n">handle</span> <span class="k">=</span> <span class="nf">curl_easy_init</span><span class="o">()</span>

<span class="c1">// this should be a const c string. curl_easy_perform() will use this.</span>
<span class="n">let</span> <span class="n">url</span><span class="k">:</span> <span class="kt">CString</span> <span class="o">=</span> <span class="s">"http://www.baidu.com"</span>

<span class="nf">curl_easy_setopt</span><span class="o">(</span><span class="n">handle</span><span class="o">,</span> <span class="nc">CURLOPT_URL</span><span class="o">,</span> <span class="n">url</span><span class="o">)</span>
<span class="nf">curl_easy_setopt</span><span class="o">(</span><span class="n">handle</span><span class="o">,</span> <span class="nc">CURLOPT_VERBOSE</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>

<span class="n">let</span> <span class="n">ret</span> <span class="k">=</span> <span class="nf">curl_easy_perform</span><span class="o">(</span><span class="n">handle</span><span class="o">)</span>
<span class="n">let</span> <span class="n">error</span> <span class="k">=</span> <span class="nf">curl_easy_strerror</span><span class="o">(</span><span class="n">ret</span><span class="o">)</span>
<span class="nf">println</span><span class="o">(</span><span class="s">"error = \(error)"</span><span class="o">)</span>
</code></pre></div></div>

<p>值得注意的是其中对单个函数的多态声明， <code class="language-plaintext highlighter-rouge">curl_easy_setopt</code> 实际上第三个参数是 <code class="language-plaintext highlighter-rouge">void *</code>。</p>

<p>以及对 <code class="language-plaintext highlighter-rouge">url</code> 的处理，实际上 libcurl 要求设置的 url 参数一直保持到 <code class="language-plaintext highlighter-rouge">curl_easy_perform</code> 时，所以这里用 <code class="language-plaintext highlighter-rouge">withUnsafePointer</code> 或者
<code class="language-plaintext highlighter-rouge">withCString</code> 是不太可取的方法。实际上或许可以用 <code class="language-plaintext highlighter-rouge">Unmanaged&lt;T&gt;</code> 来解决。</p>

<h2 id="总结">总结</h2>

<p>我觉得说这么多。。。</p>

<p>调用 C 已经再没有别的内容可说了。其他的就是编程经验的问题，比如如何实现 C 回调 Swift 或者 Swift 回调 C 。可以参考其他语言的做法。解决方法不只一种。</p>

<h2 id="参考文献">参考文献</h2>

<ul>
  <li><a href="https://github.com/andelf/Defines-Swift">我的 Github andelf/Defines-Swift</a>。</li>
  <li><a href="http://andelf.github.io/blog/2014/06/15/swift-and-c-interop/">Swift and C Interop 简析Swift和C的交互 第一部分</a></li>
  <li><a href="http://andelf.github.io/blog/2014/06/16/swift-nserror-internals/">Swift NSError Internals（解析 Swift 对 NSError 操作）</a></li>
</ul>]]></content><author><name></name></author><category term="blog" /><category term="swift" /><summary type="html"><![CDATA[声明： 转载注明我或者 SwiftChina . weibo]]></summary></entry></feed>