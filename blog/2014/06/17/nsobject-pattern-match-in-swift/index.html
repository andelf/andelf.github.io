
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>NSObject Pattern Match in Swift (简析 Swift 中的 Pattern Match) - 猫·仁波切</title>
  <meta name="author" content="猫·仁波切 (Feather)">

  
  <meta name="description" content="本文正式标题是：简析 Swift 中的 Pattern Match 副标题是：妈蛋 Swift 你又用黑属性坑大家了: 为什么 switch case 可以用数字匹配字符 声明： 原创发现，原创内容。转载注明我或者 SwiftChina . weibo 问题的提出 故事是这样的， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://andelf.github.io/blog/2014/06/17/nsobject-pattern-match-in-swift">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="猫·仁波切" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">猫·仁波切</a></h1>
  
    <h2>会研发的PM才是好OP.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:andelf.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">NSObject Pattern Match in Swift (简析 Swift 中的 Pattern Match)</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-17T09:29:48+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>本文正式标题是：简析 Swift 中的 Pattern Match</p>

<p>副标题是：妈蛋 Swift 你又用黑属性坑大家了: 为什么 switch case 可以用数字匹配字符</p>

<p>声明： 原创发现，原创内容。转载注明我或者 SwiftChina . <a href="http://weibo.com/234632333">weibo</a></p>

<h2>问题的提出</h2>

<p>故事是这样的，昨天有人在论坛上发了个帖子，虽然不太规范而且含糊，不过还是能看出来他在问什么。<a href="http://swift.sh/topic/151/switch-case10/">传送门</a></p>

<p>重新把问题简化搬运过来。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">let</span> <span class="n">count</span> <span class="k">=</span> <span class="s">&quot;0&quot;</span>
</span><span class='line'><span class="n">switch</span> <span class="n">count</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">1</span><span class="k">:</span>
</span><span class='line'>    <span class="kt">println</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">location</span> <span class="err">1&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="kt">case</span> <span class="err">0</span><span class="kt">:</span>
</span><span class='line'>    <span class="n">println</span><span class="o">(</span><span class="s">&quot;location 2&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="s">&quot;1&quot;</span><span class="k">:</span>
</span><span class='line'>    <span class="kt">println</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">location</span> <span class="err">3&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="kt">default:</span>
</span><span class='line'>    <span class="n">println</span><span class="o">(</span><span class="s">&quot;location 4&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>为什么上面的代码可以通过编译？</p>

<h2>问题验证</h2>

<p>这几天说了很多了， Swift 是强类型语言，所以类型不同肯定不能在一起。直觉上，这段代码肯定不可能编译通过，错误一定是类型错误。</p>

<p>果断扔代码到文件，然后编译（我个人习惯用命令行直接编译）:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// 填入 test.swift</span>
</span><span class='line'><span class="n">xcrun</span> <span class="n">swift</span> <span class="o">-</span><span class="n">g</span> <span class="n">test</span><span class="o">.</span><span class="n">swift</span>
</span></code></pre></td></tr></table></div></figure>


<p>果然出错，不过出错信息略诡异：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">test</span><span class="o">.</span><span class="n">swift</span><span class="k">:</span><span class="err">4</span><span class="kt">:</span><span class="err">6</span><span class="kt">:</span> <span class="kt">error:</span> <span class="kt">could</span> <span class="kt">not</span> <span class="kt">find</span> <span class="kt">an</span> <span class="kt">overload</span> <span class="kt">for</span> <span class="err">&#39;</span><span class="kt">~=</span><span class="err">&#39;</span> <span class="kt">that</span> <span class="kt">accepts</span> <span class="kt">the</span> <span class="kt">supplied</span> <span class="kt">arguments</span>
</span><span class='line'><span class="k">case</span> <span class="mi">1</span><span class="k">:</span>
</span><span class='line'>     <span class="kt">^</span>
</span></code></pre></td></tr></table></div></figure>


<p>故事到这里也许完事了。嗯，不可以编译，问题也许是 Xcode 6 beta 版的 BUG 什么的。微博上的 <a href="http://weibo.com/owenzx">@肇鑫</a> 也提到， 用 Playground 编译也是出错，出错信息同上。</p>

<p>看起来暂时是无法重现问题。</p>

<h3>出错信息</h3>

<p>先解释下这个出错信息，熟读那本 ibook 的同学，可能会记得，在 swift case 那节是有讲到 <code>~=</code> 这个运算符的，也讲到了如何自定义它。</p>

<blockquote><p>Expression Pattern</p>

<p>An expression pattern represents the value of an expression. Expression patterns appear only in switch statement case labels.</p>

<p>The expression represented by the expression pattern is compared with the value of an input expression using the Swift standard library ~= operator. The matches succeeds if the ~= operator returns true. By default, the ~= operator compares two values of the same type using the == operator. It can also match an integer value with a range of integers in an Range object.</p></blockquote>

<p>所以其实 <code>~=</code> 是一个匹配运算符(Pattern Match Operator)，专门用在 Pattern Match 的地方，比如 switch 的 case 。一般情况下它直接调用 <code>==</code> 运算符。</p>

<p>原书还写道：</p>

<blockquote><p>You can overload the ~= operator to provide custom expression matching behavior. For example, you can rewrite the above example to compare the point expression with a string representations of points.</p></blockquote>

<p>说明 Pattern Match 的行为是可以通过重载 <code>~=</code> 控制的。书中有重载的例子，小伙伴们可以看看。</p>

<p>深入下，来看看 <code>~=</code> 到底是什么东西：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nd">@transparent</span> <span class="n">func</span> <span class="o">~=&lt;</span><span class="n">T</span> <span class="k">:</span> <span class="kt">Equatable&gt;</span><span class="o">(</span><span class="kt">a:</span> <span class="kt">T</span><span class="o">,</span> <span class="kt">b:</span> <span class="kt">T</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
</span><span class='line'><span class="n">func</span> <span class="o">~=&lt;</span><span class="n">T</span> <span class="k">:</span> <span class="kt">RandomAccessIndex</span> <span class="kt">where</span> <span class="kt">T.DistanceType</span> <span class="kt">:</span> <span class="kt">SignedInteger&gt;</span><span class="o">(</span><span class="kt">x:</span> <span class="kt">Range&lt;T&gt;</span><span class="o">,</span> <span class="kt">y:</span> <span class="kt">T</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，首先它可以匹配两个相同类型的 Equatable，而且是 <code>@transparent</code>，说明没有额外开销， inline 函数，从书中看，完全等价于调用 <code>==</code>，不深究了。</p>

<p>然后，它可以匹配一个 <code>Rnage&lt;T&gt;</code> 和 <code>T</code>，这也就是我们在 switch case 里写的 <code>case 1..18: println("未成年")</code> 背后的奥秘，略有开销。</p>

<p>以上说明了为什么出错信息提示为什么是 <code>~=</code> 运算符重载失败，而不是类型错误（其实也算是一种类型错误，没有找到适合运算符的类型）。</p>

<h3>再次尝试重现</h3>

<p>有了上面的线索，是不是怀疑我们遗漏了什么？回到原问题提出的地方：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">override</span> <span class="n">func</span> <span class="n">viewDidLoad</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="k">super</span><span class="o">.</span><span class="n">viewDidLoad</span><span class="o">()</span>
</span><span class='line'><span class="n">let</span> <span class="n">count</span> <span class="k">=</span> <span class="s">&quot;0&quot;</span>
</span><span class='line'><span class="o">....</span>
</span></code></pre></td></tr></table></div></figure>


<p>看起来，他是在 App 环境下调用的，这也许就是问题的根源。之前有介绍过， Cocoa 框架给 Swift 语言添加了很多东西，包括一大批的 <code>extension</code>，还有一堆隐式类型转换。</p>

<p>我们在 <code>test.swift</code> 第一行加入 <code>import Cocoa</code>，重新编译。结果正常通过编译。代码执行结果符合预期，走 default 分支。</p>

<h3>这也不科学!</h3>

<p>小伙伴们惊呆了，看起来 <code>count</code> 变量明明是一个 <code>Character</code>，结果竟然能匹配 <code>Character</code> 和 <code>Int</code>。</p>

<h2>祭出 lldb</h2>

<p>lldb 挂上 exe ，看看汇编代码是怎么样的。带上注释。我摘录最能说明问题的一段。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'>   <span class="err">;</span> <span class="err">这里是</span> <span class="nf">case</span> <span class="mi">1</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d1a:</span>  <span class="nf">movabsq</span> <span class="no">$0x01</span><span class="p">,</span> <span class="nv">%rdi</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d24:</span>  <span class="nf">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x148</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>   <span class="err">;</span> <span class="err">将</span> <span class="err">1</span> <span class="err">转换为</span> <span class="nf">NSNumber</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d2b:</span>  <span class="nf">callq</span>  <span class="mi">0x100003f32</span>               <span class="err">;</span> <span class="no">symbol</span> <span class="no">stub</span> <span class="no">for</span><span class="p">:</span> <span class="no">Swift.Int.__conversion</span> <span class="p">(</span><span class="no">Swift.Int</span><span class="p">)()</span> <span class="p">-</span><span class="err">&gt;</span> <span class="no">ObjectiveC.NSNumber</span>
</span><span class='line'>
</span><span class='line'>   <span class="err">;</span> <span class="err">此处省略调用</span> <span class="nf">ARC</span> <span class="err">代码若干</span>
</span><span class='line'>   <span class="na">....</span>
</span><span class='line'>
</span><span class='line'>   <span class="err">;</span> <span class="err">这里其实是</span> <span class="nl">count:</span> <span class="nf">String</span> <span class="p">,</span> <span class="err">三个寄存器表示</span>
</span><span class='line'>   <span class="err">;</span> <span class="err">检查</span> <span class="nf">String</span> <span class="err">大小你会发现</span> <span class="no">sizeof</span><span class="p">(</span><span class="no">String</span><span class="p">)</span> <span class="err">是</span> <span class="mi">24</span><span class="err">，三个</span> <span class="mi">64</span><span class="no">bit</span>
</span><span class='line'>   <span class="err">;</span> <span class="err">熟悉</span> <span class="nf">Rust</span> <span class="err">的同学知道，字符串实现，无非三个</span> <span class="no">field</span> <span class="err">：</span> <span class="no">size</span> <span class="err">、</span> <span class="no">capacity</span> <span class="err">、</span><span class="no">pointer</span>
</span><span class='line'>   <span class="err">;</span> <span class="err">猜测</span> <span class="nf">Swift</span> <span class="err">完全相同因为它大量借鉴了</span> <span class="no">Rust</span> <span class="err">（不服来喷）</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d43:</span>  <span class="nf">movq</span>   <span class="p">-</span><span class="mi">0x128</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d4a:</span>  <span class="nf">movq</span>   <span class="p">-</span><span class="mi">0x130</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rsi</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d51:</span>  <span class="nf">movq</span>   <span class="p">-</span><span class="mi">0x138</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdx</span>
</span><span class='line'>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d58:</span>  <span class="nf">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x158</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
</span><span class='line'>   <span class="err">;</span> <span class="err">这里将</span> <span class="nl">count:</span> <span class="nf">String</span> <span class="err">转换为</span> <span class="no">NSString</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d5f:</span>  <span class="nf">callq</span>  <span class="mi">0x100003f26</span>               <span class="err">;</span> <span class="no">symbol</span> <span class="no">stub</span> <span class="no">for</span><span class="p">:</span> <span class="no">Swift.String.__conversion</span> <span class="p">(</span><span class="no">Swift.String</span><span class="p">)()</span> <span class="p">-</span><span class="err">&gt;</span> <span class="no">ObjectiveC.NSString</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d64:</span>  <span class="nf">movq</span>   <span class="p">-</span><span class="mi">0x150</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d6b:</span>  <span class="nf">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rsi</span>
</span><span class='line'>   <span class="err">;</span> <span class="err">**最最神奇的地方来了，这里调用了</span> <span class="err">~=</span> <span class="nf">ObjectiveC</span> <span class="err">版，比较两个</span> <span class="no">NSObject</span> <span class="err">的版本。</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100001d6e:</span>  <span class="nf">callq</span>  <span class="mi">0x100003f20</span>               <span class="err">;</span> <span class="no">symbol</span> <span class="no">stub</span> <span class="no">for</span><span class="p">:</span> <span class="no">ObjectiveC.</span><span class="err">~=</span> <span class="err">@</span><span class="no">infix</span> <span class="p">(</span><span class="no">ObjectiveC.NSObject</span><span class="p">,</span> <span class="no">ObjectiveC.NSObject</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;</span> <span class="no">Swift.Bool</span>
</span></code></pre></td></tr></table></div></figure>


<h2>分析</h2>

<p>上面一堆看不懂没关系，这里再复述下在 Cocoa 环境（或者说 Foundation 环境下）第一条 <code>case 1:</code> 的流程:</p>

<ul>
<li>将 1 转换为 <code>NSNumber</code>，通过隐式类型转换实现</li>
<li>将 <code>count</code> 转换为 <code>NSString</code>，通过隐式类型转换实现</li>
<li>调用 <code>NSObject</code> 重载版的 <code>~=</code> 运算符进行比较</li>
</ul>


<p>这么看起来明了多了。但是，我们的 <code>Character</code> 哪里去了？为什么 count 的类型变了？</p>

<p>直接下断点然后 repl 命令检查，果然，我们没有指定类型的 <code>count</code> 在这个版本中变成了一个 <code>String</code>。</p>

<p>从标准库定义看， <code>Character</code> 和 <code>String</code> 都实现了 <code>ExtendedGraphemeClusterLiteralConvertible</code> 协议，保证他们能从字符字面常量获得。所以实际上每当我们写 <code>let foo = "a"</code> 其实是完全依赖编译器的类型推导，选择到底是 <code>Character</code> 还是 <code>String</code>。</p>

<p>说明 Swift 编译器高大上，可以从当前加载的所有类型中推导出合法合理能编译的类型组合。来自 Haskell 背景的同学一定笑而不语，当然那种怎么改都凑不对类型的痛苦也是其他同学无法理解和感同身受的。</p>

<p>回头再看看 <code>ObjectiveC.~=</code> 这个运算符重载：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">func</span> <span class="o">~=(</span><span class="n">x</span><span class="k">:</span> <span class="kt">NSObject</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">NSObject</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Bool</span>
</span></code></pre></td></tr></table></div></figure>


<p>定义在 ObjectiveC 模块里，使用 <code>import ObjectiveC</code> 可以加载。这个模块是 Swift 到 Objective-C 的一些映射模块，基础的 <code>NSObject</code> 方法还有一些运行时控制函数。</p>

<p>当然 <code>Foundation</code>, <code>Cocoa</code> 这些都会加载它，所以理论上写应用的时候不需要指定，只要你用到了 <code>NSObject</code> 就一定有它。</p>

<p>实际上 WWDC 某一集里讲到（忘记了，等我再找到会补上），对比 <code>NSObject</code> 的时候，Swift 会选择调用 <code>isEqual</code> 方法。我们反汇编验证下。简单加点注释。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'><span class="err">(</span><span class="nf">lldb</span><span class="p">)</span> <span class="no">dis</span> <span class="p">-</span><span class="no">a</span> <span class="mi">0x100003f20</span>
</span><span class='line'><span class="nf">asmtest</span><span class="err">`</span><span class="no">symbol</span> <span class="no">stub</span> <span class="no">for</span><span class="p">:</span> <span class="no">ObjectiveC.</span><span class="err">~=</span> <span class="err">@</span><span class="no">infix</span> <span class="p">(</span><span class="no">ObjectiveC.NSObject</span><span class="p">,</span> <span class="no">ObjectiveC.NSObject</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;</span> <span class="no">Swift.Bool</span><span class="p">:</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x100003f20:</span>  <span class="nf">jmpq</span>   <span class="p">*</span><span class="mi">0x1252</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>             <span class="err">;</span> <span class="p">(</span><span class="no">void</span> <span class="p">*)</span><span class="mi">0x00000001000e88d0</span><span class="p">:</span> <span class="no">ObjectiveC.</span><span class="err">~=</span> <span class="err">@</span><span class="no">infix</span> <span class="p">(</span><span class="no">ObjectiveC.NSObject</span><span class="p">,</span> <span class="no">ObjectiveC.NSObject</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;</span> <span class="no">Swift.Bool</span>
</span><span class='line'><span class="err">(</span><span class="nf">lldb</span><span class="p">)</span> <span class="no">dis</span> <span class="p">-</span><span class="no">a</span> <span class="mi">0x00000001000e88d0</span>
</span><span class='line'><span class="nf">libswiftObjectiveC.dylib</span><span class="err">`</span><span class="no">ObjectiveC.</span><span class="err">~=</span> <span class="err">@</span><span class="no">infix</span> <span class="p">(</span><span class="no">ObjectiveC.NSObject</span><span class="p">,</span> <span class="no">ObjectiveC.NSObject</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;</span> <span class="no">Swift.Bool</span><span class="p">:</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88d0:</span>  <span class="nf">pushq</span>  <span class="nv">%rbp</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88d1:</span>  <span class="nf">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88d4:</span>  <span class="nf">pushq</span>  <span class="nv">%r15</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88d6:</span>  <span class="nf">pushq</span>  <span class="nv">%r14</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88d8:</span>  <span class="nf">pushq</span>  <span class="nv">%rbx</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88d9:</span>  <span class="nf">pushq</span>  <span class="nv">%rax</span>
</span><span class='line'>   <span class="err">;</span> <span class="err">64位</span> <span class="err">寄存器传参</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88da:</span>  <span class="nf">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="nv">%rbx</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88dd:</span>  <span class="nf">movq</span>   <span class="nv">%rdi</span><span class="p">,</span> <span class="nv">%r14</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88e0:</span>  <span class="nf">movq</span>   <span class="mi">0x3da1</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rsi</span>        <span class="err">;</span> <span class="err">&quot;</span><span class="no">isEqual</span><span class="p">:</span><span class="err">&quot;</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88e7:</span>  <span class="nf">movq</span>   <span class="nv">%rbx</span><span class="p">,</span> <span class="nv">%rdx</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88ea:</span>  <span class="nf">callq</span>  <span class="mi">0x1000eb670</span>               <span class="err">;</span> <span class="no">symbol</span> <span class="no">stub</span> <span class="no">for</span><span class="p">:</span> <span class="no">objc_msgSend</span>
</span><span class='line'>   <span class="err">;</span> <span class="err">测试</span> <span class="nl">isEqual:</span> <span class="err">调用的返回值，存到</span> <span class="err">%</span><span class="nf">r16b</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88ef:</span>  <span class="nf">testb</span>  <span class="nv">%al</span><span class="p">,</span> <span class="nv">%al</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88f1:</span>  <span class="nf">setne</span>  <span class="nv">%r15b</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88f5:</span>  <span class="nf">movq</span>   <span class="nv">%rbx</span><span class="p">,</span> <span class="nv">%rdi</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88f8:</span>  <span class="nf">callq</span>  <span class="mi">0x1000eb676</span>               <span class="err">;</span> <span class="no">symbol</span> <span class="no">stub</span> <span class="no">for</span><span class="p">:</span> <span class="no">objc_release</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e88fd:</span>  <span class="nf">movq</span>   <span class="nv">%r14</span><span class="p">,</span> <span class="nv">%rdi</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e8900:</span>  <span class="nf">callq</span>  <span class="mi">0x1000eb676</span>               <span class="err">;</span> <span class="no">symbol</span> <span class="no">stub</span> <span class="no">for</span><span class="p">:</span> <span class="no">objc_release</span>
</span><span class='line'>   <span class="err">;</span> <span class="err">本运算符函数返回值</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e8905:</span>  <span class="nf">movb</span>   <span class="nv">%r15b</span><span class="p">,</span> <span class="nv">%al</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e8908:</span>  <span class="nf">addq</span>   <span class="no">$0x8</span><span class="p">,</span> <span class="nv">%rsp</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e890c:</span>  <span class="nf">popq</span>   <span class="nv">%rbx</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e890d:</span>  <span class="nf">popq</span>   <span class="nv">%r14</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e890f:</span>  <span class="nf">popq</span>   <span class="nv">%r15</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e8911:</span>  <span class="nf">popq</span>   <span class="nv">%rbp</span>
</span><span class='line'>   <span class="err">0</span><span class="nl">x1000e8912:</span>  <span class="nf">retq</span>
</span></code></pre></td></tr></table></div></figure>


<p>啧啧， Instruction Pointer Relative Addressing 用的飞起。 64 位名字也特好听。 RIP 。 对了， MacOSX 下都是 PIC 位置无关代码。</p>

<p>从上面看，果然是调用了 Objective-C 的 <code>isEqual:</code>。</p>

<h2>总结</h2>

<ul>
<li>Swift 的编译器会根据大范围的代码推导类型，遍历 AST 然后用树或者图算法填充未指定的类型

<ul>
<li><code>"c"</code> 可以是任意 <code>ExtendedGraphemeClusterLiteralConvertible</code> 类型，包括 <code>Character</code>、<code>String</code>、<code>CString</code>、<code>UnicodeScalar</code>、<code>StaticString</code> 等</li>
</ul>
</li>
<li>swith case 语句使用 <code>~=</code> 运算符执行匹配操作

<ul>
<li>非 Foundation 环境下，相当于 <code>==</code> 运算符</li>
<li>在 Foundation 环境下，如果是 <code>NSObject</code> 及其子类，相当于 <code>isEqual:</code> 方法</li>
<li><code>a..b</code> 这样的匹配也是通过 <code>~=</code> 运算符实现，也可以重载后自定义</li>
</ul>
</li>
<li>在 Foundation 环境下，隐式类型转换遍地都是</li>
</ul>


<h2>教训</h2>

<ul>
<li>真用到字符类型 <code>Character</code> 的时候，还是显式指定吧</li>
<li>需要额外注意能隐式类型转换到 <code>NSObject</code> 的几个类型，避免非预期行为</li>
</ul>


<h2>参考文献</h2>

<ul>
<li>Apple Inc. “The Swift Programming Language”。 iBooks. <a href="https://itun.es/cn/jEUH0.l">https://itun.es/cn/jEUH0.l</a></li>
<li><a href="https://github.com/andelf/Defines-Swift">我的 Github andelf/Defines-Swift</a></li>
<li><a href="http://andelf.github.io/blog/2014/06/08/swift-implicit-type-cast/">隐式类型转换</a></li>
<li>WWDC 某集讲到的 <code>isEqual:</code></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">猫·仁波切 (Feather)</span></span>

      








  


<time datetime="2014-06-17T09:29:48+08:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/swift/'>swift</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://andelf.github.io/blog/2014/06/17/nsobject-pattern-match-in-swift/" data-via="andelf" data-counturl="http://andelf.github.io/blog/2014/06/17/nsobject-pattern-match-in-swift/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/06/16/swift-nserror-internals/" title="Previous Post: Swift NSError Internals（解析 Swift 对 NSError 操作）">&laquo; Swift NSError Internals（解析 Swift 对 NSError 操作）</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/06/18/swift-and-c-interop-cont/" title="Next Post: Swift and C Interop Cont. (简析 Swift 和 C 的交互，Part 二)">Swift and C Interop Cont. (简析 Swift 和 C 的交互，Part 二) &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/16/play-homekit-with-ios-10-and-raspberry-pi/">折腾 Raspberry Pi + HomeKit 手记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/28/a-glimpse-of-swift-3-dot-0/">Swift 3.0 尝试——从入门到再学一门(a Glimpse of Swift 3.0)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/22/rust-pattern-match/">Rust Pattern Match(Rust中的模式匹配)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/18/guangzhou-realtime-bus/">广州实时工具App逆向</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/09/swift-2-dot-0-error-handling/">Swift 2.0 的错误处理(Swift 2.0 Error Handling)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/01/beijing-realtime-bus/">北京实时公交分析</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/23/swift-3rd-library-install-as-swift-modules/">为第三方扩展创建 Swift 模块</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/08/swift-beta3-changes/">Swift Beta3 Changes ( Swift 在 Beta3 中的变化）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/07/use-swift-dynamic-library/">Use Swift Dynamic Framework （如何科学地引用第三方 Swift 库)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/04/swift-undocumented-grammar/">Swift Undocumented Grammar （Swift 黑语法）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/04/cocoa-in-swift/">Cocoa Extensions in Swift ( Cocoa 在 Swift 中所添加的扩展）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/30/swift-type-hierarchy/">Swift Type Hierarchy ( Swift 类型层次结构 ）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/30/my-view-of-swift/">My View of Swift （闲扯对 Swift 语言的看法）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/28/swift-interop-with-c-slash-objc/">Swift Interop With C/ObjC Part 3 (Swift 与 ObjC 和 C 的交互，第三部分）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/25/tilde-arrow-in-swift/">Tilde Arrow in Swift （Swift 标准库中的波浪箭头 ~> ）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/25/write-swift-module-with-swift-cont/">Write Swift Module Cont. Static Library （使用 Swift 创建 Swift 模块 - 静态链接库）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/23/use-cocoapods-with-swift/">Use CocoaPods With Swift (在 Swift 中使用 CocoaPods）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/20/swift-reflection/">Swift Reflection （Swift 的反射）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/19/modules-for-swift/">Module System of Swift (简析 Swift 的模块系统)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/18/swift-and-c-interop-cont/">Swift and C Interop Cont. (简析 Swift 和 C 的交互，Part 二)</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/andelf">@andelf</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'andelf',
            count: 2,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+WangMaomao?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - 猫·仁波切 (Feather) -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'andelf';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://andelf.github.io/blog/2014/06/17/nsobject-pattern-match-in-swift/';
        var disqus_url = 'http://andelf.github.io/blog/2014/06/17/nsobject-pattern-match-in-swift/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
